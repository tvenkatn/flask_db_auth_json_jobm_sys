# Vulnerability validation tool
The document is [here](N:/APPLICS/EngTools/R_packages/MDValidation/Vulnerability/Vulnerability_ToolRequirement.docx)


> Date run:  2018-05-23 14:36:18


> Vuln database: RMS_VULN_JPEQHD_v17b	 (ca1mdtools01)



This tool tests the integrity of Vulncache\Vulnerability database and verifies that the data is properly transferred between RL tables and HD tables

#### Test-0: Database Information 
Check if database includes  both RiskLink and HD Tables or only includes RiskLink Tables


```
		List of countries:JP
		List of perils:EQ
		Database includes risklink tables.
		Database includes HD tables.
```

The Countries in this database are jp .


#### Test-0.1: Use "CS" instead of "TO" Tables. (Only for TO) https://jira.rms.com/browse/MDF-87

```
         PASS! Database Does Not Contain 'TO' Peril
```

#### Test-1: Tables Availability 
Tests if all tables listed in "VulnDb_ExpectedTables.csv" file located in data folder are included in the input database.

```
          Check risklink tables: 
          WARNING! 
         eqvlifjp
         eqvlljp

          Check HD tables: 
         vll
         LandMDR
         LiqMDR
         vinvaghaz
         vlif
```

#### Test-2: Empty Tables
Check for empty tables 

```
          Check risklink tables: 
          WARNING! 
         eqvmodjp
         eqvpdcdscjp
         eqvuwtjp
         eqvyrjp

          CHECK NG TABLES: 
         WARNING!
         vvrggeo
```

#### Test-3: Risklink Tables Without Index
Check for indexing only in RL tables. HD tables will be eventually converted to binaries.

```

EQ-JP:
         WARNING!
         eqvbijp
         eqvbimodjp
         eqvgeojp
         eqvinvjp
```

#### Test-4: Comparison of Number of Rows in corresponding RL/ HD tables (HD Only)
This test compares the number of rows in each RislLink Table with its corresponding table in the HD and reports any dissimilarity.

```
         WARNING!
          NG            RL
1:        NA            NA
2:       vll       eqvlljp
3:      vgeo      eqvgeojp
4: vinvaghaz eqvinvaghazjp
5:      vlif      eqvlifjp
```

#### Test-5: Consistency of Data within VGEO Table and Comparison Between RL And HD Versions of VGEO Table (HD Only)
1.  Checks and reports duplicate postal codes in vgeo table
2.  Checks and reports duplicate district numbers
3.  Checks for the number of distinct states in vgeo table
4.  Check if records with the same GEO_RECNUM have the same values in both RL and NG vgeo tables
5.  Checks if the last record in vgeo table is a wild card
6.  All admin geoids in a record cannot be zero except for the wild card. The test checks for this criteria and reports if the criteria is not satisfied. 


```

JP:
         PASS! No Duplicate Postalcodes!

-----------------------------------------------------------------------------------------------------------------
         Numberof Distinct Admin1Code (States) =47

-----------------------------------------------------------------------------------------------------------------
         Numberof Distinct Admin2Code (Counties) =1

-----------------------------------------------------------------------------------------------------------------
         FAIL! Number of rows with unmatched state or district fields =23
    NG-GeoRecnum RL-GeoRecnum NG-Admin1Code STATE Admin2Code COUNTYNUM
 1:        22369        22369            43    91         NA        NA
 2:        22370        22370            10    40         NA        NA
 3:        22372        22372            24    60         NA        NA
 4:        22375        22375            81    64         NA        NA
 5:        22377        22377            41    58         NA        NA
 6:        22378        22378            22    82         NA        NA
 7:        22380        22380             1    50         NA        NA
 8:        22381        22381            59    63         NA        NA
 9:        22383        22383            32    21         NA        NA
10:        22384        22384             3    72         NA        NA
11:        22386        22386            92    62         NA        NA
12:        22387        22387            26    31         NA        NA
13:        22389        22389            84    11         NA        NA
14:        22390        22390            57    71         NA        NA
15:        22373        22373            74    30         NA        NA
16:        22376        22376            12    93         NA        NA
17:        22379        22379            70    23         NA        NA
18:        22371        22371             2    83         NA        NA
19:        22374        22374            33    90         NA        NA
20:        22388        22388            80    61         NA        NA
21:        22391        22391            44    34         NA        NA
22:        22382        22382            20    42         NA        NA
23:        22385        22385            73    25         NA        NA
    NG-GeoRecnum RL-GeoRecnum NG-Admin1Code STATE Admin2Code COUNTYNUM

-----------------------------------------------------------------------------------------------------------------
         PASS! VGEO TABLE INCLUDES THE WILD CARD and it is the last record
-----------------------------------------------------------------------------------------------------------------
         PASS! No row contaons all Admin Geoids equal to zero except the wild card.
-----------------------------------------------------------------------------------------------------------------
```

#### Test-6: Comparison Between RL and HD Versions of CGHS table (HD Only)
1.  Checks if the records with same cghs_ID, have equivalent Hazard_Type, Hazard_Scale, and Coverage. It uses the mapping tables to find the equivalent values. It reports any dissimilarity between two tables.
2.  Checks if all CVG_GRADEs include only 0 or all values between 0 and 4.


```

EQ-JP:
         PASS! ALL RECORDS WITH THE SAME CGHS_ID MATCHED BETWEEN TWO TABLES!
         Check for NG Tables:
         PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in CGHS TABLE
         PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE

-----------------------------------------------------------------------------------------------------------------

JP:
         PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in eqcghsjp  TABLE
         PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE

-----------------------------------------------------------------------------------------------------------------
```

#### Test-7: Comparison Between RL and HD Versions of IMAP table (HD Only)
Compares equivalent records between RL and HD versions of Imap table and reports dissimilarities. 
This test uses INV_Recnum as the key for comparison. 

```

EQ-JP:
         PASS! ALL RECORDS WITH THE SAME INV_RECNUM MATCHED BETWEEN TWO TABLES!
```


#### Test-8: Comparison Between RL and HD Versions of VINV Table (HD Only)
Compares equivalent records between RL and NG versions of vinv table and reports dissimilarities. 

```

EQ-JP:
         PASS! ALL RECORDS WITH THE SAME INV_RECNUM, PDC_GROUP,and PDC_NUM MATCHED BETWEEN TWO TABLES!
```

#### Test-9: Test VDC0 Table
1. Check if all damage curves are monotonically increasing
2. Check if the x-axis on all damage curves are monotonically increasing
3. Check if curves with the same CGHS_ID have the same number or records


```

CHECK RISKLINK TABLES: 

EQ-JP:
         PASS! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!


CHECK NG TABLES: 
         PASS! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!
         PASS! X-AXES ON ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!
         PASS! ALL CURVES WITH THE SAME CGHS-ID HAVE THE SAME NUMBER OF RECORDS!
```


#### Test-10: Comparison Between RL and HD Versions of VCC Table (HD Only)
Compares equivalent records between RL and HD versions of vcc table and reports dissimilarities. 

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```

#### Test-11: Comparison Between RL and HD Versions of VOCC Table (HD Only)
Compares equivalent records between RL and HD versions of vocc table and reports dissimilarities. 

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```


#### Test-12: Test Existence of Pdc_Num In VINV if the Same Modif_Pdc Exists in IMAP For A Given Inv_Recnum (HD Only)
This test checks if for any combination of inv_recnum and modif_pdc in imap table there exist a record in vinv table with the same inv_recnum and pdc_num.

```

JP:
         PASS! ALL RECORDS MATCHED!
```


#### Test-13: Test for Case Sensitivity in Map_Invocc and Map_Invkey Tables
This test identifies repeated keys in Map_InvOcc and Map_InvKey tables. That can happen if key values are recorded in different capital and lowercase letters. As an example "unknown" and "UnKnown."

```
         PASS! NO CASE SENSITIVITY PROBLEM IS FOUND!
```


#### Test-14: Consistency of Data Between VCC and IMAP Tables


```

EQ-JP:
         Warning! Number of records that have not an exact match of combination of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3: 3
         Examples are as follows:
   CC_RECNUM MAPCCLSSIF MAPCCTIER1 MAPCCTIER2 MAPCCTIER3
1:       131        RMS         52         NA         NA
2:       135         BR          0         NA         NA
3:      1000  RMSCGSPEC          0         NA         NA

         Warning! Number of VCC records that have not an exact match but falling back to a record in IMAP which is not wild card: 3
  CC_RECNUM MAPCCLSSIF MAPCCTIER1 MAPCCTIER2 MAPCCTIER3
1       131        RMS         52         NA         NA
2       135         BR          0         NA         NA
3      1000  RMSCGSPEC          0         NA         NA

         Pass! All records of VCC tables have either exact match in IMAP or are falling back to a record.
```

#### Test-15: Consistency of Data Between VOCC and IMAP Tables
This test checks if all INV_OCC values in VOCC table exist in IMAP.

```

EQ-JP:
         FAIL! Number of unmatched records= 1
         Difference(s) between the vocc and imap include following INV_OCC(s):
         UNK
```

#### Test-16: Consistency of Data Between VGEO and IMAP Tables
This test checks if all INV_KEY values in VGEO table exist in IMAP.

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```


#### Test-17: Integrity of IMAP with VCC, VOCC, VGEO, Using PDC list received from modelers. (NAEQ17 Only) 



#### Test-18: All CV Keys in IMAP Should Exist in VCV Table
This test checks if the list of distinct values of CV_KEY in IMAP table is the same as the list of distinct values of CV_KEY in VCV table. 


```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```

#### Test-19: Consistency of Data Between Fliinv and Vcc, Vocc, Vgeo Tables

1.  This test checks if the list of distinct values of FFEQ_OCC in VOCC table is the same as the list of distinct values of FFEQ_OCC filed in FLIINV tables. 
2.  Check case sensitivity of FFEQ_OCC in FLIINV and VOCC tables. Any repeated value with the same spelling but different capital or lower-case letters is identified in this test.
3.  Checks if all distinct values of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3 are the same between FLIINV and VCC tables.
4.  Checks if all distinct values of INV_KEY are the same in both FLIINV and VGEO tables.


```

EQ-JP:
         Does not have FF peril!
```

#### Test-20: All Secondary Modifiers Should Have Options

```

EQ-JP:
         PASS! ALL Modif PDCs have options.
```

#### Test-21: All DC_Keys in VHAZ should exist in VGEO table
This test checks if the list of distinct values of DC_KEY in VHAZ table is the same as the list of distinct values of DC _KEY in VGEO table. 

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```


#### Test-22: Consistency of BI_Key between Vgeo and other BI-Related Tables


```

EQ-JP:
[1] "BI Related tables are :"
               name
 1:      eqcasvbijp
 2:         eqvbijp
 3:   eqcasvbimodjp
 4:      eqvbimodjp
 5:     eqvvrggeojp
 6:        eqvgeojp
 7:     eqcasvgeojp
 8: eqvlifelinebijp
 9:     eqcasvlifjp
10:      eqcasvlljp
         FAIL! Number of tables with different BI_KEYS= 4
         Distinct BI_KEYs in the following table(s) does not match distinct BI_KEYS in VGEO table:
         eqcasvbimodjp
         PASS! No CASE SENSITIVITY PROBLEM IN BI_KEYs IS FOUND!
```

#### Test-23: All INV_Recnums In IMAP Should Exist in VRS Table 
This test checks if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in VRS table. 

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```


#### Test-24: Test If Damage in VDC0 Table Are within Allowable Range


```

EQ-JP:
         PASS! MAXIMUM IN ALL RECORDS IS LESS THAN 100%!
         WARNING! Number of vdc0 curves with min number less than 1% = 1031
         A sample of records with min number less than 1%  :
         DC_KEY  PDC_NUM CGHS_ID Max_Damage
         2	          3072	          3	          0.47	
   HAZ_TYPE HAZ_SCALE Count
1:       SH        SD    66
2:       SH       MMI   965
```

#### Test-25: Vulnerability Alternative Curve Tests
1. Test Completeness of data
2. Test that vdc2<=vdc0<=vdc1

```

JP:
```


#### Test-26: Test Vlifelinebidc Table is Monotonically Increasing

```

CHECK RISKLINK TABLES: 

JP:


CHECK NG TABLES: 
         PASS! HAZARD AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!
         PASS! MDR AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!
```



#### Test-27: Minimum Value of MDR in CV Curves Should Start from Zero and Maximum Should be Above 100

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```

#### Test-28: Test to Ensures Count of Modifier Options for A Given Modifier In A Given Model Does Not Exceed The Allowable Maximum.

```

EQ-JP:
FAIL! Number of modif PDCs that have more than allowable options  = 3
   MODIF_NUM NumOfOptions PERIL MAXOPTIONCOUNT                  DESC
1:         7            4    EQ              3     Building Exterior
2:        16            4    EQ              3 Engineered Foundation
3:        25            4    EQ              3        Base Isolation
```


#### Test-29: Consistency of x_CLASSIF and x_CLASS values across all perils for each country

```

JP:

Country Perils are: 
[1] "eq"
         Database only includes one peril for this country.
```

#### Test-30: All codes in VGEO table should exist in NGGeography database

```

EQ-JP:
         CRESTA:
```

```
Error in if (!is.na(FieldLookup$CRESTA)) {: argument is of length zero
```

#### Test-31  Test if summation of def_invpct in inv table adds up to 100

```

EQ-JP:
         This INV_OCC(s) is/are not considered in this query: BR%
         PASS! summation of ALL def_invpct in vinv adds up to 100!
```


#### Test-32 Check if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in vinv table

```

EQ-JP:
         PASS! ALL RECORDS MATCHED!
```

#### Test-33 CONSISTENCY OF BI_OCC BETWEEN VOCC AND OTHER BI RELATED TABLES (KEY IS BI_OCC)

```

EQ-JP:
[1] "NOTE: BI_OCCs related to BR and MARINE are exempted in this test!"
[1] "BI Related tables are :"
              name
1:        eqvoccjp
2:         eqvbijp
3:      eqvbimodjp
4: eqvlifelinebijp
5:      eqvllbicjp
6:       eqvpbicjp

         eqvllbicjp: 
         Missing BI_OCC: 
         40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65

         eqvpbicjp: 
         Missing BI_OCC: 
         40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65

         FAIL! Number of tables with different BI_OCCs= 2
```

#### Test-34 Check all columns in all tables of database to ensure always (From) is smaller than or equal to (To)

```

EQ-JP:
         PASS! No records in eqcghsjp have FLOORAREA_FROM > FLOORAREA_TO
         PASS! No records in eqcghsjp have FLOOR_FROM > FLOOR_TO
         PASS! No records in eqvdsjp have FROM_DR > TO_DR
         PASS! No records in eqimapjp have HT_FROM > HT_TO
         PASS! No records in eqimapjp have YR_FROM > YR_TO
         PASS! No records in eqvbistructmodifjp have STRUCTMDR_RATIO_FROM > STRUCTMDR_RATIO_TO
         PASS! No records in eqvhsrjp have SEV_FROM > SEV_TO
         PASS! No records in eqfliinvjp have HT_FROM > HT_TO
         PASS! No records in eqfliinvjp have YR_FROM > YR_TO
```

#### Test-35 All BI_OCCs in vbi table should have SD based DSIDs in vds table.(KEY IS BI_OCC)

```

EQ-JP:
         PASS! ALL BI_OCC(s) HAVE SD-Based Damage State ID!
```

#### Test-36 Check for cases where YR_TO==9999 in the imap table. Jira MDF-114

```

EQ-JP:
         PASS! No imap record has yr_to = 9999!
```

#### Test-37.  Check Valid AggHaz_Occ list for RL climate models(HU,CS and WT) Jira MDF-101

```
         PASS! This test only applies to climate models.
```


#### Test-38.  BI_CV curve should monotonically decrease with increase in MDR. Jira https://jira.rms.com/browse/MDF-120

```

EQ-JP:
         PASS! ALL BI_CV CURVES ARE MONOTONICALLY decreasing!
```


