# Vulnerability validation tool
The document is [here](N:/APPLICS/EngTools/R_packages/MDValidation/Vulnerability/Vulnerability_ToolRequirement.docx)


> Date run:  2018-05-22 14:51:45


> Vuln database: RMS_VULN_NAEQ_RL9_NG	 (ca-md1-02)



This tool tests the integrity of Vulncache\Vulnerability database and verifies that the data is properly transferred between RL tables and HD tables

#### Test-0: Database Information 
Check if database includes  both RiskLink and HD Tables or only includes RiskLink Tables


```
		List of countries:US
		List of perils:EQ
		Database includes risklink tables.
		Database includes HD tables.
```

The Countries in this database are us .


#### Test-0.1: Use "CS" instead of "TO" Tables. (Only for TO) https://jira.rms.com/browse/MDF-87

```
         PASS! Database Does Not Contain 'TO' Peril
```

#### Test-1: Tables Availability 
Tests if all tables listed in "VulnDb_ExpectedTables.csv" file located in data folder are included in the input database.

```
          Check risklink tables: 
          WARNING! 
         eqvdc1us
         eqvdc2us

          Check HD tables: 
         LandMDR
         LiqMDR
         vlifelinebi
         vlifelinebidc
```

#### Test-2: Empty Tables
Check for empty tables 

```
          Check risklink tables: 
          WARNING! 
         eqvmodus
         eqvpdcdscus
         eqvuwtus
         eqvyrus

          CHECK NG TABLES: 
         WARNING!
         vbrdr
         vbrtv
         vvrggeo
```

#### Test-3: Risklink Tables Without Index
Check for indexing only in RL tables. HD tables will be eventually converted to binaries.

```

EQ-US:
         WARNING!
         eqvdsus
         eqvhsrus
         eqvlifus
         eqvllus
```

#### Test-4: Comparison of Number of Rows in corresponding RL/ HD tables (HD Only)
This test compares the number of rows in each RislLink Table with its corresponding table in the HD and reports any dissimilarity.

```
         WARNING!
              NG                RL
1:            NA                NA
2:   vlifelinebi   eqvlifelinebius
3: vlifelinebidc eqvlifelinebidcus
```

#### Test-5: Consistency of Data within VGEO Table and Comparison Between RL And HD Versions of VGEO Table (HD Only)
1.  Checks and reports duplicate postal codes in vgeo table
2.  Checks and reports duplicate district numbers
3.  Checks for the number of distinct states in vgeo table
4.  Check if records with the same GEO_RECNUM have the same values in both RL and NG vgeo tables
5.  Checks if the last record in vgeo table is a wild card
6.  All admin geoids in a record cannot be zero except for the wild card. The test checks for this criteria and reports if the criteria is not satisfied. 


```

US:
         WARNING! Numberof Duplicate Postalcodes =7
         Dupicate Postal Codes Are:
         c(63673, 72395, 73960, 73949, 57724, 71749, 42223)
-----------------------------------------------------------------------------------------------------------------
         Numberof Distinct Admin1Code (States) =51

-----------------------------------------------------------------------------------------------------------------
         Numberof Distinct Admin2Code (Counties) =275
         Numberof Distinct Admin2Code based on NG-Geography =325
         WARNING! Difference(s) between the database and NGGeography include:
         6
                   20
                   28
                   36
                   78
                   102
         
-----------------------------------------------------------------------------------------------------------------
         PASS! ALL RECORDS WITH THE SAME GEORECNUM MATCHED BETWEEN TWO TABLES!

-----------------------------------------------------------------------------------------------------------------
         FAIL! VGEO TABLE DOES NOT INCLUDE THE WILD CARD
-----------------------------------------------------------------------------------------------------------------
         PASS! No row contaons all Admin Geoids equal to zero except the wild card.
-----------------------------------------------------------------------------------------------------------------
```

#### Test-6: Comparison Between RL and HD Versions of CGHS table (HD Only)
1.  Checks if the records with same cghs_ID, have equivalent Hazard_Type, Hazard_Scale, and Coverage. It uses the mapping tables to find the equivalent values. It reports any dissimilarity between two tables.
2.  Checks if all CVG_GRADEs include only 0 or all values between 0 and 4.


```

EQ-US:
         PASS! ALL RECORDS WITH THE SAME CGHS_ID MATCHED BETWEEN TWO TABLES!
         Check for NG Tables:
         PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in CGHS TABLE
         PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE

-----------------------------------------------------------------------------------------------------------------

US:
         PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in eqcghsus  TABLE
         PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE

-----------------------------------------------------------------------------------------------------------------
```

#### Test-7: Comparison Between RL and HD Versions of IMAP table (HD Only)
Compares equivalent records between RL and HD versions of Imap table and reports dissimilarities. 
This test uses INV_Recnum as the key for comparison. 

```

EQ-US:
         PASS! ALL RECORDS WITH THE SAME INV_RECNUM MATCHED BETWEEN TWO TABLES!
```


#### Test-8: Comparison Between RL and HD Versions of VINV Table (HD Only)
Compares equivalent records between RL and NG versions of vinv table and reports dissimilarities. 

```

EQ-US:
FAIL! Number of rows with unmatched records =13
    INV_RECNUM PDC_GROUP PDC_NUM INV_RECNUM.1 PDC_GROUP.1 PDC_NUM.1
 1:      13169         0     314        13169           0       314
 2:      62217         0     770        62217           0       770
 3:      62533         0     783        62533           0       783
 4:      64462         0    1745        64462           0      1745
 5:      66217         0    1764        66217           0      1764
 6:      66315         0    2230        66315           0      2230
 7:      66413         0    2418        66413           0      2418
 8:      66511         0    2794        66511           0      2794
 9:      87863         0    1731        87863           0      1731
10:      88379         0    1745        88379           0      1745
11:      88404         0    2219        88404           0      2219
12:      88429         0    2407        88429           0      2407
13:      88454         0    2783        88454           0      2783
```

#### Test-9: Test VDC0 Table
1. Check if all damage curves are monotonically increasing
2. Check if the x-axis on all damage curves are monotonically increasing
3. Check if curves with the same CGHS_ID have the same number or records


```

CHECK RISKLINK TABLES: 

EQ-US:
FAIL! Number of damage curves which are not motonically increasing=5516 out of 2519450
      PDC_NUM DC_KEY CGHS_ID
   1:      71  ZONE2       7
   2:      71  ZONE3       7
   3:      71  ZONE4       7
   4:      71  ZONE4      11
   5:      72  ZONE2       7
  ---                       
5512:    3718 ZONE2A       4
5513:    3718 ZONE2A       4
5514:    3718 ZONE2A       5
5515:    3718 ZONE2A       5
5516:    3718 ZONE2A       5


CHECK NG TABLES: 
FAIL! Number of damage curves which are not motonically increasing=6251
         PASS! X-AXES ON ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!
         PASS! ALL CURVES WITH THE SAME CGHS-ID HAVE THE SAME NUMBER OF RECORDS!
```


#### Test-10: Comparison Between RL and HD Versions of VCC Table (HD Only)
Compares equivalent records between RL and HD versions of vcc table and reports dissimilarities. 

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```

#### Test-11: Comparison Between RL and HD Versions of VOCC Table (HD Only)
Compares equivalent records between RL and HD versions of vocc table and reports dissimilarities. 

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```


#### Test-12: Test Existence of Pdc_Num In VINV if the Same Modif_Pdc Exists in IMAP For A Given Inv_Recnum (HD Only)
This test checks if for any combination of inv_recnum and modif_pdc in imap table there exist a record in vinv table with the same inv_recnum and pdc_num.

```

US:
         PASS! ALL RECORDS MATCHED!
```


#### Test-13: Test for Case Sensitivity in Map_Invocc and Map_Invkey Tables
This test identifies repeated keys in Map_InvOcc and Map_InvKey tables. That can happen if key values are recorded in different capital and lowercase letters. As an example "unknown" and "UnKnown."

```
         PASS! NO CASE SENSITIVITY PROBLEM IS FOUND!
```


#### Test-14: Consistency of Data Between VCC and IMAP Tables


```

EQ-US:
         Warning! Number of records that have not an exact match of combination of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3: 2
         Examples are as follows:
   CC_RECNUM MAPCCLSSIF MAPCCTIER1 MAPCCTIER2 MAPCCTIER3
1:       322        ATC         63         NA         NA
2:       330        ATC         72         NA         NA

         Fail! Number of VCC records that are falling back to the wild card: 2
  CC_RECNUM MAPCCLSSIF MAPCCTIER1 MAPCCTIER2 MAPCCTIER3
1       322        ATC         63         NA         NA
2       330        ATC         72         NA         NA
```

#### Test-15: Consistency of Data Between VOCC and IMAP Tables
This test checks if all INV_OCC values in VOCC table exist in IMAP.

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```

#### Test-16: Consistency of Data Between VGEO and IMAP Tables
This test checks if all INV_KEY values in VGEO table exist in IMAP.

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```


#### Test-17: Integrity of IMAP with VCC, VOCC, VGEO, Using PDC list received from modelers. (NAEQ17 Only) 


```

US:

EQ-US:
```

```
Error in paste0(db, "..", Perils[j], "cghs", Countries[i], collapse = ""): object 'db' not found
```

#### Test-18: All CV Keys in IMAP Should Exist in VCV Table
This test checks if the list of distinct values of CV_KEY in IMAP table is the same as the list of distinct values of CV_KEY in VCV table. 


```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```

#### Test-19: Consistency of Data Between Fliinv and Vcc, Vocc, Vgeo Tables

1.  This test checks if the list of distinct values of FFEQ_OCC in VOCC table is the same as the list of distinct values of FFEQ_OCC filed in FLIINV tables. 
2.  Check case sensitivity of FFEQ_OCC in FLIINV and VOCC tables. Any repeated value with the same spelling but different capital or lower-case letters is identified in this test.
3.  Checks if all distinct values of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3 are the same between FLIINV and VCC tables.
4.  Checks if all distinct values of INV_KEY are the same in both FLIINV and VGEO tables.


```

EQ-US:
         Does not have FF peril!
```

#### Test-20: All Secondary Modifiers Should Have Options

```

EQ-US:
         PASS! ALL Modif PDCs have options.
```

#### Test-21: All DC_Keys in VHAZ should exist in VGEO table
This test checks if the list of distinct values of DC_KEY in VHAZ table is the same as the list of distinct values of DC _KEY in VGEO table. 

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```


#### Test-22: Consistency of BI_Key between Vgeo and other BI-Related Tables


```

EQ-US:
[1] "BI Related tables are :"
          name
1: eqvvrggeous
2:    eqvgeous
3:     eqvbius
4:  eqvbimodus
5:     eqvllus
6:    eqvlifus
         FAIL! Number of tables with different BI_KEYS= 4
         Distinct BI_KEYs in the following table(s) does not match distinct BI_KEYS in VGEO table:
         eqvvrggeous
         PASS! No CASE SENSITIVITY PROBLEM IN BI_KEYs IS FOUND!
```

#### Test-23: All INV_Recnums In IMAP Should Exist in VRS Table 
This test checks if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in VRS table. 

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```


#### Test-24: Test If Damage in VDC0 Table Are within Allowable Range


```

EQ-US:
         PASS! MAXIMUM IN ALL RECORDS IS LESS THAN 100%!
         WARNING! Number of vdc0 curves with min number less than 1% = 7413
         A sample of records with min number less than 1%  :
         DC_KEY  PDC_NUM CGHS_ID Max_Damage
         6	          435	          2	          0	
   HAZ_TYPE HAZ_SCALE Count
1:       SH       MMI  5295
2:       SH        SD   780
3:       SL       MMI  1338
```

#### Test-25: Vulnerability Alternative Curve Tests
1. Test Completeness of data
2. Test that vdc2<=vdc0<=vdc1

```

US:
         FAIL! vdc0, vdc1, and vdc2 tables do not have the same number or records!
         Number of unmatched records: 2
         FAIL! for all curves the relation vdc2<=vdc0<=vdc1 is NOT satisfied!
         Number of unmatched records: 2
```


#### Test-26: Test Vlifelinebidc Table is Monotonically Increasing

```

CHECK RISKLINK TABLES: 

US:


CHECK NG TABLES: 
```

```
Error in eval(v, x, parent.frame()): object 'country' not found
```



#### Test-27: Minimum Value of MDR in CV Curves Should Start from Zero and Maximum Should be Above 100

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```

#### Test-28: Test to Ensures Count of Modifier Options for A Given Modifier In A Given Model Does Not Exceed The Allowable Maximum.

```

EQ-US:
         PASS! ALL Modif PDCs have less options than allowable number of options.
```


#### Test-29: Consistency of x_CLASSIF and x_CLASS values across all perils for each country

```

US:

Country Perils are: 
[1] "eq"
         Database only includes one peril for this country.
```

#### Test-30: All codes in VGEO table should exist in NGGeography database

```

EQ-US:
         CRESTA:
```

```
Error in if (!is.na(FieldLookup$CRESTA)) {: argument is of length zero
```

#### Test-31  Test if summation of def_invpct in inv table adds up to 100

```

EQ-US:
         This INV_OCC(s) is/are not considered in this query: BR%
         PASS! summation of ALL def_invpct in vinv adds up to 100!
```


#### Test-32 Check if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in vinv table

```

EQ-US:
         PASS! ALL RECORDS MATCHED!
```

#### Test-33 CONSISTENCY OF BI_OCC BETWEEN VOCC AND OTHER BI RELATED TABLES (KEY IS BI_OCC)

```

EQ-US:
[1] "NOTE: BI_OCCs related to BR and MARINE are exempted in this test!"
[1] "BI Related tables are :"
         name
1:    eqvbius
2: eqvbimodus
3:   eqvoccus
4:   eqvlifus
         PASS! BI_OCC IN ALL TBALES MATCHED!
```

#### Test-34 Check all columns in all tables of database to ensure always (From) is smaller than or equal to (To)

```

EQ-US:
         PASS! No records in eqcghsus have FLOORAREA_FROM > FLOORAREA_TO
         PASS! No records in eqcghsus have FLOOR_FROM > FLOOR_TO
         PASS! No records in eqfliinvus have HT_FROM > HT_TO
         PASS! No records in eqfliinvus have YR_FROM > YR_TO
         PASS! No records in eqvdsus have FROM_DR > TO_DR
         PASS! No records in eqimapus have HT_FROM > HT_TO
         PASS! No records in eqimapus have YR_FROM > YR_TO
         PASS! No records in eqvhsrus have SEV_FROM > SEV_TO
```

#### Test-35 All BI_OCCs in vbi table should have SD based DSIDs in vds table.(KEY IS BI_OCC)

```

EQ-US:
         FAIL! Number of BI_OCC(s) with no SD-based Damage state ID = 80
         0:79
```

#### Test-36 Check for cases where YR_TO==9999 in the imap table. Jira MDF-114

```

EQ-US:
         PASS! No imap record has yr_to = 9999!
```

#### Test-37.  Check Valid AggHaz_Occ list for RL climate models(HU,CS and WT) Jira MDF-101

```
         PASS! This test only applies to climate models.
```


#### Test-38.  BI_CV curve should monotonically decrease with increase in MDR. Jira https://jira.rms.com/browse/MDF-120

```

EQ-US:
```

```
Error in vecseq(f__, len__, if (allow.cartesian || notjoin || !anyDuplicated(f__, : Join results in 4088 rows; more than 2072 = nrow(x)+nrow(i). Check for duplicate key values in i each of which join to the same group in x over and over again. If that's ok, try by=.EACHI to run j for each group to avoid the large allocation. If you are sure you wish to proceed, rerun with allow.cartesian=TRUE. Otherwise, please search for this error message in the FAQ, Wiki, Stack Overflow and datatable-help for advice.
```


