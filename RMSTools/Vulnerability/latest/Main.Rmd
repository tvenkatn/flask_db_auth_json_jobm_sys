# Vulnerability validation tool
The document is [here](N:/APPLICS/EngTools/R_packages/MDValidation/Vulnerability/Vulnerability_ToolRequirement.docx)


> Date run:  `r Sys.time()`


> Vuln database: `r paste0(CFG$VULNDB,'\t (',CFG$DBserver,')')`

```{r setconn, echo=FALSE,comment=NA}
##Import the database
source(paste0(progdir,"/modules/createHandles.r"))
```

This tool tests the integrity of Vulncache\Vulnerability database and verifies that the data is properly transferred between RL tables and HD tables

#### Test-0: Database Information 
Check if database includes  both RiskLink and HD Tables or only includes RiskLink Tables

```{r test0,echo=FALSE,comment=NA}
source(paste0(progdir,"/modules/test0.r"))
source(paste0(progdir,"/modules/tests.r"))
#Perils="eqcas"
#Countries,perilcountry="us"

```

The Countries in this database are `r paste(CFG$Countries,collapse=",")` .


#### Test-0.1: Use "CS" instead of "TO" Tables. (Only for TO) https://jira.rms.com/browse/MDF-87
```{r Test0.1,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_0.1(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
Perils = Perils[Perils!='to']  
}
```

#### Test-1: Tables Availability 
Tests if all tables listed in "VulnDb_ExpectedTables.csv" file located in data folder are included in the input database.
```{r Test1,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
    Test_1(dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,listofNGtables, NGTableExist)
}
```

#### Test-2: Empty Tables
Check for empty tables 
```{r Test2,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
    Test_2(dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,listofNGtables, NGTableExist)
}
```

#### Test-3: Risklink Tables Without Index
Check for indexing only in RL tables. HD tables will be eventually converted to binaries.
```{r Test3,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
    Test_3(dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables)
}
```

#### Test-4: Comparison of Number of Rows in corresponding RL/ HD tables (HD Only)
This test compares the number of rows in each RislLink Table with its corresponding table in the HD and reports any dissimilarity.
```{r Test4,echo=FALSE,comment=NA}
if (NGTableExist){
    Test_4(dbHandle,reportCon,Perils,Countries,perilcountry,listofNGtables)
}
```

#### Test-5: Consistency of Data within VGEO Table and Comparison Between RL And HD Versions of VGEO Table (HD Only)
1.  Checks and reports duplicate postal codes in vgeo table
2.  Checks and reports duplicate district numbers
3.  Checks for the number of distinct states in vgeo table
4.  Check if records with the same GEO_RECNUM have the same values in both RL and NG vgeo tables
5.  Checks if the last record in vgeo table is a wild card
6.  All admin geoids in a record cannot be zero except for the wild card. The test checks for this criteria and reports if the criteria is not satisfied. 

```{r Test5,echo=FALSE,comment=NA}
if (NGTableExist){
    Test_5(dbHandle,dbHandle2,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-6: Comparison Between RL and HD Versions of CGHS table (HD Only)
1.  Checks if the records with same cghs_ID, have equivalent Hazard_Type, Hazard_Scale, and Coverage. It uses the mapping tables to find the equivalent values. It reports any dissimilarity between two tables.
2.  Checks if all CVG_GRADEs include only 0 or all values between 0 and 4.

```{r Test6,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
    Test_6(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables,NGTableExist)
}
```

#### Test-7: Comparison Between RL and HD Versions of IMAP table (HD Only)
Compares equivalent records between RL and HD versions of Imap table and reports dissimilarities. 
This test uses INV_Recnum as the key for comparison. 
```{r Test7,echo=FALSE,comment=NA}
if (NGTableExist){
    Test_7(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-8: Comparison Between RL and HD Versions of VINV Table (HD Only)
Compares equivalent records between RL and NG versions of vinv table and reports dissimilarities. 
```{r Test8,echo=FALSE,comment=NA}
if (NGTableExist){
Test_8(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-9: Test VDC0 Table
1. Check if all damage curves are monotonically increasing
2. Check if the x-axis on all damage curves are monotonically increasing
3. Check if curves with the same CGHS_ID have the same number or records

```{r Test9,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_9(dbHandle,reportCon,Perils,Countries,tables,perilcountry,VulnDb_ExpectedTables,NGTableExist)
}
```


#### Test-10: Comparison Between RL and HD Versions of VCC Table (HD Only)
Compares equivalent records between RL and HD versions of vcc table and reports dissimilarities. 
```{r Test10,echo=FALSE,comment=NA}
if (NGTableExist){
Test_10(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-11: Comparison Between RL and HD Versions of VOCC Table (HD Only)
Compares equivalent records between RL and HD versions of vocc table and reports dissimilarities. 
```{r Test11,echo=FALSE,comment=NA}
if (NGTableExist){
Test_11(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-12: Test Existence of Pdc_Num In VINV if the Same Modif_Pdc Exists in IMAP For A Given Inv_Recnum (HD Only)
This test checks if for any combination of inv_recnum and modif_pdc in imap table there exist a record in vinv table with the same inv_recnum and pdc_num.
```{r Test12,echo=FALSE,comment=NA}
if (NGTableExist){
Test_12(dbHandle,reportCon,Perils,Countries,perilcountry)
}
```


#### Test-13: Test for Case Sensitivity in Map_Invocc and Map_Invkey Tables
This test identifies repeated keys in Map_InvOcc and Map_InvKey tables. That can happen if key values are recorded in different capital and lowercase letters. As an example "unknown" and "UnKnown."
```{r Test13,echo=FALSE,comment=NA}
if (NGTableExist){
Test_13(dbHandle,reportCon)
}
```


#### Test-14: Consistency of Data Between VCC and IMAP Tables

```{r Test14,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_14(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-15: Consistency of Data Between VOCC and IMAP Tables
This test checks if all INV_OCC values in VOCC table exist in IMAP.
```{r Test15,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_15(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-16: Consistency of Data Between VGEO and IMAP Tables
This test checks if all INV_KEY values in VGEO table exist in IMAP.
```{r Test16,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_16(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-17: Integrity of IMAP with VCC, VOCC, VGEO, Using PDC list received from modelers. (NAEQ17 Only) 

```{r Test17,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_17(dbHandle3,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables,db,cwd)
}
```

#### Test-18: All CV Keys in IMAP Should Exist in VCV Table
This test checks if the list of distinct values of CV_KEY in IMAP table is the same as the list of distinct values of CV_KEY in VCV table. 

```{r Test18,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_18(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-19: Consistency of Data Between Fliinv and Vcc, Vocc, Vgeo Tables

1.  This test checks if the list of distinct values of FFEQ_OCC in VOCC table is the same as the list of distinct values of FFEQ_OCC filed in FLIINV tables. 
2.  Check case sensitivity of FFEQ_OCC in FLIINV and VOCC tables. Any repeated value with the same spelling but different capital or lower-case letters is identified in this test.
3.  Checks if all distinct values of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3 are the same between FLIINV and VCC tables.
4.  Checks if all distinct values of INV_KEY are the same in both FLIINV and VGEO tables.

```{r Test19,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_19(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-20: All Secondary Modifiers Should Have Options
```{r Test20,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_20(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-21: All DC_Keys in VHAZ should exist in VGEO table
This test checks if the list of distinct values of DC_KEY in VHAZ table is the same as the list of distinct values of DC _KEY in VGEO table. 
```{r Test21,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_21(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-22: Consistency of BI_Key between Vgeo and other BI-Related Tables

```{r Test22,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_22(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-23: All INV_Recnums In IMAP Should Exist in VRS Table 
This test checks if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in VRS table. 
```{r Test23,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_23(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-24: Test If Damage in VDC0 Table Are within Allowable Range

```{r Test24,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_24(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-25: Vulnerability Alternative Curve Tests
1. Test Completeness of data
2. Test that vdc2<=vdc0<=vdc1
```{r Test25,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_25(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-26: Test Vlifelinebidc Table is Monotonically Increasing
```{r Test26,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_26(dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,NGTableExist)
}
```



#### Test-27: Minimum Value of MDR in CV Curves Should Start from Zero and Maximum Should be Above 100
```{r Test27,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_27(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-28: Test to Ensures Count of Modifier Options for A Given Modifier In A Given Model Does Not Exceed The Allowable Maximum.
```{r Test28,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_28(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-29: Consistency of x_CLASSIF and x_CLASS values across all perils for each country
```{r Test29,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_29(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-30: All codes in VGEO table should exist in NGGeography database
```{r Test30,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_30(dbHandle,dbHandle2,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-31  Test if summation of def_invpct in inv table adds up to 100
```{r Test31,echo=FALSE,comment=NA}
if (NGTableExist){
Test_31(dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```


#### Test-32 Check if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in vinv table
```{r Test32,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_32 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-33 CONSISTENCY OF BI_OCC BETWEEN VOCC AND OTHER BI RELATED TABLES (KEY IS BI_OCC)
```{r Test33,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_33 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-34 Check all columns in all tables of database to ensure always (From) is smaller than or equal to (To)
```{r Test34,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_34 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-35 All BI_OCCs in vbi table should have SD based DSIDs in vds table.(KEY IS BI_OCC)
```{r Test35,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_35 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-36 Check for cases where YR_TO==9999 in the imap table. Jira MDF-114
```{r Test36,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_36 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

#### Test-37.  Check Valid AggHaz_Occ list for RL climate models(HU,CS and WT) Jira MDF-101
```{r Test37,echo=FALSE,comment=NA}
if (RiskLinkTableExist){
Test_37 (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables)
}
```

```{r,echo=FALSE}







# ##############END#################




odbcClose(dbHandle)
# closeAllConnections() # it closes the connection to the file so it writes on the console.


# ### Test

```
