#Developed by Mohammad Razavi June-2016


#rm(list=ls())
cat("\014")
cat("\n")
c=Sys.time()


cwd <- getwd()

## GO TO TOP STATEMENT
#<h2 id="top">TABLE OF CONTENTS:</h1>
# <a href="#top">Go to top</a>


# Read the html file
#htmlread = readLines(paste0(currdir,"/log/Main.html"),-1)
htmlread = readLines(paste0(currdir,"/log/Main.html"),-1)

#Find all recodes with h4- considering all titles are written in h4
headerindex=grep('<h4>',htmlread)


#htmlread[headerindex]
contents<- gsub("<h4>","" ,htmlread[headerindex])
contents<- gsub("</h4>","" ,contents)

## add index id to titles
j=1
for (i in headerindex) {
  htmlread[i]<-gsub("<h4>",paste0("<h4 id='",toString(j),"'>") ,htmlread[i])
  j=j+1}



## add go to top after each test
for (i in headerindex[-1]) {
  htmlread[i-1]<-paste0('<a href="#top">Go to top</a>')
  }
# After Last Test
htmlread[length(htmlread)-3]<-paste0('<a href="#top">Go to top</a>')



##Generate a new html file with timestamp
tStamp <- as.character(format(Sys.time(), "%Y%m%d_%Hh%Mm%Ss"))

if(file.exists(paste0("log/Report_",tStamp,".html"))){
  reportCon <- file(paste0("log/Report_",tStamp,".html"),open="a")
}else {
  reportCon <- file(paste0("log/Report_",tStamp,".html"),open="a")}


## Find and Color code the Pass, Warning, and Fail in the rep
indexPass=grep("pass!",tolower(htmlread))
htmlread[indexPass]<- gsub("pass!", '<b><font color="green">PASS!</font></b>',tolower(htmlread[indexPass]))


indexFail=grep("fail!",tolower(htmlread))
htmlread[indexFail]<- gsub("fail!", '<b><font color="red">FAIL!</font></b>',tolower(htmlread[indexFail]))

indexwarn=grep("warning!",tolower(htmlread))
htmlread[indexwarn]<- gsub("warning!", '<b><font color="orange">WARNING!</font></b>',tolower(htmlread[indexwarn]))


## find tests with warning, Pass, and Fails so we can color code the table of contents

Contentscolor=c()

Contentscolor[1]='black'
for (i in 2: (length(headerindex))){
  if(i==length(headerindex)){endindex=length(htmlread)} else {endindex=headerindex[i+1]}
  indexPass=grep("pass",tolower(htmlread[headerindex[i]:endindex]))
  if (length(indexPass)!=0){Contentscolor[i]='green'}
  indexwarn=grep("warning",tolower(htmlread[headerindex[i]:endindex]))
  if (length(indexwarn)!=0){Contentscolor[i]='orange'}
  indexFail=grep("fail",tolower(htmlread[headerindex[i]:endindex]))
  if (length(indexFail)!=0){Contentscolor[i]='red'}
}


## Create the Table of Contents
Tableofcontent=paste0('
<nav role="navigation" class="table-of-contents">
<h3 id="top">TABLE OF CONTENTS:</h1>
<ul>
')

for (i in 1: length(contents)){
Tableofcontent=paste0(Tableofcontent,'<li><a href="#',toString(i),'">','<font color="',Contentscolor[i],'">',contents[i],"</font></a></li>"," ")
}

Tableofcontent=paste0(Tableofcontent,'</ul>
</nav>')


## Write the new html file
cat(paste0(htmlread[1:headerindex[1]-1],"\n"), file = reportCon, append = TRUE)
cat(paste0(Tableofcontent,"\n"), file = reportCon, append = TRUE)
cat(paste0(htmlread[headerindex[1]:length(htmlread)],"\n"), file = reportCon, append = TRUE)


## Close the file
close(reportCon)
