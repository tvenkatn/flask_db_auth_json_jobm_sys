
###TEST-0.1: Use CS instead of TO Tables. (Only for TO) https://jira.rms.com/browse/MDF-87
Test_0.1<- function (dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,listofNGtables,NGTableExist) {
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  if ("to" %in% Perils)
  { 
    if ("cs" %in% Perils){
  for (i in 1:nCountries) {
  {
    
            currentPerilCountry=paste0("to",Countries[i])
        if (currentPerilCountry %in% perilcountry) {
          cat(paste0("\n",toupper("to"),"-",toupper(Countries[i]),":","\n"))
          dummyname=paste0("'",Countries[i],"'",collapse="")
          # Tables to be compared MDSC, ODSC, VCC and VOCC
          tomdsccc = paste0("tomdsc",Countries[i],collapse="")
          csmdsccc = paste0("csmdsc",Countries[i],collapse="")
          
          toodsccc = paste0("toodsc",Countries[i],collapse="")
          csodsccc = paste0("csodsc",Countries[i],collapse="")
          
          tovcccc = paste0("tovcc",Countries[i],collapse="")
          csvcccc = paste0("csvcc",Countries[i],collapse="")
          
          tovocccc = paste0("tovocc",Countries[i],collapse="")
          csvocccc = paste0("csvocc",Countries[i],collapse="")
          
          ToTables <- c(tomdsccc, toodsccc, tovcccc, tovocccc )
          CsTables <- c(csmdsccc, csodsccc, csvcccc, csvocccc )
          
          for ( j in seq(1,4)){
          
              dif = data.table(sqlQuery(dbHandle,paste0(" (   SELECT * FROM  ", ToTables[j], " 
                                                                  EXCEPT
                                                                  SELECT * FROM ", CsTables[j], ")  
                                                              UNION ALL
                                                              (   SELECT * FROM ", CsTables[j], "
                                                                  EXCEPT
                                                                  SELECT * FROM ", ToTables[j], ")" )))
              
              
              ndif=nrow(dif)
              if (ndif!=0){
                cat(paste0("         ", "Warning! ",ToTables[j], " is does not match ", CsTables[j]  ,"\n"))
                print(dif)
              } else { cat(paste0("         ","PASS! ALL RECORDS MATCH BETWEEN ",ToTables[j], "  and ", CsTables[j]," TABLES!","\n"))  }
          }
        }
      
  }

      
  }
  Perils = Perils[Perils!='to']  
  } else {cat( paste0("         ", "Fail! Database Has 'TO' Peril but does not have 'CS' Peril"))}
      } else {cat( paste0("         ", "PASS! Database Does Not Contain 'TO' Peril"))}
  }


###TEST-1: TABLES AVAILABILITY
##### Check if all required tables are included in the database
Test_1<- function (dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,listofNGtables,NGTableExist) {
 
  
  # check if all needed tables  exist in the imported database  
  
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  nmissingtable=0
  
  cat("         ","Check risklink tables:","\n")
  for (i in 1:nCountries){
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        for (k in 1:length(Tables_Required)){
          if (tolower(Tables_Required[k]) %in% tolower(tables$TABLE_NAME)){
            
          } else {
            nmissingtable=nmissingtable+1
            if (nmissingtable==1){cat("         ",'WARNING!',"\n")}
            cat(paste0("         ",Tables_Required[k],'\n')) 
          }
        }
      }
      
      
      
      
    }
    
    
  }
  
  
  if (nmissingtable==0) {
    cat(paste0("         ","PASS! All required risklink tables are available.",'\n')) 
  }
  
  
  
  if (NGTableExist){
  cat('\n')  
  cat("         ","Check HD tables:","\n")
    nNGmissing=0
    nNGtables=length(listofNGtables)
    for (i in 1:nNGtables){
      if (tolower(listofNGtables[i]) %in% tables$TABLE_NAME){
        
      } else {
        nNGmissing=nNGmissing+1
        if (nmissingtable==1){cat("         ",'WARNING!',"\n")}
        cat(paste0("         ",listofNGtables[i],'\n')) 
      }
      
    }
    
    if (nNGmissing==0) {
      cat(paste0("         ","PASS! All required HD tables are available.")) 
    }
    
  }
}

###TEST-2: EMPTY TABLES
# Check if any of imported tables are empty:
Test_2 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,listofNGtables,NGTableExist){

  nEmptyTable=0
  
  
  nPerils=length(Perils)
  nCountries=length(Countries)

  cat("         ","Check risklink tables:","\n")
  
  for (i in 1:nCountries){
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      for (k in 1:length(Tables_Required)){
        dummycount=sqlQuery(dbHandle, paste0("Select count(*) from ",Tables_Required[k]))
        if (any(dummycount==0)){
          nEmptyTable=nEmptyTable+1
          if (nEmptyTable==1){cat("         ","WARNING!","\n")}
          cat(paste0("         ",Tables_Required[k],'\n'))
        }
        
      }
    }
    
  }
  
  if (nEmptyTable==0) {cat(paste0("         ","PASS! THERE IS NO EMPTY RISKLINK TABLE!")) }
  
  
  if (NGTableExist){
cat("\n")
    cat("         ","CHECK NG TABLES:","\n")
    nEmptyTable=0
    nNGtables=length(listofNGtables)
    for (i in 1:nNGtables){
      dummycount=sqlQuery(dbHandle, paste0("Select count(*) from ",listofNGtables[i]))
      if (any(dummycount==0)){
        nEmptyTable=nEmptyTable+1
        if (nEmptyTable==1){cat(paste0("         ","WARNING!","\n"))}
        cat(paste0("         ",listofNGtables[i],'\n'))
      } 
      
    }
    
    if (nEmptyTable==0) {
      cat(paste0("         ","PASS! THERE IS NO EMPTY NG TABLE!")) 
    }
    
  }
  
  
  
  
  
}

###TEST-3: Risk Link TABLES without Index
Test_3 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables){

  
  nmissingindex=0
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    for (j in 1:nPerils)
    {
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        {       
          cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        
        for (k in 1:length(Tables_Required)) { 

        dummyname=paste0("'",Tables_Required[k],"'",collapse="")
        dummytable = data.table(sqlQuery(dbHandle,paste0("SELECT name FROM sys.tables WHERE OBJECTPROPERTY(object_id,'IsIndexed') = 0 and name=",dummyname)))
        nonindex=nrow(dummytable)
        if (nonindex==1)
        {
          nmissingindex=nmissingindex+1
          if (nmissingindex==1){cat(paste0("         ","WARNING!","\n"))}
          cat(paste0("         ",Tables_Required[k],'\n')) 
        }}      
      }
      
    }
  }
  
  
  if (nmissingindex==0) {cat(paste0("         ","PASS! ALL RISKLINK TABLES ARE INDEXED!")) }
  
  
}}

###TEST-4: COMPARISON OF NUMBER OF ROWS IN CORRESPONDING TABLES
# Compare number of rows in various tables :
Test_4 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,listofNGtables) {
  

  nNotEqualRow=0
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  Collector=data.table(NG=NA,RL=NA)
  for (i in 1:nCountries)
  {
    for (j in 1:nPerils)
    {
      nNGRow=0
      nRiskLinkRow=0
      for (k in 1:length(listofNGtables))
      {
        dummyname=paste0(Perils[j],listofNGtables[k],Countries[i],collapse="")
        dummyCountryName=paste0("'",Countries[i],"'",collapse="")
        nRiskLinkRow =sqlQuery(dbHandle,paste0("SELECT COUNT(*) FROM ", dummyname))
        nNGRow = sqlQuery(dbHandle,paste0("SELECT COUNT(*) FROM ", listofNGtables[k], " WHERE country=",dummyCountryName))
        
      
      if (any(nRiskLinkRow!=nNGRow))
      {
        nNotEqualRow=nNotEqualRow+1
        if (nNotEqualRow==1){cat(paste0("         ","WARNING!","\n"))}
        #cat(paste0("         ",listofNGtables[k],'\t','\t','\t',dummyname, '\n')) 
        Dummy=data.table(NG=listofNGtables[k],RL=dummyname)
        Collector=rbind(Collector,Dummy)
      }      
      }
      
    }
  }
  
  
  if (nNotEqualRow==0) {cat(paste0("         ","PASS! NUMBER OR ROWS IN ALL CORRESPONDING TABLES MATCHES!")) } else {
    print(Collector)
  }
}

#### TEST-5:TEST VGEO AND EQVGEO TABLES
#### Check vgeo and eqvgeo tables 
Test_5 <- function (dbHandle,dbHandle2,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){


  # Check for duplicates in postal codes
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  i=1
  for (i in 1:nCountries)
  {
    dummyname=paste0("'",Countries[i],"'",collapse="")
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    
    vgeo_duplicates = data.table(sqlQuery(dbHandle, paste0("SELECT
                                                           POSTALCODE, COUNT(*)
                                                           FROM
                                                           vgeo
                                                           WHERE
                                                           POSTALCODE IS NOT NULL
                                                           and 
                                                           country=",dummyname,"
                                                           GROUP BY
                                                           POSTALCODE 
                                                           HAVING 
                                                           COUNT(*) > 1
                                                           ")))
    
    nvgeo_duplicate=nrow(vgeo_duplicates)
    
    if (nvgeo_duplicate!=0){
      cat(paste0("         ","WARNING! Numberof Duplicate Postalcodes =",nvgeo_duplicate,"\n"))
      cat(paste0("         ","Dupicate Postal Codes Are:","\n"))
      cat(paste0("         ",vgeo_duplicates[,1,with=FALSE]))
    } else {cat(paste0("         ","PASS! No Duplicate Postalcodes!","\n"))}
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    
    # check for number of distinct states 
    nvgeo_admin1=data.table(sqlQuery(dbHandle, paste0("select distinct Admin1Code as state from vgeo where admin1code is not null and country=",dummyname)))
    cat(paste0("         ","Numberof Distinct Admin1Code (States) =",nrow(nvgeo_admin1),"\n"))
    nNGGeog_admin1=data.table(sqlQuery(dbHandle2, paste0("SELECT  distinct CODE as state FROM [RMS_NGGeography].[dbo].[a1geolookup] where FIPS=",dummyname)))
    Admin1Diff<- nNGGeog_admin1[!(state %in% nvgeo_admin1$state)]

    if (nrow(Admin1Diff)!=0){
      cat(paste0("         ","Numberof Distinct Admin1Code based on NG-Geography =",nrow(nNGGeog_admin1),"\n"))
	  cat(paste0("         ","WARNING! Differnece(s) between the database and NGGeography include:","         ",head(Admin1Diff$state),"\n","         "))
      
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    
    
    # check for number of distinct counties 
    nvgeo_admin2=data.table(sqlQuery(dbHandle, paste0("select distinct Admin2Code as state from vgeo where admin1code is not null and country=",dummyname)))
    cat(paste0("         ","Numberof Distinct Admin2Code (Counties) =",nrow(nvgeo_admin2),"\n"))
    nNGGeog_admin2=data.table(sqlQuery(dbHandle2, paste0("SELECT  distinct CODE as state FROM [RMS_NGGeography].[dbo].[a2geolookup] where FIPS=",dummyname)))
    Admin2Diff<- nNGGeog_admin2[!(state %in% nvgeo_admin2$state)]
    #if (nrow(nNGGeog_admin1)!=nrow(nvgeo_admin1)){
    if (nrow(Admin2Diff)!=0){
      cat(paste0("         ","Numberof Distinct Admin2Code based on NG-Geography =",nrow(nNGGeog_admin2),"\n"))
      cat(paste0("         ","WARNING! Difference(s) between the database and NGGeography include:","\n"))
      cat(paste0("         ",head(Admin2Diff$state),"\n","         "))
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    #Check if records with the same GEO_RECNUM have the same values in vgeo and eqvgeous tables
    #Check records with postal code
    
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      if (length(Tables_Required)!=0) {
        
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
        
        vgeo_Postal_dif = data.table(sqlQuery(dbHandle,paste0("SELECT vgeo.GEO_RECNUM, ", ppvgeocc,".GEO_RECNUM, vgeo.POSTALCODE,", ppvgeocc,".POSTALCODE,vgeo.Admin1Code,", ppvgeocc,".STATE,vgeo.Admin2Code,", ppvgeocc,".COUNTYNUM
                                                              FROM vgeo 
                                                              INNER JOIN ", ppvgeocc," ON vgeo.country=",dummyname," and vgeo.GEO_RECNUM = ", ppvgeocc,".GEO_RECNUM and (vgeo.POSTALCODE!=", ppvgeocc,".POSTALCODE and (vgeo.POSTALCODE IS NOT NULL and ", ppvgeocc,".POSTALCODE is NOT NULL))")))
        
        nvgeo_Postal_dif=nrow(vgeo_Postal_dif)
        if (nvgeo_Postal_dif!=0) {
          cat(paste0("         ","FAIL! Number of rows with unmatched postal codes =",nvgeo_Postal_dif,"\n"))
          cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        }

        
        # Check records without postal code with unmatched state or district code
        vgeo_NoPostal_dif = data.table(sqlQuery(dbHandle,paste0("SELECT vgeo.GEO_RECNUM as 'NG-GeoRecnum', ", ppvgeocc,".GEO_RECNUM as 'RL-GeoRecnum',vgeo.Admin1Code as 'NG-Admin1Code',", ppvgeocc,".STATE,vgeo.Admin2Code,", ppvgeocc,".COUNTYNUM
                                                                FROM vgeo 
                                                                INNER JOIN ", ppvgeocc," ON vgeo.country=",dummyname," and vgeo.GEO_RECNUM = ", ppvgeocc,".GEO_RECNUM and (vgeo.POSTALCODE IS NULL and ", ppvgeocc,".POSTALCODE is NULL) and (vgeo.Admin1Code!=", ppvgeocc,".STATE or vgeo.Admin2Code!=", ppvgeocc,".COUNTYNUM)")))
        
        nvgeo_NoPostal_dif=nrow(vgeo_NoPostal_dif)
        if (nvgeo_NoPostal_dif!=0) {
            cat(paste0("         ","FAIL! Number of rows with unmatched state or district fields =",nvgeo_NoPostal_dif,"\n"))
            print(vgeo_NoPostal_dif)
        }
        
        if (nvgeo_Postal_dif==0 & nvgeo_NoPostal_dif==0) {
          cat(paste0("         ","PASS! ALL RECORDS WITH THE SAME GEORECNUM MATCHED BETWEEN TWO TABLES!","\n"))   
        }
        
      }
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    # Check for the wild card at the end
if (tolower(dummyname) %in% sets$Test5$Countries) {	
wild_card=data.table(sqlQuery(dbHandle, paste0("SELECT GEO_RECNUM  FROM vgeo
                                                   where 
                                                   [country]=",dummyname,"  
                                                   and [Admin1Code] is NULL
                                                   and [Zone1] is NULL
                                                   and [SUB_CRESTA]is NULL
                                                   and [Admin2Code]is NULL
                                                   and [CITY]is NULL
                                                   and [POSTALCODE]is NULL
                                                   and [DC_KEY]!=0
                                                   and [INV_KEY]!=0
                                                   and [CITYCODE]is NULL
                                                   and [Admin3Code]is NULL
                                                   and [LOCNCODE]is NULL
                                                   and [MAX_GEORESOLUTIONCODE]=0
                                                   and [STARTRES]=0
                                                   and [ENDRES]=0
                                                   and [BIZONEBLDG]=0
                                                   and [BIZONELL]=0
                                                   and [Admin1GeoId]=0
                                                   and [Admin2GeoId]=0
                                                   and [Admin3GeoId]=0
                                                   and [PostalCodeGeoId]=0
                                                   and [Zone1GeoId]=0
                                                   and [LocationCodeGeoId]=0")))
} else {
  wild_card=data.table(sqlQuery(dbHandle, paste0("SELECT GEO_RECNUM  FROM vgeo
                                                   where 
                                                   [country]=",dummyname,"  
                                                   and [Admin1Code] is NULL
                                                   and [Zone1] is NULL
                                                   and [SUB_CRESTA]is NULL
                                                   and [Admin2Code]is NULL
                                                   and [CITY]is NULL
                                                   and [POSTALCODE]is NULL
                                                   and [DC_KEY]!=0
                                                   and [INV_KEY]!=0
                                                   and [CITYCODE]is NULL
                                                   and [Admin3Code]is NULL
                                                   and [Admin4Code]is NULL
                                                   and [LOCNCODE]is NULL
                                                   and [MAX_GEORESOLUTIONCODE]=0
                                                   and [STARTRES]=0
                                                   and [ENDRES]=0
                                                   and [BIZONEBLDG]=0
                                                   and [BIZONELL]=0
                                                   and [Admin1GeoId]=0
                                                   and [Admin2GeoId]=0
                                                   and [Admin3GeoId]=0
                                                   and [Admin4GeoId]=0
                                                   and [PostalCodeGeoId]=0
                                                   and [Zone1GeoId]=0
                                                   and [LocationCodeGeoId]=0
                                                 
                                                 
                                                 ")))                                                     
                                                     
    LastRecord = data.table(sqlQuery(dbHandle, paste0("SELECT max(GEO_RECNUM) as GEO_RECNUM FROM vgeo")))                                               
                                                   }
    
    if (nrow(wild_card) !=1){
      cat(paste0("         ","FAIL! VGEO TABLE DOES NOT INCLUDE THE WILD CARD"))
    } else if (wild_card!=LastRecord){
      cat(paste0("         ","FAIL! WILD CARD is not the last record in VGEO table"))
    } else 
    {
      cat(paste0("         ","PASS! VGEO TABLE INCLUDES THE WILD CARD and it is the last record"))
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    
    # Check if all geoids are zero:
    if (tolower(dummyname)!="'jp'") {	
      zerogeoid=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM vgeo
                                                      where 
                                                      [country]=",dummyname," and 
                                                      Zone1GeoId = 0 and
                                                      Admin1GeoId = 0 and
                                                      Admin2GeoId = 0 and
                                                      Admin3GeoId = 0 and
                                                      POSTALCODEgeoid = 0 and 
                                                      LocationCodeGeoId = 0")))
    } else {
      zerogeoid=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM vgeo
                                                      where 
                                                      [country]=",dummyname,"  and
                                                      Zone1GeoId = 0 and
                                                      Admin1GeoId = 0 and
                                                      Admin2GeoId = 0 and
                                                      Admin3GeoId = 0 and
                                                      Admin4GeoId = 0 and
                                                      POSTALCODEgeoid = 0 and 
                                                      LocationCodeGeoId = 0
                                                      and citygeoid=0
                                                     
                                                     ")))                                                     
      
      
    }
    
    if (nrow(zerogeoid) !=1){
      cat(paste0("         ","FAIL! VGEO TABLE HAS ",nrow(zerogeoid)," ROWS WITH ALL GEOID FIELDS EQUAL TO ZERO"))
    } else {
      cat(paste0("         ","PASS! No row contaons all Admin Geoids equal to zero except the wild card."))
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
    
    
    
    
  }
  
  }

####Test6-Check cghs and eqcghsus tables:   KEY cghs_ID
Test_6 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables,NGTableExist) {

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  if (NGTableExist){
    for (i in 1:nCountries)
    {
      
      for (j in 1:nPerils){
        currentPerilCountry=paste0(Perils[j],Countries[i])
        if (currentPerilCountry %in% perilcountry) {
          cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
          dummyname=paste0("'",Countries[i],"'",collapse="")
          ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")
          
          cghs_dif = data.table(sqlQuery(dbHandle,paste0("SELECT cghs.HAZ_TYPE, ", ppcghscc,".HAZ_TYPE,cghs.HAZ_SCALE, ", ppcghscc,".HAZ_SCALE, cghs.COVERAGE, ", ppcghscc,".COVERAGE
                                                         FROM cghs
                                                         INNER JOIN ", ppcghscc," ON cghs.country=",dummyname," and  ", ppcghscc,".CGHS_ID=cghs.CGHS_ID and 
                                                         (", ppcghscc,".HAZ_TYPE!=(select Map_HazardType.haz_type from Map_HazardType where haz_type_id=cghs.HAZ_TYPE) or
                                                         ", ppcghscc,".HAZ_SCALE!=(select Map_HazardSCALE.haz_SCALE from Map_HazardSCALE where haz_SCALE_id=cghs.HAZ_SCALE)or
                                                         ", ppcghscc,".COVERAGE!=(select Map_COVERAGE.coverage from Map_COVERAGE where COVERAGE_id=cghs.COVERAGE))")))
          
          ncghs_dif=nrow(cghs_dif)
          if (ncghs_dif!=0){
            cat(paste0("         ","FAIL! Numberof rows with unmatched values =",ncghs_dif,"\n"))
            print(cghs_dif)
          } else {cat(paste0("         ","PASS! ALL RECORDS WITH THE SAME CGHS_ID MATCHED BETWEEN TWO TABLES!","\n"))   }
        }
      }
      
      
      # Check if all CVG_GRADEs are between 0 and 4
      # for NG table
      cat(paste0("         ","Check for NG Tables:","\n"))
      CVg_Grade_Bound=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM cghs
                                                           where 
                                                           [country]=",dummyname,"  
                                                           and   [CVG_GRADE] not between 0 and 4")))
      
      if (nrow(CVg_Grade_Bound) !=0){
        cat(paste0("         ","FAIL! CVG_GRADES ARE NOT BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      } else {
        cat(paste0("         ","PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      }
      
      # Check if all CVG_GRADEs are Either 0 or includes all values 0-4
      # for NG table
      CVg_Grade_count=data.table(sqlQuery(dbHandle, paste0("select COUNT(distinct CVG_GRADE) from 
                                                           (SELECT country,COVERAGE,CVG_GRADE FROM cghs
                                                           where 
                                                           [country]=",dummyname,"   
                                                           group by   country, COVERAGE, [CVG_GRADE]) s")))
      
      
      if (CVg_Grade_count!=0 & CVg_Grade_count!=5){
        cat(paste0("         ","FAIL! CVG_GRADES DO NOT INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      } else {
        cat(paste0("         ","PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      }
      
      
      
      
      cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
      
    }
}

# Check if all CVG_GRADEs are between 0 and 4 For RiskLink Tables 

for (i in 1:nCountries)
{
  cat(paste0("\n",toupper(Countries[i]),":","\n"))
  for (j in 1:nPerils){
    currentPerilCountry=paste0(Perils[j],Countries[i])
    if (currentPerilCountry %in% perilcountry) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")
      
      CVg_Grade_Bound=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM ", ppcghscc," 
                                                           where 
                                                           [CVG_GRADE] not between 0 and 4")))
      
      if (nrow(CVg_Grade_Bound) !=0){
        cat(paste0("         ","FAIL! CVG_GRADES ARE NOT BETWEEN 0 AND 4 in ", ppcghscc,"  TABLE","\n"))
      } else {
        cat(paste0("         ","PASS! CVG_GRADES ARE BETWEEN 0 AND 4 in ", ppcghscc,"  TABLE","\n"))
      }
      
      
      # Check if all CVG_GRADEs are Either 0 or includes all values 0-4
      # for NG table
      CVg_Grade_count=data.table(sqlQuery(dbHandle, paste0("select COUNT(distinct CVG_GRADE) from 
                                                           (SELECT COVERAGE,CVG_GRADE FROM ", ppcghscc," 
                                                           group by COVERAGE, [CVG_GRADE]) s")))
      
      if (CVg_Grade_count!=0 & CVg_Grade_count!=5){
        cat(paste0("         ","FAIL! CVG_GRADES DO NOT INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      } else {
        cat(paste0("         ","PASS! CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE","\n"))
      }
      
      
      
      cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
      
      
      
      
    }
  }
  }
}

#### Test-7- Check Imap and eqimapus tables: KEY is  INV_RECNUM
Test_7 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      if (!(tolower(Perils[j]) %in% sets$Test7$Perils)){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        imap_dif = data.table(sqlQuery(dbHandle,paste0("SELECT imap.INV_RECNUM, ", ppimapcc,".INV_RECNUM
                                                       FROM imap
                                                       INNER JOIN ", ppimapcc," ON imap.country=",dummyname," and ", ppimapcc,".INV_RECNUM=imap.INV_RECNUM and 
                                                       (", ppimapcc,".INV_KEY!=(select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY) or 
                                                       (", ppimapcc,".INV_KEY is NULL and 
                                                       (select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY)is not NULL) or 
                                                       ", ppimapcc,".MAPCCLSSIF!=(select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)or
                                                       (", ppimapcc,".MAPCCLSSIF is NULL and 
                                                       (select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)is not NULL) or
                                                       ", ppimapcc,".MAPCCTIER1!=(select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1) or 
                                                       (", ppimapcc,".MAPCCTIER1 is NULL and 
                                                       (select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1)is not NULL) or 
                                                       ", ppimapcc,".MAPCCTIER2!=(select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2) or 
                                                       (", ppimapcc,".MAPCCTIER2 is NULL and 
                                                       (select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2)is not NULL) or
                                                       ", ppimapcc,".MAPCCTIER3!=(select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3) or 
                                                       (", ppimapcc,".MAPCCTIER3 is NULL and 
                                                       (select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3)is not NULL) or 
                                                       ", ppimapcc,".INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC) or 
                                                       (", ppimapcc,".INV_OCC is NULL and 
                                                       (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC)is not NULL) or
                                                       ", ppimapcc,".INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC) or 
                                                       (", ppimapcc,".INV_OCC is NULL and 
                                                       (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC)is not NULL) or
                                                       ", ppimapcc,".CV_KEY!=(select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY) or 
                                                       (", ppimapcc,".CV_KEY is NULL and 
                                                       (select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY)is not NULL))")))
        # or
        # ", ppimapcc,".BR_TVKEY!=(select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY) or 
        # (", ppimapcc,".BR_TVKEY is NULL and 
        # (select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY)is not NULL) or
        # ", ppimapcc,".BR_DRKEY!=(select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY) or 
        # (", ppimapcc,".BR_DRKEY is NULL and 
        # (select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY)is not NULL)
        # )
        
        nimap_dif=nrow(imap_dif)
        if (nimap_dif!=0){
          cat(paste0("FAIL! Number of rows with unmatched records =",nimap_dif,"\n"))
        } else { cat(paste0("         ","PASS! ALL RECORDS WITH THE SAME INV_RECNUM MATCHED BETWEEN TWO TABLES!","\n"))  }
      }
      }
    }
  }
  }

#### Test8- Check vinv and eqvinvus tables KEy: INV_RECNUM and PDC_NUM and PDC_GROUP
Test_8 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      if ((tolower(Perils[j]) %in% sets$Test8$Perils)){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvinvcc=paste0(Perils[j],"vinv",Countries[i],collapse="")
        
        inv_dif = data.table(sqlQuery(dbHandle,paste0(" SELECT vinv.INV_RECNUM,vinv.PDC_GROUP,vinv.PDC_NUM, ", ppvinvcc,".INV_RECNUM,", ppvinvcc,".PDC_GROUP,", ppvinvcc,".PDC_NUM 
                                                      FROM vinv 
                                                      INNER JOIN ", ppvinvcc," ON vinv.country=",dummyname," and  (vinv.INV_RECNUM= ", ppvinvcc,".INV_RECNUM and vinv.PDC_GROUP=", ppvinvcc,".PDC_GROUP and vinv.PDC_NUM =", ppvinvcc,".PDC_NUM) 
                                                      and ((ROUND(vinv.DEF_INVPCT,0)!=ROUND(", ppvinvcc,".DEF_INVPCT,0) 
                                                      or (ROUND(vinv.CT,3)!=ROUND(", ppvinvcc,".CT,3))) 
                                                      or (vinv.AVGSTHT!=", ppvinvcc,".AVGSTHT) or (vinv.DNUMSTOR!=", ppvinvcc,".DNUMSTOR))"
        )))
        
        
        ninv_dif=nrow(inv_dif)
        if (ninv_dif!=0){
          cat(paste0("FAIL! Number of rows with unmatched records =",ninv_dif,"\n"))
          print(inv_dif)
        } else { cat(paste0("         ","PASS! ALL RECORDS WITH THE SAME INV_RECNUM, PDC_GROUP,and PDC_NUM MATCHED BETWEEN TWO TABLES!","\n"))  }
      }
    }}
  }
}

###TEST-9:TEST VDC0 TABLE
####### TEST vdc0
Test_9 <- function (dbHandle,reportCon,Perils,Countries,tables,perilcountry,VulnDb_ExpectedTables,NGTableExist){
                   
  nPerils=length(Perils)
  nCountries=length(Countries)
  cat(paste0("\n","CHECK RISKLINK TABLES: ","\n"))
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvdc0cc=paste0(Perils[j],"vdc0",Countries[i],collapse="")
        ppvhazcc=paste0(Perils[j],"vhaz",Countries[i],collapse="")
        
        
        
        eqvdc0 = sqlQuery(dbHandle, paste0("select ",ppvhazcc,".DC_KEY,",ppvhazcc,".CGHS_ID,",ppvdc0cc,".HAZPARAMID,",ppvhazcc,".HAZ_SEV,",ppvdc0cc,".DAMAGE_PCT,",ppvdc0cc,".PDC_NUM
                                           from ",ppvdc0cc,"
                                           full outer join ",ppvhazcc," on ",ppvhazcc,".HAZPARAMID=",ppvdc0cc,".HAZPARAMID 
                                           order by PDC_NUM,DC_KEY,HAZPARAMID"))
        eqvdc0 = data.table(eqvdc0)
        eqvdcD <- eqvdc0[,.(difference = diff(DAMAGE_PCT)),by=c("PDC_NUM","DC_KEY","CGHS_ID")]
        neqvdcD=nrow(eqvdcD[difference<0])
        
        if (neqvdcD!=0){
          cat(paste0("FAIL! Number of damage curves which are not motonically increasing=",neqvdcD," out of ",nrow(eqvdcD),"\n"))
          print(eqvdcD[difference<0,c("PDC_NUM", "DC_KEY", "CGHS_ID"),])
        } else { cat(paste0("         ","PASS! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!","\n"))  }
        
        
        
      }
    }
  }
  
  
  if (NGTableExist){
    
    cat(paste0("\n","\n","CHECK NG TABLES: ","\n"))
    
    vdc0 = sqlQuery(dbHandle, "select * From vdc0")
    vdc0 = data.table(vdc0)
    
    # Check if all damage curves are monotonically increasing
    vdcD <- vdc0[,.(difference = diff(DAMAGE_PCT)),by=c("country","PDC_NUM","dc_key","CGHS_ID")]
    nvdcD=nrow(vdcD[difference<0])
    
    if (nvdcD!=0){
      cat(paste0("FAIL! Number of damage curves which are not motonically increasing=",nvdcD,"\n"))
    } else { cat(paste0("         ","PASS! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!","\n"))  }
    
    
    # Check if the x-axis on damage curves are motonically increasing
    vdcDHaz <- vdc0[,.(difference=diff(HAZ_SEV)),by=c("country","PDC_NUM","dc_key","CGHS_ID")]
    
    nvdcDHaz=nrow(vdcDHaz[difference<0])
    
    
    if (nvdcDHaz!=0){
      cat(paste0("FAIL! Number of damage curves in which x-axis is not motonically increasing= ",nvdcDHaz,"\n"))
    } else { cat(paste0("         ","PASS! X-AXES ON ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!","\n"))  }
    
    
    # Check if curves with the same CGHS_ID have the same number or records.
    
    Frequency=data.table(sqlQuery(dbHandle,"  
                                  SELECT country,DC_KEY, PDC_NUM, CGHS_ID, COUNT(*) as Freq
                                  FROM vdc0 
                                  GROUP BY  country, DC_KEY, PDC_NUM, CGHS_ID 
                                  "))
    
    Freq_Diff=Frequency[,.(difference=diff(Freq)),by=c("country","CGHS_ID")]
    nFreq_Diff=nrow(Freq_Diff[difference!=0])
    
    if (nFreq_Diff!=0){
      cat(paste0("FAIL! Number of damage curves with the same CGHS-ID but different number of records= ",nFreq_Diff,"\n"))
    } else { cat(paste0("         ","PASS! ALL CURVES WITH THE SAME CGHS-ID HAVE THE SAME NUMBER OF RECORDS!"))  }
    
  }
}

####Test-10: Test vcc and eqvccus tables
Test_10 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcccc=paste0(Perils[j],"vcc",Countries[i],collapse="")
        
        
        
    
        
        vcc_dif = data.table(sqlQuery(dbHandle,paste0(" select * from ", ppvcccc," where CC_RECNUM not in 
        (SELECT a.CC_RECNUM
         FROM ", ppvcccc," a 
         JOIN vcc b ON b.country=",dummyname," and 
         (b.ConstructionID=(select distinct Map_ConstructionNew.ConstructionID from Map_ConstructionNew where ConstructionCode= a.C_CLASS and 
                            ConstructionScheme=a.C_CLASSIF and CountryRMSCode=b.country) and 
          ((a.MAPCCTIER1=(select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= b.MAPCCTIER1) or 
            (a.MAPCCTIER1 is NULL and (select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= b.MAPCCTIER1)is NULL))or 
           (a.MAPCCTIER2=(select Map_MAPCCTier2.mapcctier2 from Map_MAPCCTier2 where mapcctier2_id= b.MAPCCTIER2) or 
            (a.MAPCCTIER2 is NULL and (select Map_MAPCCTier2.mapcctier2 from Map_MAPCCTier2 where mapcctier2_id= b.MAPCCTIER2)is NULL))or 
           (a.MAPCCTIER3=(select Map_MAPCCTier3.mapcctier3 from Map_MAPCCTier3 where mapcctier3_id= b.MAPCCTIER3) or 
            (a.MAPCCTIER3 is NULL and (select Map_MAPCCTier3.mapcctier3 from Map_MAPCCTier3 where mapcctier3_id= b.MAPCCTIER3)is  NULL))or 
           (a.MAPCCLSSIF=(select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= b.MAPCCLSSIF)))))
                                                      ")))
        
        nvcc_dif=nrow(vcc_dif)
        
        if (nvcc_dif!=0){
          cat(paste0("FAIL! Number of unmatched records= ",nvcc_dif,"\n"))
          print(vcc_dif)
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}

####Test-11: Test vocc and eqvoccus tables
Test_11 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        
      
        vocc_dif = data.table(sqlQuery(dbHandle,paste0("select * from ", ppvocccc," where OCC_RECNUM not in (
                                                      SELECT a.OCC_RECNUM
                                                         FROM ", ppvocccc," a 
                                                         INNER JOIN vocc b ON b.country=",dummyname,"  and  
                                                         (b.OccupancyID=(select Map_OccupancyNew.OccupancyID from Map_OccupancyNew where OccupancyCode= a.O_CLASS and 
                                                         OccupancyScheme=a.O_CLASSIF and CountryRMSCode=b.country) and 
                                                         ((b.WC_OCC=a.WC_OCC) or (b.BI_OCC=a.BI_OCC) or
                                                         (a.AGGHAZ_OCC=(select Map_AggHazOcc.AggHazOcc from Map_AggHazOcc where AggHazOccID= b.AggHazOccId) or 
                                                         (a.AGGHAZ_OCC is NULL and (select Map_AggHazOcc.AggHazOcc from Map_AggHazOcc where AggHazOccID= b.AggHazOccId)is NULL))or 
                                                         (a.ESDB_OCC=(select Map_ESDBOcc.esdb_occ from Map_ESDBOcc where esdb_occ_id= b.ESDB_OCC) or 
                                                         (a.ESDB_OCC is NULL and (select Map_ESDBOcc.esdb_occ from Map_ESDBOcc where esdb_occ_id= b.ESDB_OCC)is  NULL))or      
                                                         (a.INV_OCC=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= b.INV_OCC) or 
                                                         (a.INV_OCC is NULL and (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= b.INV_OCC)is  NULL))or 
                                                         (a.FFEQ_OCC=(select Map_FFEQOcc.ffeq_occ from Map_FFEQOcc where ffeq_occ_id= b.FFEQ_OCC) or 
                                                         (a.FFEQ_OCC is NULL and (select Map_FFEQOcc.ffeq_occ from Map_FFEQOcc where ffeq_occ_id= b.FFEQ_OCC)is NULL)))))
                                                       ")))
                                                              
        
        
        nvocc_dif=nrow(vocc_dif)
        
        if (nvocc_dif!=0){
          cat(paste0("Number of unmatched records= ",nvocc_dif,"\n"))
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}

####Test-12:TEST IMAP AND VINV
Test_12 <- function (dbHandle,reportCon,Perils,Countries,perilcountry){

  nCountries=length(Countries)
  nPerils=length(Perils)
  
  for (j in 1:nPerils){
  if ((tolower(Perils[j]) %in% sets$Test12$Perils)){
  
  for (i in 1:nCountries)
  {
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    
    dummyname=paste0("'",Countries[i],"'",collapse="")
    
    
    PDC_NUM_Diff = data.table(sqlQuery(dbHandle,paste0("select imap.INV_RECNUM, imap.ModifPDC  from imap 
                                                       inner join (  SELECT  imap.INV_RECNUM as rec, imap.ModifPDC as modif, imap.country as country
                                                       FROM imap
                                                       inner JOIN vinv ON imap.INV_RECNUM=vinv.INV_RECNUM and imap.ModifPDC!=vinv.PDC_NUM
                                                       and  imap.ModifPDC!=0 and vinv.INV_RECNUM is not null ) s
                                                       on imap.country=",dummyname," and s.country=",dummyname," and imap.INV_RECNUM=s.rec and imap.ModifPDC!=s.modif
                                                       ")))
    
    nPDC_NUM_Diff=nrow(PDC_NUM_Diff)
    
    if (nPDC_NUM_Diff!=0){
      cat(paste0("\n","         ","FAIL! Number of unmatched records= ",nPDC_NUM_Diff))
    } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
    
  }
  }
  }
}

####Test-13:CASE SENSITIVITY
Test_13 <- function (dbHandle,reportCon){

  
  Map_InvOcc_Sensitivity_diff=CaseCheck('Map_InvOcc','inv_occ')
  nMap_InvOcc_Sensitivity_diff=nrow(Map_InvOcc_Sensitivity_diff)
  
  if (nMap_InvOcc_Sensitivity_diff!=0){
    cat(paste0("         ","FAIL! Number of records with unmatched cases in nMap_InvOcc= ",nMap_InvOcc_Sensitivity_diff,"\n"))
  }  
  
  
  Map_InvKey_Sensitivity_diff=CaseCheck('Map_InvKey','inv_key')
  nMap_InvKey_Sensitivity_diff=nrow(Map_InvKey_Sensitivity_diff)
  
  if (nMap_InvKey_Sensitivity_diff!=0){
    cat(paste0("         ","FAIL! Number of records with unmatched cases in nMap_InvKey= ",nMap_InvKey_Sensitivity_diff,"\n"))
  }  
  
  if (nMap_InvKey_Sensitivity_diff==0 & nMap_InvOcc_Sensitivity_diff==0 ){
    cat(paste0("         ","PASS! NO CASE SENSITIVITY PROBLEM IS FOUND!","\n"))  }
}

####Test-14: CONSISTENCY OF DATA BETWEEN VCC AND IMAP TABLES (KEY IS COMBINATION OF MAPCLASSIF, TIER 1, TIER 2, AND TIER 3)
Test_14 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcccc=paste0(Perils[j],"vcc",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        suppressWarnings(library(tcltk))
        
        
        
        vcc_imap_dif_Exact = data.table(sqlQuery(dbHandle,paste0("   select CC_RECNUM, MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppvcccc,"
                                                           where not exists ( 
                                                           select MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppimapcc," 
                                                           where 
                                                           (",ppvcccc,".MAPCCLSSIF=",ppimapcc," .MAPCCLSSIF or (",ppvcccc,".MAPCCLSSIF is null and ",ppimapcc," .MAPCCLSSIF is null)) and
                                                           (",ppvcccc,".MAPCCTIER1=",ppimapcc," .MAPCCTIER1 or (",ppvcccc,".MAPCCTIER1 is null and ",ppimapcc," .MAPCCTIER1 is null)) and
                                                           (",ppvcccc,".MAPCCTIER2=",ppimapcc," .MAPCCTIER2 or (",ppvcccc,".MAPCCTIER2 is null and ",ppimapcc," .MAPCCTIER2 is null)) and 
                                                           (",ppvcccc,".MAPCCTIER3=",ppimapcc," .MAPCCTIER3 or (",ppvcccc,".MAPCCTIER3 is null and ",ppimapcc," .MAPCCTIER3 is null)))
                                                           
                                                           ")))
        
        nvcc_imap_dif_Exact=nrow(vcc_imap_dif_Exact)
        
        if (nvcc_imap_dif_Exact!=0){
          cat(paste0("         ","Warning! Number of records that have not an exact match of combination of MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, and MAPCCTIER3: ",nvcc_imap_dif_Exact,"\n"))
          cat(paste0("         ","Examples are as follows:","\n"))
          print(head(vcc_imap_dif_Exact))}
        cat("\n")

       vcc_imap_dif_NoWild = data.table(sqlQuery(dbHandle,paste0("  select CC_RECNUM, MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppvcccc," a
                                                           where  not exists ( 
                                                           select MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppimapcc,"  b
                                                           where 
                                                           (a.MAPCCLSSIF=b .MAPCCLSSIF or (b .MAPCCLSSIF is null)) and
                                                           (a.MAPCCTIER1=b .MAPCCTIER1 or (b .MAPCCTIER1 is null)) and
                                                           (a.MAPCCTIER2=b .MAPCCTIER2 or (b.MAPCCTIER2 is null)) and 
                                                           (a.MAPCCTIER3=b .MAPCCTIER3 or ( b .MAPCCTIER3 is null)) and 
														                               not (b .MAPCCLSSIF is null and b .MAPCCTIER2 is null and b .MAPCCTIER3 is null and b .MAPCCTIER1 is null))
                                                           
                                                           ")))
        
       vcc_imap_dif_NotEvenWild = data.table(sqlQuery(dbHandle,paste0("  select CC_RECNUM, MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppvcccc," a
                                                           where  not exists ( 
                                                           select MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppimapcc,"  b
                                                           where 
                                                           (a.MAPCCLSSIF=b .MAPCCLSSIF or (b .MAPCCLSSIF is null)) and
                                                           (a.MAPCCTIER1=b .MAPCCTIER1 or (b .MAPCCTIER1 is null)) and
                                                           (a.MAPCCTIER2=b .MAPCCTIER2 or (b.MAPCCTIER2 is null)) and 
                                                           (a.MAPCCTIER3=b .MAPCCTIER3 or ( b .MAPCCTIER3 is null)))
                                                           
                                                           ")))
       
       
       recordsFallingBacktoNotExact= sqldf('SELECT * FROM vcc_imap_dif_Exact EXCEPT SELECT * FROM vcc_imap_dif_NoWild')
       recordsFallingBacktoWildCard= sqldf('SELECT * FROM vcc_imap_dif_NoWild EXCEPT SELECT * FROM vcc_imap_dif_NotEvenWild')
        
       if (nrow(recordsFallingBacktoNotExact)!=0){
         cat(paste0("         ","Warning! Number of VCC records that have not an exact match but falling back to a record in IMAP which is not wild card: ",nrow(recordsFallingBacktoNotExact),"\n"))
         print(head(recordsFallingBacktoNotExact))
         cat("\n")
       }
         
       if (nrow(recordsFallingBacktoWildCard)!=0){
         cat(paste0("         ","Fail! Number of VCC records that are falling back to the wild card: ",nrow(recordsFallingBacktoWildCard),"\n"))
         print(head(recordsFallingBacktoWildCard))
         cat("\n")
       } 
       
       if (nrow(vcc_imap_dif_NotEvenWild)!=0){
         cat(paste0("         ","Fail! Number of VCC records that does not found or fall back to any records in IMAP: ",nrow(vcc_imap_dif_NotEvenWild),"\n"))
        print(head(vcc_imap_dif_NotEvenWild))
        cat("\n")} 
        
       if (nrow(vcc_imap_dif_NotEvenWild)==0 & nrow(recordsFallingBacktoWildCard)==0) {
         cat(paste0("         ","Pass! All records of VCC tables have either exact match in IMAP or are falling back to a record.","\n"))
         
       }
       
        
      }
    }
  }
}  

####Test-15: CONSISTENCY OF DATA BETWEEN VOCC AND IMAP TABLES (KEY IS INV_VOCC)
Test_15 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        vocc_imap_dif = data.table(sqlQuery(dbHandle,paste0("    select distinct(INV_OCC) from ",ppvocccc,"  a
                                                            where 
                                                            not exists (select INV_OCC from ",ppimapcc,"  b
                                                            where a.INV_OCC=b.INV_OCC) ")))
        
        nvocc_imap_dif=nrow(vocc_imap_dif)
        
        if (nvocc_imap_dif!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nvocc_imap_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vocc and imap include following INV_OCC(s):","\n"))
          cat(paste0("         ",vocc_imap_dif$INV_OCC))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}  

####Test-16: CONSISTENCY OF DATA BETWEEN VGEO AND IMAP TABLES (KEY IS INV_KEY)
Test_16 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){

  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        
        vgeo_imap_dif = data.table(sqlQuery(dbHandle,paste0("       SELECT
                                                                       T1.INV_KEY
                                                                    FROM
                                                                       (SELECT DISTINCT INV_KEY FROM ",ppvgeocc," ) T1
                                                                       left JOIN
                                                                       (SELECT DISTINCT INV_KEY FROM ",ppimapcc," ) T2
                                                                                  ON T1.INV_KEY = T2.INV_KEY where T2.INV_KEY is null  ")))
        
        nvgeo_imap_dif=nrow(vgeo_imap_dif)
        
        if (nvgeo_imap_dif!=0){
          cat(paste0("FAIL! Number of unmatched records= ",nvgeo_imap_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vgeo and imap include following INV_KEY(s):","\n"))
          cat(paste0("         ",vgeo_imap_dif$INV_KEY))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}  

####Test-17:Integrity of IMAP with VCC, VOCC, VGEO, using PDC list received from modelers
Test_17 <- function (dbHandle3,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables,db,cwd){
  
  nPerils=length(Perils)
  nCountries=length(Countries)

  for (i in 1:nCountries)
  {
    
    if (toupper(Countries[i]) %in% sets$Test17$Countries){
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")

        
        PDCList=paste0("[NAEQ_PDC_MAPPING]..",Perils[j],"PDCList",Countries[i],collapse="")
        DCmapping=paste0("[NAEQ_PDC_MAPPING]..",Perils[j],"DCmapping",Countries[i],collapse="")
        cghsdb=paste0(db,"..",Perils[j],"cghs",Countries[i],collapse="")
        vhaz=paste0(db,"..",Perils[j],"vhaz",Countries[i],collapse="")
        vdc0=paste0(db,"..",Perils[j],"vdc0",Countries[i],collapse="")
       
        
        imap_dif = data.table(sqlQuery(dbHandle3,paste0("select a.Region,a.C_CLASSIF,a.C_CLASS,a.INV_OCC, b.dc_key,cghs.CGHS_ID,a.pdc_num, CNT,count(*) as CNT, sum(damage_pct) as SUMMATION 
                    from ",PDCList," a
                    join ",DCmapping," b 
                    on a.Region=b.Region
                    cross join 
                    (select *
                    from ",cghsdb," where COVERAGE!='BI') cghs
                    join 
                    (
                    select distinct haz_scale,CNT from 
                    (select distinct b.CGHS_ID,HAZ_SCALE,DC_KEY,count(HAZ_SCALE) CNT from ",vhaz," a
                    join ",cghsdb," b 
                    on a.CGHS_ID=b.CGHS_ID
                    group by b.CGHS_ID,HAZ_SCALE,DC_KEY) H
                    ) HAZ
                    on cghs.HAZ_SCALE=HAZ.HAZ_SCALE
                    left join ",vhaz," c
                    on  b.DC_KEY=c.DC_KEY and cghs.cghs_id=c.cghs_id 
                    left join ",vdc0," d
                    on  c.HAZPARAMID=d.HAZPARAMID and a.pdc_num=d.pdc_num 
                    group by a.region,b.dc_key,cghs.CGHS_ID,a.pdc_num,CNT,a.C_CLASSIF,a.C_CLASS,a.INV_OCC
                    having sum(damage_pct)=0 or sum(damage_pct) is null or count(*)!= CNT
                    order by SUMMATION Desc
                    ")))
        
        nimap_dif=nrow(imap_dif)
        
        if (nimap_dif!=0){
          cat(paste0("FAIL! Number of unmatched records= ",nimap_dif,"\n"))
          cat(paste0("         ","Summary of unmatched data is reported below more details are presented in a csv file in log folder!:","\n"))
          print(count(imap_dif,c("Region","C_CLASSIF","C_CLASS","INV_OCC")))
          
          tStamp <- as.character(format(Sys.time(), "%Y%m%d_%Hh%Mm%Ss"))
          
          filename_ER <- paste0(cwd,"/log/",toupper(Countries[i]),"_", db, "_IMAP_", tStamp,"_Error.csv")
          write.csv(imap_dif, file = filename_ER,row.names=FALSE)
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}
}

####Test-18: CV key in IMAP should be in vcv table
Test_18 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcvocc=paste0(Perils[j],"vcv",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        
        vcv_imap_dif = data.table(sqlQuery(dbHandle,paste0("   select distinct cv_key from ",ppimapcc,"  where CV_KEY not in 
(select distinct cv_key from ",ppvcvocc,")    
 ")))
        
        nvcv_imap_dif=nrow(vcv_imap_dif)
        
        if (nvcv_imap_dif!=0){
          cat(paste0("FAIL! Number of unmatched records= ",nvcv_imap_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vcv and imap include following INV_KEY(s):","\n"))
          cat(paste0("         ",vcv_imap_dif$cv_key))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}  

####Test-19: CONSISTENCY OF DATA BETWEEN FLIINV AND VCC, VOCC, AND VGEO TABLES
Test_19 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        
        
        
        
        
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        ppvcccc=paste0(Perils[j],"vcc",Countries[i],collapse="")
        ppfliinvcc=paste0(Perils[j],"fliinv",Countries[i],collapse="")
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
		ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")
			 
        CGHS = data.table(sqlQuery(dbHandle,paste0(" select * from ", ppcghscc)))
		modelperils = unique(CGHS$HAZ_TYPE)
       
        if (tolower("ff") %in% tolower(modelperils)){
		
		
        #Test a:
        
        fliinv_vocc_dif = data.table(sqlQuery(dbHandle,paste0("           
        (select distinct a.FFEQ_OCC 
         from ",ppvocccc," a
         except
         select distinct b.FFEQ_OCC 
         from ",ppfliinvcc," b)
        union 
        (select distinct b.FFEQ_OCC 
         from ",ppfliinvcc," b
         except
         select distinct a.FFEQ_OCC 
         from ",ppvocccc," a  )	  
                                                           ")))
        
        nfliinv_vocc_dif=nrow(fliinv_vocc_dif)
        
        if (nfliinv_vocc_dif!=0){
          cat(paste0("FAIL! Number of records where FFEQ_OCC does not match between fliinv and vocc tables = ",nfliinv_vocc_dif,"\n"))
          cat(paste0("         ","Difference(s) between the fliinv and vocc include following FFEQ_OCC(s):","\n"))
          cat(paste0("         ",fliinv_vocc_dif$FFEQ_OCC))
        } else { cat(paste0("         ","PASS! ALL FFEQ_OCC matched between fliinv and vocc tables!","\n"))  }
          
        #Test b:
        
        
        
        ffeq_occ_fliinv=CaseCheck(ppfliinvcc,"ffeq_occ")
        ffeq_occ_vocc=CaseCheck(ppvocccc,"ffeq_occ")		
        nffeq_occ_fliinv=nrow(ffeq_occ_fliinv)
        nffeq_occ_vocc=nrow(ffeq_occ_vocc)
        
        if (nffeq_occ_fliinv!=0){
          cat(paste0("\n","         ","FAIL! Number of records with FFEQ_OCC case sensitivity problem in fliinv= ",nffeq_occ_fliinv,"\n"))
        }  
        
        if (nffeq_occ_vocc!=0){
          cat(paste0("\n","         ","FAIL! Number of records with FFEQ_OCC case sensitivity problem in vocc= ",nffeq_occ_vocc,"\n"))
        }  
        
        
        if (nffeq_occ_fliinv==0 & nffeq_occ_vocc==0 ){
          cat(paste0("\n","         ","PASS! NO CASE SENSITIVITY PROBLEM IS FOUND!","\n"))  }
        
        
        #Test c:
         
        fliinv_vcc_dif = data.table(sqlQuery(dbHandle,paste0("           
        (select distinct MAPCCLSSIF,MAPCCTIER1,MAPCCTIER2,MAPCCTIER3 from ",ppfliinvcc," except(
            select distinct MAPCCLSSIF,MAPCCTIER1,MAPCCTIER2,MAPCCTIER3 from ",ppvcccc,"))
        union 
        (select distinct MAPCCLSSIF,MAPCCTIER1,MAPCCTIER2,MAPCCTIER3 from ",ppvcccc," except(
          select distinct MAPCCLSSIF,MAPCCTIER1,MAPCCTIER2,MAPCCTIER3 from ",ppfliinvcc,"))
                                                   ")))
        
        nfliinv_vcc_dif=nrow(fliinv_vcc_dif)
        
        if (nfliinv_vcc_dif!=0){
          cat(paste0("FAIL! Number of records where records does not match between fliinv and vocc tables = ",nfliinv_vcc_dif,"\n"))
          cat(paste0("         ","Difference(s) between the fliinv and vcc include following Record(s):","\n"))
          print(fliinv_vcc_dif)
        } else { cat(paste0("         ","PASS! ALL Records matched between fliinv and vcc tables!","\n"))  }
        
        
        #Test d:
        
        fliinv_vgeo_dif = data.table(sqlQuery(dbHandle,paste0("           
        (select distinct a.INV_KEY
				from ",ppvgeocc," a
				except
				select distinct b.INV_KEY 
				from ",ppfliinvcc," b)
				union 
				(select distinct b.INV_KEY 
				from ",ppfliinvcc," b
				except
				select distinct a.INV_KEY 
				from ",ppvgeocc," a	)
                               ")))
        
    
        nfliinv_vgeo_dif=nrow(fliinv_vgeo_dif)
        
        if (nfliinv_vgeo_dif!=0){
          cat(paste0("FAIL! Number of records where INV_KEY does not match between fliinv and VGEO tables = ",nfliinv_vgeo_dif,"\n"))
          cat(paste0("         ","Difference(s) between the fliinv and VGEO include following INV_KEY(s):","\n"))
          cat(paste0("         ",fliinv_vgeo_dif$INV_KEY))
        } else { cat(paste0("         ","PASS! ALL INV_KEY matched between fliinv and VGEO tables!","\n"))  }
        
        
        
        
        
        }
        else { cat(paste0("         ","Does not have FF peril!","\n"))}
      }
    }
  }
}  


####Test-20: All secondary modifiers should have options.
Test_20 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppmdsccc=paste0(Perils[j],"mdsc",Countries[i],collapse="")
        ppodsccc=paste0(Perils[j],"odsc",Countries[i],collapse="")
        
        
        
        
        nooptionfields = data.table(sqlQuery(dbHandle,paste0("   
          select * from ",ppmdsccc," a
          left join ",ppodsccc," b
          on a.MODIF_NUM=b.MODIF_NUM
          where OPTION_NUM is null")))

        
        Nnooptionfields=nrow(nooptionfields)
        
        if (Nnooptionfields!=0){
          cat(paste0("FAIL! Number of modif pdc fileds with no option= ",Nnooptionfields,"\n"))

        } else { cat(paste0("         ","PASS! ALL Modif PDCs have options.","\n"))  }
      }
    }
  }
}  


####Test-21: DC_Key between VHAZ and VGEO tables
Test_21 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
        ppvhazcc=paste0(Perils[j],"vhaz",Countries[i],collapse="")
        
        
        
        
        vgeo_vhaz_dif = data.table(sqlQuery(dbHandle,paste0("   select distinct DC_KEY from ",ppvhazcc," where DC_KEY not in 
(select distinct DC_KEY from ",ppvgeocc,") 
                                                           ")))
        
        nvgeo_vhaz_dif=nrow(vgeo_vhaz_dif)
        
        if (nvgeo_vhaz_dif!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nvgeo_vhaz_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vgeo and vhaz include following INV_KEY(s):","\n"))
          cat(paste0("         ",vgeo_vhaz_dif$DC_KEY))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}  

####Test-22: CONSISTENCY OF BI_KEY BETWEEN VGEO AND OTHER BI RELATED TABLES (KEY IS BI_KEY)
Test_22 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcccc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
        
        BI_RELATED_TABLES=data.table(sqlQuery(dbHandle,paste0("  select t.name FROM sys.columns c
        JOIN sys.tables t ON c.object_id = t.object_id
        where c.name LIKE 'BI_KEY' and left(t.name,5) like '%",Perils[j],"%' and right(t.name,2) like '%",Countries[i],"%'")))
        nBItables=length(BI_RELATED_TABLES$name)
		print("BI Related tables are :")
		print(BI_RELATED_TABLES)
        DISTINCT_BI=data.table(sqlQuery(dbHandle,paste0("  select distinct bi_key from ",ppvcccc)))
        
		    Diff_Table= vector()
        BI_KEY_SENSITIVITY= vector()
        
        Sensitivity_diff=CaseCheck(ppvcccc,'bi_key')
        nSensitivity_diff=nrow(Sensitivity_diff)      
        if (nSensitivity_diff!=0){BI_KEY_SENSITIVITY<- c(BI_KEY_SENSITIVITY,ppvcccc)}
        
        
        for (k in 1:nBItables)
        {
          itr_DISTINCT_BI=data.table(sqlQuery(dbHandle,paste0("  select distinct bi_key from ",BI_RELATED_TABLES$name[k])))
          if (all(length(DISTINCT_BI$bi_key)==length(itr_DISTINCT_BI$bi_key)) && length(itr_DISTINCT_BI$bi_key)!=0)
          {if (!(all(tolower(DISTINCT_BI$bi_key)==tolower(itr_DISTINCT_BI$bi_key))))
          {
            Diff_Table<- c(Diff_Table,BI_RELATED_TABLES[k])
            
          }
          } else {
            Diff_Table<- c(Diff_Table,BI_RELATED_TABLES[k])
          }
          
          Sensitivity_diff=CaseCheck(BI_RELATED_TABLES$name[k],'bi_key')
          nSensitivity_diff=nrow(Sensitivity_diff)      
          if (nSensitivity_diff!=0){BI_KEY_SENSITIVITY<- c(BI_KEY_SENSITIVITY,BI_RELATED_TABLES[k])}
          
        }
        
        nBI_KEY_SENSITIVITY=length(BI_KEY_SENSITIVITY)
        nDiff_Table=length(Diff_Table)
        
        
        
        if (nDiff_Table!=0){
          cat(paste0("         ","FAIL! Number of tables with different BI_KEYS= ",nDiff_Table,"\n"))
          cat(paste0("         ","Distinct BI_KEYs in the following table(s) does not match distinct BI_KEYS in VGEO table:","\n"))
          cat(paste0("         ",Diff_Table$name,"\n"))
          
        } else { cat(paste0("         ","PASS! BI_KEY IN ALL TBALES MATCHED!","\n"))  }
        
        
        if (nBI_KEY_SENSITIVITY!=0){
          cat(paste0("         ","BI_KEY in following tables have case sensitivity problem:","\n"))
          cat(paste0("         ",BI_KEY_SENSITIVITY$name,"\n"))
          
        } else { cat(paste0("         ","PASS! No CASE SENSITIVITY PROBLEM IN BI_KEYs IS FOUND!","\n"))  }
        
        
        
      }
    }
  }
}  

####Test-23. For every record in IMAP, there should be one record in VRS
Test_23 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      if (tolower(Perils[j]) %in% sets$Test23$Perils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvrscc=paste0(Perils[j],"vrs",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        
        vrs_imap_dif = data.table(sqlQuery(dbHandle,paste0("  
select distinct INV_RECNUM from ",ppimapcc," where INV_RECNUM not in 
(select distinct INV_RECNUM from ",ppvrscc,") ")))
        
        nvrs_imap_dif=nrow(vrs_imap_dif)
        
        if (nvrs_imap_dif!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nvrs_imap_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vrs and imap include following INV_KEY(s):","\n"))
          cat(paste0("         ",vrs_imap_dif$INV_RECNUM))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
    }
  }
}  

####TEST-24: Test in VDC if dam > 100%. Also test if the maximum damage of any given curve is very small ( < 1 or so)
Test_24 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])   
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvdc0cc=paste0(Perils[j],"vdc0",Countries[i],collapse="")
        ppvhazcc=paste0(Perils[j],"vhaz",Countries[i],collapse="")
        ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")
        
        
        
        
        vdcbiggerthan100 = data.table(sqlQuery(dbHandle,paste0(" select ",ppvhazcc,".DC_KEY,",ppvdc0cc,".PDC_NUM,",ppvhazcc,".CGHS_ID,max(",ppvdc0cc,".DAMAGE_PCT) as 'Max_Damage'
from ",ppvdc0cc,"
inner join ",ppvhazcc," on ",ppvhazcc,".HAZPARAMID=",ppvdc0cc,".HAZPARAMID
group by PDC_NUM,DC_KEY,CGHS_ID
having max(",ppvdc0cc,".DAMAGE_PCT)>100 ")))
        
        nvdcbiggerthan100=nrow(vdcbiggerthan100)
        
        if (nvdcbiggerthan100!=0){
          cat(paste0("         ","FAIL! Number of vdc0 curves with max number more than 100% = ",nvdcbiggerthan100,"\n"))
          cat(paste0("         ","Sample of records with max number more than 100%  :","\n"))
          cat(paste0("         ",vdcbiggerthan100))          
        } else { cat(paste0("         ","PASS! MAXIMUM IN ALL RECORDS IS LESS THAN 100%!","\n"))  }
      
      
      
        
        vdclessthan1 = data.table(sqlQuery(dbHandle,paste0("select ",ppvhazcc,".DC_KEY,",ppvdc0cc,".PDC_NUM,",ppvhazcc,".CGHS_ID,max(",ppvdc0cc,".DAMAGE_PCT) as 'Max_Damage'
from ",ppvdc0cc,"
inner join ",ppvhazcc," on ",ppvhazcc,".HAZPARAMID=",ppvdc0cc,".HAZPARAMID
group by PDC_NUM,DC_KEY,CGHS_ID
having max(",ppvdc0cc,".DAMAGE_PCT) <1 ")))
        
        nvdclessthan1=nrow(vdclessthan1)
        
        if (nvdclessthan1!=0){
          cat(paste0("         ","WARNING! Number of vdc0 curves with min number less than 1% = ",nvdclessthan1,"\n"))
          cat(paste0("         ","A sample of records with min number less than 1%  :","\n"))
          cat(paste0("         ","DC_KEY  PDC_NUM CGHS_ID Max_Damage","\n"))    
          cat(paste0("         ",vdclessthan1[1,],sep="\t"))          
          
          vdcAgglessthan1 = data.table(sqlQuery(dbHandle,paste0("select  distinct s.HAZ_TYPE,s.HAZ_SCALE, COUNT(s.HAZ_TYPE) [Count] from 
(
select c.HAZ_TYPE,c.HAZ_SCALE,a.DC_KEY,b.PDC_NUM,a.CGHS_ID,max(b.DAMAGE_PCT) as 'Max_Damage',MIN(a.HAZPARAMID) [HazParamID_Min],MAX(b.HAZPARAMID)[HazParamID_Max], MAX(a.HAZPARAMID)-MIN(a.HAZPARAMID)+1 [Count]
from ",ppvhazcc," a
inner join ",ppvdc0cc," b on a.HAZPARAMID=b.HAZPARAMID
inner join ",ppcghscc," c on a.CGHS_ID=c.CGHS_ID 
group by HAZ_TYPE,a.CGHS_ID,PDC_NUM,DC_KEY,HAZ_SCALE
having max(b.DAMAGE_PCT) <=1
) s
group by HAZ_TYPE,HAZ_SCALE
order by s.HAZ_TYPE")))
          cat("\n")
#           cat(paste0(colnames(vdcAgglessthan1),"\t"))
#           cat("\n")
#           for (i in 1:nrow(vdcAgglessthan1)) {cat(paste0("\t",vdcAgglessthan1[i,]),"\n")}
#           tt2 <- ttheme_minimal()
#           cat(grid.table(vdcAgglessthan1,theme=tt2))
          
          print(vdcAgglessthan1)
cat("\n")
          
          
          
          
          
          
          
          
        } else { cat(paste0("         ","PASS! MINIMUM IN ALL RECORDS IS MORE THAN 1%!","\n"))  }
      
      }
    } 
    
  }
}

####Test-25. PDC alternative test
####a- Test Completeness of data
####b- test that vdc2<=vdc0<=vdc1
Test_25 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  
  
  for (i in 1:nCountries)
  {
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    for (j in 1:nPerils){
      if (!(tolower(Perils[j]) %in% sets$Test25$Perils)){
        Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvdc0cc=paste0(Perils[j],"vdc0",Countries[i],collapse="")
        ppvdc1cc=paste0(Perils[j],"vdc1",Countries[i],collapse="")
        ppvdc2cc=paste0(Perils[j],"vdc2",Countries[i],collapse="")
        if (tolower(ppvdc1cc) %in% tolower(Tables_Required)){
        
        
        
        Completeness = data.table(sqlQuery(dbHandle,paste0("  select * from ", ppvdc0cc," a
                                                              full outer join ", ppvdc1cc," b 
                                                              on a.pdc_num=b.pdc_num and a.hazparamid=b.hazparamid
                                                              full outer join ", ppvdc2cc," c
                                                              on a.pdc_num=c.pdc_num and a.hazparamid=c.hazparamid 
                                                              where a.damage_pct is null or b.damage_pct is null or c.damage_pct is null")))
        
        nCompleteness=nrow(Completeness)
        
        if (nCompleteness!=0){
          cat(paste0("         ","FAIL! vdc0, vdc1, and vdc2 tables do not have the same number or records!","\n"))
          cat(paste0("         ","Number of unmatched records: ",nCompleteness,"\n"))    
        } else { cat(paste0("         ","PASS! vdc0, vdc1, and vdc2 tables have the same number or records","\n"))  }

        
        OrderCheck = data.table(sqlQuery(dbHandle,paste0("  select * from ", ppvdc0cc," a
                                                              join ", ppvdc1cc," b 
                                                              on a.pdc_num=b.pdc_num and a.hazparamid=b.hazparamid
                                                              join ", ppvdc2cc," c
                                                              on a.pdc_num=c.pdc_num and a.hazparamid=c.hazparamid 
                                                              where a.damage_pct > b.damage_pct or  a.damage_pct< c.damage_pct")))
        
        nOrderCheck=nrow(OrderCheck)
        
        if (nOrderCheck!=0){
          cat(paste0("         ","FAIL! for all curves the relation vdc2<=vdc0<=vdc1 is NOT satisfied!","\n"))
          cat(paste0("         ","Number of unmatched records: ",nOrderCheck,"\n"))  
          } else { cat(paste0("         ","PASS! For all curves the relation vdc2<=vdc0<=vdc1 is satisfied!","\n"))  }
        




      }
    }
    }
  }
  }  
}

##TEST-26:TEST VLIFELINEBIDC TABLE IS MONOTONICALLY INCREASING
####### TEST VLIFELINEBIDC
Test_26 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,tables,VulnDb_ExpectedTables,NGTableExist){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  cat(paste0("\n","CHECK RISKLINK TABLES: ","\n"))
  for (i in 1:nCountries)
  {
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    for (j in 1:nPerils){
      ppvlifelinebidccc=paste0(Perils[j],"vlifelinebidc",Countries[i],collapse="")
	  Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      #if (length(Tables_Required)!=0) {
	  if (ppvlifelinebidccc %in% Tables_Required) {
        dummyname=paste0("'",Countries[i],"'",collapse="")
        #ppvlifelinebidccc=paste0(Perils[j],"vlifelinebidc",Countries[i],collapse="")
# ppvlifelinebidccc="eqvlifelinebidcus"
        
        
        vlifelinebidc = sqlQuery(dbHandle, paste0("select * from ",ppvlifelinebidccc))
        vlifelinebidc = data.table(vlifelinebidc)
        vlifelinebidc_Ordered=vlifelinebidc[order(LLDC_Id,Hazard)]
# Check if hazard is monotonically increasing       
        vlifelinebidcDx <- vlifelinebidc[,.(difference = diff(Hazard)),by=c("LLDC_Id")]
        nvlifelinebidcDx=nrow(vlifelinebidcDx[difference<0])

        if (nvlifelinebidcDx!=0){
          cat(paste0("         ","FAIL! Number of curves that Hazard axis is not motonically increasing=",nvlifelinebidcDx,"\n"))
          x=vlifelinebidcDx[difference<0]
          cat(paste0("LLDC_IDs are :","\n"))
          print(unique(x$LLDC_Id))
          
        } else { cat(paste0("         ","PASS! HAZARD AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!","\n"))  }

# Check if MDR is monotonically increasing
        vlifelinebidcDy <- vlifelinebidc_Ordered[,.(difference = diff(MDR)),by =LLDC_Id]
        nvlifelinebidcDy=nrow(vlifelinebidcDy[difference<0])

        if (nvlifelinebidcDy!=0){
          cat(paste0("FAIL! Number of curves that MDR axis is not motonically increasing=",nvlifelinebidcDy,"\n"))
          x=vlifelinebidcDy[difference<0]
          cat(paste0("LLDC_IDs are :","\n"))
          print(unique(x$LLDC_Id))
          
        } else { cat(paste0("         ","PASS! MDR AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!","\n"))  }     
                
                
      }
    }
  }
  
  
  if (NGTableExist){
    
    cat(paste0("\n","\n","CHECK NG TABLES: ","\n"))
    
    vlifelinebidc = sqlQuery(dbHandle, "select * From vlifelinebidc")
    vlifelinebidc = data.table(vlifelinebidc)
    vlifelinebidc_Ordered=vlifelinebidc[order(country,LLDC_Id,Hazard)] 
    
    # Check if hazard is monotonically increasing       
    vlifelinebidcDHaz <- vlifelinebidc[,.(difference = diff(Hazard)),by=c("country","LLDC_Id")]
    nvlifelinebidcDHaz=nrow(vlifelinebidcDHaz[difference<0])
    
    
    if (nvlifelinebidcDHaz!=0){
      cat(paste0("         ","FAIL! Number of curves that Hazard axis is not motonically increasing=",nvlifelinebidcDHaz,"\n"))
      x=data.table(vlifelinebidcDHaz[difference<0])
      x=x[order(x$country)] 
      x=data.frame(x)
      cat(paste0("LLDC_IDs are :","\n"))
      print(unique(x[c("country","LLDC_Id")]))
      
    } else { cat(paste0("         ","PASS! HAZARD AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!","\n"))  }    
    
    
    
    #Check if MDR is monotonically increasing
    vlifelinebidcDy <- vlifelinebidc_Ordered[,.(difference = diff(MDR)),by=c("country","LLDC_Id")]
    nvlifelinebidcDy=nrow(vlifelinebidcDy[difference<0])
    
    if (nvlifelinebidcDy!=0){
      cat(paste0("         ","FAIL! Number of curves that MDR axis is not motonically increasing=",nvlifelinebidcDy,"\n"))
      x=data.table(vlifelinebidcDy[difference<0])
      x=x[order(x$country)] 
      x=data.frame(x)
      cat(paste0("LLDC_IDs are :","\n"))
      print(unique(x[c("country","LLDC_Id")]))
      
    } else { cat(paste0("         ","PASS! MDR AXIS  ON ALL CURVES ARE MONOTONICALLY INCREASING!","\n"))  }     
    
    
    
    
    
  }
}

####Test-27. MINIMUM VALUE OF MDR IN CV CURVES SHOULD START FROM ZERO AND MAXIMUM SHOULD BE ABOVE 100
Test_27 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])  
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcvcc=paste0(Perils[j],"vcv",Countries[i],collapse="")
        
        
        
        if (tolower(Perils[j] %in% c("hu","fl"))){
        vcv_problem = data.table(sqlQuery(dbHandle,paste0("
                                                            select CGHS_ID,CV_KEY,min(MDR) as 'MIN(MDR)',max(MDR) as 'MAX(MDR)' from ",ppvcvcc," group by CGHS_ID,CV_KEY
                                                            having min(MDR)!=0 or max(MDR)<100")))
        } else {
        vcv_problem = data.table(sqlQuery(dbHandle,paste0("
                                                            select CGHS_ID,CV_KEY,min(MDR) as 'MIN(MDR)',max(MDR) as 'MAX(MDR)' from ",ppvcvcc," group by CGHS_ID,CV_KEY
                                                            having min(MDR)!=0 or max(MDR)<=100")))		
				}
        nvcv_problem=nrow(vcv_problem)
        
        if (nvcv_problem!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nvcv_problem,"\n"))
          cat(paste0("         ","Records that do not pass the criteria are as follows:","\n"))
          print(vcv_problem)
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
} 

####Test-28. Number of secondary modifier options in ODSC table should not exceed the maximum number specified in the specification
Test_28 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  MaxSecondModOptions=data.table(read.csv('data/SecondModifCapOption.csv'))
  names(MaxSecondModOptions)=c("PERIL","MODIF_NUM","MAXOPTIONCOUNT","DESC")
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])     
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppodsccc=paste0(Perils[j],"odsc",Countries[i],collapse="")
        
        
        
        
        Modif_Options = data.table(sqlQuery(dbHandle,paste0("   
                                                             select MODIF_NUM,count(*) as NumOfOptions from ",ppodsccc,"
                                                             Group by MODIF_NUM"
                                                             
                                                             )))
        
        if (nrow(Modif_Options)==0) {cat(paste0("         ","WARNING! There is no modifier option provided for this model.","\n"))  } 
          else{
        
        MaxSecondModOptions_1=MaxSecondModOptions[PERIL==toupper(Perils[j]),]
        joinodscandmax=merge(Modif_Options,MaxSecondModOptions_1,by = "MODIF_NUM")
        maxoptionsviolations=joinodscandmax[joinodscandmax$NumOfOptions>joinodscandmax$MAXOPTIONCOUNT,]
        Nmaxoptionsviolations=nrow(maxoptionsviolations)
        
        if (Nmaxoptionsviolations!=0){
          cat(paste0("FAIL! Number of modif PDCs that have more than allowable options  = ",Nmaxoptionsviolations,"\n"))
          print(maxoptionsviolations)
        } else {cat(paste0("         ","PASS! ALL Modif PDCs have less options than allowable number of options.","\n"))  }
          }
        }
    }
  }
}

####Test-29  Consistency of x_CLASSIF and x_CLASS values across all perils for each country.

Test_29 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    CountryPerils={}
    for (k in 1:nPerils){
      ppvcccc=paste0(Perils[k],"vcc",Countries[i],collapse="")
      
      Table_exist =data.table(sqlQuery(dbHandle,paste0("IF EXISTS (SELECT 1 
                                                       FROM INFORMATION_SCHEMA.TABLES 
                                                       WHERE TABLE_NAME='",ppvcccc,"') 
                                                       SELECT 1 AS res ELSE SELECT 0 AS res;")))
      if (Table_exist[1]==1){
        CountryPerils=c(CountryPerils,Perils[k])
      }
      
      
    }
    
    cat(paste0("\n",toupper(Countries[i]),":","\n"))
    cat(paste0("\n","Country Perils are: ","\n"))
    print(CountryPerils)
    ppvcccc_base=paste0(CountryPerils[1],"vcc",Countries[i],collapse="") # All vcc tables will be tested against this table
    ppvocccc_base=paste0(CountryPerils[1],"vocc",Countries[i],collapse="") # All vocc tables will be tested against this table
    if (length(CountryPerils)>1){
      for (j in 2:  length(CountryPerils)){
        
        
        
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcccc=paste0(CountryPerils[j],"vcc",Countries[i],collapse="")
        
        
        
        Completeness = data.table(sqlQuery(dbHandle,paste0(" 
     
        select distinct a.c_Classif, a.c_class,b.c_Classif, b.c_class from ",ppvcccc_base," a
        full outer join  ",ppvcccc," b
        on a.C_CLASSIF=b.C_CLASSIF and a.C_CLASS=b.C_CLASS
        where a.C_CLASS is null or b.C_CLASS is null
        ")))
        
        
        
        Completeness <- Completeness[!(c_Classif.1 %in% sets$Test29$c_Classif | c_Classif %in% sets$Test29$c_Classif),]
        
        nCompleteness=nrow(Completeness)
        
        if (nCompleteness!=0){
          cat(paste0("         ","FAIL! c_class and c_classif values are not consistent between ",ppvcccc_base," and ",ppvcccc," tables","\n"))
          print(Completeness)
          
        } else { cat(paste0("         ","PASS! c_class and c_classif values are consistent between ",ppvcccc_base," and ",ppvcccc," tables","\n"))  }
        
        
        ppvocccc=paste0(CountryPerils[j],"vocc",Countries[i],collapse="")
        
        Completeness = data.table(sqlQuery(dbHandle,paste0(" select distinct a.o_Classif, a.o_class,b.o_Classif, b.o_class from ",ppvocccc_base," a
        full outer join  ",ppvocccc," b
        on a.o_CLASSIF=b.o_CLASSIF and a.o_CLASS=b.o_CLASS
        where a.o_CLASS is null or b.o_CLASS is null
        ")))
        
        Completeness <- Completeness[!(o_Classif  %in% sets$Test29$o_Classif | o_Classif.1 %in% sets$Test29$o_Classif),]
        nCompleteness=nrow(Completeness)
        
        if (nCompleteness!=0){
          cat(paste0("         ","FAIL! o_class and o_classif values are not consistent between ",ppvocccc_base," and ",ppvocccc," tables","\n"))
          print(Completeness)
        } else { cat(paste0("         ","PASS! o_class and o_classif values are consistent between ",ppvocccc_base," and ",ppvocccc," tables","\n"))  }
        
        
      }
    } else { cat(paste0("         ","Database only includes one peril for this country.")) }
    
}
  }

#### TEST-30:TEST VGEO vs NGGeography
Test_30 <- function (dbHandle,dbHandle2,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  
  # Check for duplicates in postal codes
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])      
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
    
    
    #Read lookup table for a country 
        FieldLookup=data.table(sqlQuery(dbHandle2,paste0("select * from FieldLookup where ISO2=",dummyname),as.is=T))
        if (nrow(FieldLookup)==0){
          cat(paste0("         ","WARNING! Country is not found in the Fieldlookup table.","\n"))
        } else{
    #Read VGEO
        vgeo=data.table(sqlQuery(dbHandle,paste0("select * from ", ppvgeocc),as.is=T))
    #Test Cresta
        cat(paste0("         ","CRESTA:","\n"))
        Cresta=data.table(cresta=na.omit(unique(vgeo$CRESTA)))
        if(!is.na(FieldLookup$CRESTA)){
          if (nrow(Cresta)!=0){
          crestatable=paste0(FieldLookup$CRESTA,"geolookup",collapse = "")
          NGCresta=data.table(sqlQuery(dbHandle2,paste0("select CODE from ",crestatable, " where ISO2=",dummyname),as.is=T))
          CrestaDiff=Cresta[!(Cresta$cresta %in% NGCresta$CODE)]
          if (nrow(CrestaDiff)!=0){
            cat(paste0("         ","FAIL! ",nrow(CrestaDiff)," out of ",nrow(Cresta), " distinct Cresta in VGEO are not found in NG-Geography.","\n"))
            print(CrestaDiff)
          } else {
            cat(paste0("         ","PASS! all distinct Crestas in VGEO Table are found in NG-Geography database.","\n"))
          } }  else {
            cat(paste0("         ","VGEO table does not include cresta data for ",dummyname,"\n"))
          }
        } else {cat(paste0("         ","NG-Geography does not include cresta data for ",dummyname,"\n"))}
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
    
        #Test SubCresta
        cat(paste0("         ","SUB-CRESTA:","\n"))
        SubCresta = data.table(subcresta = na.omit(unique(vgeo$SUB_CRESTA)))
        if (!is.na(FieldLookup$SUBCRESTA)) {
          if (nrow(SubCresta)!=0){
          subcrestatable = paste0(FieldLookup$SUBCRESTA,"geolookup",collapse = "")
          NGSubCresta    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",subcrestatable, " where ISO2=",dummyname),as.is=T))
          subCrestaDiff  = SubCresta[!(SubCresta$subcresta %in% NGSubCresta$CODE)]
          
          if (nrow(subCrestaDiff)!=0){
            cat(paste0("         ","FAIL! ",nrow(subCrestaDiff)," out of ",nrow(SubCresta), " distinct SubCresta in VGEO are not found in NG-Geography.","\n"))
            print(subCrestaDiff)
          } else {
            cat(paste0("         ","PASS! All distinct Sub-Crestas in VGEO Table are found in NG-Geography database.","\n"))
          } }else {
            cat(paste0("         ","VGEO table does not include subcresta data for ",dummyname,"\n"))
          }
        } else {
            cat(paste0("         ","NG-Geography does not include subcresta data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        

        
        #Test County
        cat(paste0("         ","County:","\n"))
        County = data.table(Code = na.omit(unique(vgeo$COUNTYNUM)))
        if (!is.na(FieldLookup$COUNTYCODE)) {
          if (nrow(County)!=0){
            Countytable = paste0(FieldLookup$COUNTYCODE,"geolookup",collapse = "")
            NGCounty    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",Countytable, " where ISO2=",dummyname),as.is=T))
            CountyDiff  = County[!(County$Code %in% NGCounty$CODE)]
            
            if (nrow(CountyDiff)!=0){
              cat(paste0("         ","FAIL! ",nrow(CountyDiff)," out of ",nrow(County), " distinct County in VGEO are not found in NG-Geography.","\n"))
              print(CountyDiff)
            } else {
              cat(paste0("         ","PASS! All distinct county in VGEO Table are found in NG-Geography database.","\n"))
            } }else {
              cat(paste0("         ","VGEO table does not include County data for ",dummyname,"\n"))
            }
        } else {
          cat(paste0("         ","NG-Geography does not include County data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        
        
        #Test City
        cat(paste0("         ","City:","\n"))
        City = data.table(Code = na.omit(unique(vgeo$CITYCODE)))
        if (!is.na(FieldLookup$CITYCODE)) {
          if (nrow(City)!=0){
            Citytable = paste0(FieldLookup$CITYCODE,"geolookup",collapse = "")
            NGCity    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",Citytable, " where ISO2=",dummyname),as.is=T))
            CityDiff  = City[!(City$Code %in% NGCity$CODE)]
            
            if (nrow(CityDiff)!=0){
              cat(paste0("         ","FAIL! ",nrow(CityDiff)," out of ",nrow(City), " distinct City Code in VGEO are not found in NG-Geography.","\n"))
              print(CityDiff)
            } else {
              cat(paste0("         ","PASS! All distinct City in VGEO Table are found in NG-Geography database.","\n"))
            } }else {
              cat(paste0("         ","VGEO table does not include Citycode data for ",dummyname,"\n"))
            }
        } else {
          cat(paste0("         ","NG-Geography does not include Citycode data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        
        
        
        #Test Postal Code
        cat(paste0("         ","PostalCode:","\n"))
        PostalCode = data.table(Code = na.omit(unique(vgeo$POSTALCODE)))
        if (!is.na(FieldLookup$POSTALCODE)) {
          if (nrow(PostalCode)!=0){
            if (FieldLookup$POSTALCODE!="loc")
            {PostalCodetable = paste0(FieldLookup$STATECODE,"geolookup",collapse = "")
             NGPostalCode    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",PostalCodetable, " where ISO2=",dummyname),as.is=T))}
            else {
            NGPostalCode    = data.table(sqlQuery(dbHandle2,paste0("select LOCNCODE from locationcode where RMSCOUNTRY=",dummyname),as.is=T))
            names(NGPostalCode)="CODE"
            }

            PostalCodeDiff  = PostalCode[!(PostalCode$Code %in% NGPostalCode$CODE)]
            
            if (nrow(PostalCodeDiff)!=0){
              cat(paste0("         ","FAIL! ",nrow(PostalCodeDiff)," out of ",nrow(PostalCode), " distinct PostalCode Code in VGEO are not found in NG-Geography.","\n"))
              print(PostalCodeDiff)
            } else {
              cat(paste0("         ","PASS! All distinct PostalCodes in VGEO Table are found in NG-Geography database.","\n"))
            } }else {
              cat(paste0("         ","VGEO table does not include PostalCode data for ",dummyname,"\n"))
            }
        } else {
          cat(paste0("         ","NG-Geography does not include PostalCode data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        
        
        
         
        #Test State
        cat(paste0("         ","STATE:","\n"))
        State = data.table(Code = na.omit(unique(vgeo$STATE)))
        if (!is.na(FieldLookup$STATECODE)) {
          if (nrow(State)!=0){

            if (FieldLookup$STATECODE!="loc")
            {Statetable = paste0(FieldLookup$STATECODE,"geolookup",collapse = "")
            NGState    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",Statetable, " where ISO2=",dummyname),as.is=T))}
            else {
              NGState    = data.table(sqlQuery(dbHandle2,paste0("select LOCNCODE from locationcode where RMSCOUNTRY=",dummyname),as.is=T))
              names(NGState)="CODE"
            }
            
            StateDiff  = State[!(State$Code %in% NGState$CODE),]
            
            if (nrow(StateDiff)!=0){
              cat(paste0("         ","FAIL! ",nrow(StateDiff)," out of ",nrow(State), " distinct State in VGEO are not found in NG-Geography.","\n"))
              print(StateDiff)
            } else {
              cat(paste0("         ","PASS! All distinct states in VGEO Table are found in NG-Geography database.","\n"))
            } }else {
              cat(paste0("         ","VGEO table does not include State data for ",dummyname,"\n"))
            }
        } else {
          cat(paste0("         ","NG-Geography does not include State data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        
        
        
        #Test Locncode
        cat(paste0("         ","Locncode:","\n"))
        Locncode = data.table(Code = na.omit(unique(vgeo$LOCNCODE)))
        if (!is.na(FieldLookup$LOCNCODE)) {
          if (nrow(Locncode)!=0){
            
            if (FieldLookup$LOCNCODE!="loc")
            {Locncodetable = paste0(FieldLookup$LOCNCODE,"geolookup",collapse = "")
            NGLocncode    = data.table(sqlQuery(dbHandle2,paste0("select CODE from ",Locncodetable, " where ISO2=",dummyname),as.is=T))}
            else {
              NGLocncode    = data.table(sqlQuery(dbHandle2,paste0("select LOCNCODE from locationcode where RMSCOUNTRY=",dummyname),as.is=T))
              names(NGLocncode)="CODE"
            }
            
            LocncodeDiff  = Locncode[!(Locncode$Code %in% NGLocncode$CODE),]
            
            if (nrow(LocncodeDiff)!=0){
              cat(paste0("         ","FAIL! ",nrow(LocncodeDiff)," out of ",nrow(Locncode), " distinct Locncode in VGEO are not found in NG-Geography.","\n"))
              print(LocncodeDiff)
            } else {
              cat(paste0("         ","PASS! All distinct Locncodes in VGEO Table are found in NG-Geography database.","\n"))
            } }else {
              cat(paste0("         ","VGEO table does not include Locncode data for ",dummyname,"\n"))
            }
        } else {
          cat(paste0("         ","NG-Geography does not include Locncode data for ",dummyname,"\n"))
        }
        cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))
        
        # Check for the wild card at the end
        cat(paste0("         ","Check if wild card exist and is the last record in RL-vgeo table:","\n"))
       
          wild_card=data.table(sqlQuery(dbHandle, paste0("SELECT GEO_RECNUM  FROM ",ppvgeocc,"
                                                         where 
                                                         STATE is NULL
                                                         and CRESTA is NULL
                                                         and [SUB_CRESTA]is NULL
                                                         and COUNTYNUM is NULL
                                                         and [CITY]is NULL
                                                         and [POSTALCODE]is NULL
                                                         and [DC_KEY] is not null 
                                                         and [INV_KEY] is not null 
                                                         and [CITYCODE]is NULL
                                                         and BI_KEY is not null 
                                                         and [LOCNCODE]is NULL
                                                         and DSTRCTCODE is NULL
                                                         and LOCNCODE is NULL")))
                                                           
                                                     
    LastRecord = data.table(sqlQuery(dbHandle, paste0("SELECT max(GEO_RECNUM) as GEO_RECNUM FROM ",ppvgeocc)))                                     
                                                 
    
    if (nrow(wild_card) !=1){
      cat(paste0("         ","FAIL! VGEO TABLE DOES NOT INCLUDE THE WILD CARD"))
    } else if (wild_card!=LastRecord){
      cat(paste0("         ","FAIL! WILD CARD is not the last record in VGEO table"))
    } else 
    {
      cat(paste0("         ","PASS! VGEO TABLE INCLUDES THE WILD CARD and it is the last record"))
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"))

        
        
        
        
        }
      }
      }
  }
}

####Test-31  Test if summation of def_invpct in inv table adds up to 100

Test_31 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      if ((tolower(Perils[j]) %in% sets$Test31$Perils)){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        ppvinvcc=paste0(Perils[j],"vinv",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        if (!is.na(sets$Test31$InvKey))
          {
          invs=paste0(sets$Test31$InvKey, collapse = " , ")
          cat(paste0("         ","This INV_OCC(s) is/are not considered in this query: ",invs, "\n"))
            condition = paste0(" and b.INV_OCC not like ('",sets$Test31$InvKey,"')",collapse = "")
          }
        
        
        
        nvin= data.table(sqlQuery(dbHandle,paste0(" select count(*) from ", ppvinvcc)))
        
		if (NGTableExist & tolower(Perils[j])=="eq"){
        vinv_not100_dif = data.table(sqlQuery(dbHandle,paste0(" select g.INV_RECNUM,g.SumPCT,h.SumWeighted, g.INV_OCC,c.O_CLASSIF,c.O_CLASS,c.O_DESC from
                                                                    (select a.INV_RECNUM,b.INV_OCC,sum(def_invpct) as SumPCT from ", ppvinvcc ," a
                                                                    join ", ppimapcc ," b
                                                                    on a.INV_RECNUM=b.INV_RECNUM
                                                                    group by a.INV_RECNUM,b.INV_OCC
                                                                    having ((round(sum(def_invpct),4) !=100) and (round(sum(def_invpct),4) !=200)) 
                                                                    ",condition,") g 
                                                                left join
                                                                    (
                                                                    select d.INV_RECNUM,d.S0+ sum(f.s1) as SumWeighted from 
                                                                      (select INV_RECNUM,PDC_GROUP, sum(DEF_INVPCT) as S0   from ", ppvinvcc ," 
                                                                      group by INV_RECNUM,PDC_GROUP
                                                                      having   PDC_GROUP=0) d
                                                                    left join  
                                                                      (select INV_RECNUM,PDC_GROUP, sum(DEF_INVPCT)/count(*) as S1 from ", ppvinvcc ," 
                                                                      group by INV_RECNUM,PDC_GROUP
                                                                      having  PDC_GROUP!=0) f
                                                                    on d.INV_RECNUM=f.INV_RECNUM
                                                                    group by d.INV_RECNUM,d.S0) h
                                                                on g.inv_recnum=h.inv_recnum
                                                            join ", ppvocccc ," c on 
                                                            g.INV_OCC=c.INV_OCC
                                                            where round(SumWeighted,4)!=100 or SumWeighted is  null
                                                            ")))
        
        } else {
		vinv_not100_dif = data.table(sqlQuery(dbHandle,paste0(" select g.INV_RECNUM,g.SumPCT, g.INV_OCC,c.O_CLASSIF,c.O_CLASS,c.O_DESC
																	from
																	(select a.INV_RECNUM,b.INV_OCC,sum(def_invpct) as SumPCT from ", ppvinvcc ," a
                                                                    join ", ppimapcc ," b
                                                                    on a.INV_RECNUM=b.INV_RECNUM
						                                            group by a.INV_RECNUM,b.INV_OCC
                                                                    having (round(sum(def_invpct),4) !=100) 
                                                                    ",condition,") g
																	 join ", ppvocccc ," c on 
                                                            g.INV_OCC=c.INV_OCC
                                                                                                                       ")))
																	
		}
		nvinv_not100_dif=nrow(vinv_not100_dif)
        
        if (nvinv_not100_dif!=0){
          cat(paste0("         ","FAIL! Number of records where def_invpct does not add up to 100 = ",nvinv_not100_dif," out of ", nvin, "\n"))
          print(head(vinv_not100_dif))
          print("Summary:")
          print(vinv_not100_dif[,.N,by=.(INV_OCC,O_DESC)])
          
        } else { cat(paste0("         ","PASS! summation of ALL def_invpct in vinv adds up to 100!","\n"))  }
      }
      } else {
        currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        ppvinvcc=paste0(Perils[j],"vinv",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        if (!is.na(sets$Test31$InvKey))
        {
          invs=paste0(sets$Test31$InvKey, collapse = " , ")
          cat(paste0("         ","This INV_OCC(s) is/are not considered in this query: ",invs, "\n"))
          condition = paste0(" and b.INV_OCC not like ('",sets$Test31$InvKey,"')",collapse = "")
        }
        
        
        
        nvin= data.table(sqlQuery(dbHandle,paste0(" select count(*) from ", ppvinvcc)))
        
        vinv_not100_dif = data.table(sqlQuery(dbHandle,paste0(" select g.INV_RECNUM,g.SumPCT,h.SumWeighted, g.INV_OCC,c.O_CLASSIF,c.O_CLASS,c.O_DESC from
                                                                    (select a.INV_RECNUM,b.INV_OCC,sum(def_invpct) as SumPCT from ", ppvinvcc ," a
                                                                    join ", ppimapcc ," b
                                                                    on a.INV_RECNUM=b.INV_RECNUM
                                                                    group by a.INV_RECNUM,b.INV_OCC
                                                                    having ((round(sum(def_invpct),4) !=100) and (round(sum(def_invpct),4) !=200)) 
                                                                    ",condition,") g 
                                                                left join
                                                                    (
                                                                    select d.INV_RECNUM,d.S0+ sum(f.s1) as SumWeighted from 
                                                                      (select INV_RECNUM, sum(DEF_INVPCT) as S0   from ", ppvinvcc ," 
                                                                      group by INV_RECNUM) d
                                                                    left join  
                                                                      (select INV_RECNUM, sum(DEF_INVPCT)/count(*) as S1 from ", ppvinvcc ," 
                                                                      group by INV_RECNUM) f
                                                                    on d.INV_RECNUM=f.INV_RECNUM
                                                                    group by d.INV_RECNUM,d.S0) h
                                                                on g.inv_recnum=h.inv_recnum
                                                            join ", ppvocccc ," c on 
                                                            g.INV_OCC=c.INV_OCC
                                                            where round(SumWeighted,4)!=100 or SumWeighted is  null
                                                            ")))
        
        nvinv_not100_dif=nrow(vinv_not100_dif)
        
        if (nvinv_not100_dif!=0){
          cat(paste0("         ","FAIL! Number of records where def_invpct does not add up to 100 = ",nvinv_not100_dif," out of ", nvin, "\n"))
          print(head(vinv_not100_dif))
          print("Summary:")
          print(vinv_not100_dif[,.N,by=.(INV_OCC,O_DESC)])
          
        } else { cat(paste0("         ","PASS! summation of ALL def_invpct in vinv adds up to 100!","\n"))  }
      }
    }
      }
  }
}  


####Test-32. Check if the list of distinct values of INV_RECNUM in IMAP table is the same as the list of distinct values of INV_RECNUM in vinv table.
Test_32 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvinvcc=paste0(Perils[j],"vinv",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        
        vinv_imap_dif = data.table(sqlQuery(dbHandle,paste0("  
                                                           select distinct INV_RECNUM from ",ppimapcc," where INV_RECNUM not in 
                                                           (select distinct INV_RECNUM from ",ppvinvcc,") ")))
        
        nvinv_imap_dif=nrow(vinv_imap_dif)
        
        if (nvinv_imap_dif!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nvinv_imap_dif,"\n"))
          cat(paste0("         ","Difference(s) between the vinv and imap include following INV_KEY(s):","\n"))
          cat(paste0("         ",vinv_imap_dif$INV_RECNUM))
          
        } else { cat(paste0("         ","PASS! ALL RECORDS MATCHED!","\n"))  }
      }
    }
  }
}  


####Test-33: CONSISTENCY OF BI_OCC BETWEEN VOCC AND OTHER BI RELATED TABLES (KEY IS BI_OCC)
Test_33 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        
        BI_RELATED_TABLES=data.table(sqlQuery(dbHandle,paste0("  select t.name FROM sys.columns c
                                                              JOIN sys.tables t ON c.object_id = t.object_id
                                                              where c.name LIKE 'BI_OCC' and left(t.name,5) like '%",Perils[j],"%' and right(t.name,2) like '%",Countries[i],"%'")))
        if (Perils[j]=='eq'){
          BI_RELATED_TABLES=BI_RELATED_TABLES[substring(BI_RELATED_TABLES$name,3,5)!="cas"]
        }
        print("NOTE: BI_OCCs related to BR and MARINE are exempted in this test!")
		print("BI Related tables are :")
		print(BI_RELATED_TABLES)
		
		nBItables=length(BI_RELATED_TABLES$name)
        
        
        DISTINCT_BI = data.table(sqlQuery(dbHandle,paste0("  select distinct BI_OCC from ",ppvocccc)))
        
		
        Diff_Table= vector()

        for (k in 1:nBItables)
        {
          Diff_Bi_OCC = data.table(sqlQuery(dbHandle,paste0("  select distinct BI_OCC from ",ppvocccc, " where bi_occ not in (select distinct BI_OCC from ",BI_RELATED_TABLES$name[k],") and bi_occ not in (select distinct BI_OCC from ",ppvocccc," where O_CLASSIF = 'RMSMARINE' or O_CLASSIF like '%BR%')")))
		  
           if (nrow(Diff_Bi_OCC) != 0)
          {
            Diff_Table<- c(Diff_Table,BI_RELATED_TABLES[k])
            
            cat(paste0("\n","\n","         ",BI_RELATED_TABLES[k]$name,": \n"))
            cat(paste0("         ","Missing BI_OCC: \n"))
            cat(paste0("         "))
            cat(paste0(Diff_Bi_OCC$BI_OCC, collapse = ","))
            
          }
         
        }
        
        nDiff_Table = length(Diff_Table)
        
        
        
        if (nDiff_Table!=0){
          cat(paste0("\n\n         ","FAIL! Number of tables with different BI_OCCs= ",nDiff_Table,"\n"))

        } else { cat(paste0("         ","PASS! BI_OCC IN ALL TBALES MATCHED!","\n"))  }
        
        
      }
    }
  }
}  



####Test-34. Check in all colimns in all tables of database to ensure always (From) is smaller than or equal to (To)
Test_34 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  
# Read All tables which has "From" and "To"
  
  ColumnsWithFrom = data.table(sqlQuery(dbHandle,paste0("select * from INFORMATION_SCHEMA.COLUMNS where COLUMN_NAME like '%from%'")))
  ColumnsWithFrom = ColumnsWithFrom[,.(Table = ColumnsWithFrom$TABLE_NAME,ColumnFrom = ColumnsWithFrom$COLUMN_NAME)]
  ColumnsWithFrom$ColumnTo = gsub("FROM", "TO",ColumnsWithFrom$ColumnFrom)
  ColumnsWithFrom$perilcountry= sapply(as.character(ColumnsWithFrom$Table) , PerilCountryFind)
  
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        
        
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        
        ColumnsWithFromPerilCountry = ColumnsWithFrom [perilcountry == currentPerilCountry, ]
        
        for ( k in 1:nrow(ColumnsWithFromPerilCountry)){
          Tablename = ColumnsWithFromPerilCountry[k]$Table
          ColumnFrom = ColumnsWithFromPerilCountry[k]$ColumnFrom
          ColumnTo = ColumnsWithFromPerilCountry[k]$ColumnTo
          
          dif = data.table(sqlQuery(dbHandle,paste0("select * from ",Tablename," where ",ColumnFrom, " > ",  ColumnTo)))
        
        ndif=nrow(dif)
        
        if (ndif!=0){
          cat(paste0("         ","FAIL! Number of records in ",Tablename," where ", ColumnFrom, " > ",  ColumnTo, " = ",  ndif,"\n"))
          cat(paste0("         ",print(dif)))
          
        } else { cat(paste0("         ","PASS! No records in ",Tablename," have ", ColumnFrom, " > ",  ColumnTo,"\n"))  }
        
        
        
        }
        
      }
    }
  }
}  


####Test-35: All BI_OCCs in vbi table should have SD based DSIDs in vds table.(KEY IS BI_OCC)
Test_35 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      if (tolower(Perils[j]) %in% sets$Test23$Perils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvbicc=paste0(Perils[j],"vbi",Countries[i],collapse="")
        ppvdscc=paste0(Perils[j],"vds",Countries[i],collapse="")
        ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")
        
        
        bi_occs_No_SD = data.table(sqlQuery(dbHandle,paste0("   select d.BI_OCC from
                                                                ( 
                                                                select distinct a.BI_OCC from ",ppvbicc," a
                                                                join ",ppvdscc,"  b
                                                                on a.DSTATEID=b.DSTATEID
                                                                join ",ppcghscc," c
                                                                on b.CGHS_ID = c.CGHS_ID 
                                                                where HAZ_SCALE = 'MMI') d
                                                                left join 
                                                                ( 
                                                                select distinct a.BI_OCC from ",ppvbicc,"  a
                                                                join ",ppvdscc,"  b
                                                                on a.DSTATEID=b.DSTATEID
                                                                join ",ppcghscc,"  c
                                                                on b.CGHS_ID = c.CGHS_ID 
                                                                where HAZ_SCALE = 'SD') f
                                                                on d.BI_OCC = f.BI_OCC and f.BI_OCC is null
                                                                order by BI_OCC
                                                                                            ")))

        
        nbi_occs_No_SD=nrow(bi_occs_No_SD)
        
        if (nbi_occs_No_SD!=0){
          cat(paste0("         ","FAIL! Number of BI_OCC(s) with no SD-based Damage state ID = ",nbi_occs_No_SD,"\n"))
          cat(paste0("         ", bi_occs_No_SD))
          
        } else { cat(paste0("         ","PASS! ALL BI_OCC(s) HAVE SD-Based Damage State ID!","\n"))  }
      }
      }
    }
  }
} 


####Test-36.  Check for cases where YR_TO==9999 in the imap table. Jira MDF-114
Test_36 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        

        impa_YrTo9999 = data.table(sqlQuery(dbHandle,paste0("select * from ",ppimapcc," where YR_TO=9999 ")))
        
        nimpa_YrTo9999=nrow(impa_YrTo9999)
        
        if (nimpa_YrTo9999!=0){
          cat(paste0("         ","FAIL! Number of unmatched records= ",nimpa_YrTo9999,"\n"))
          cat(paste0("         ","Sample of records with yr_to = 9999 problem:","\n"))
          print(head(impa_YrTo9999))
          
        } else { cat(paste0("         ","PASS! No imap record has yr_to = 9999!","\n"))  }
      }
    }
  }
}  



####Test-37.  Check Valid AggHaz_Occ list for RL climate models(HU,CS and WT) Jira MDF-101
Test_37 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      peril = Perils[j]
      country = Countries[i]
      if (tolower(peril) %in% tolower(sets$Test37$ClimateModels)){
        expectedAggHazOccs = sets$Test37$ExpectedAggHazOcc;
        # adjusting Expected AggHazOcc based on model
        if (tolower(peril)=="hu" & tolower(country) %in% tolower(sets$Test37$NewRlHuModels)) {expectedAggHazOccs = setdiff(expectedAggHazOccs,c("RES"))}
        if (tolower(peril)=="cs" | tolower(peril)=="wt") {expectedAggHazOccs = setdiff(expectedAggHazOccs,c("RMFD", "RSFD"))}
        if (tolower(peril)=="hu" & !(tolower(country) %in% tolower(sets$Test37$NewRlHuModels))) {expectedAggHazOccs = setdiff(expectedAggHazOccs,c("RMFD", "RSFD"))}
        
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")

        modelAggHaz = data.table(sqlQuery(dbHandle,paste0("select distinct AGGHAZ_OCC from ",ppvocccc)))
        

		cat(paste0("         ","Expected AggHazOccs for this model are:","\n"))
		print(expectedAggHazOccs)
		
        errorSet = setdiff(toupper(modelAggHaz$AGGHAZ_OCC),toupper(expectedAggHazOccs))
        warningSet  = setdiff(toupper(expectedAggHazOccs),toupper(modelAggHaz$AGGHAZ_OCC))
        
		print(errorSet)
        
        nerrorSet=length(errorSet)
        nwarningSet=length(warningSet)
        
        if (nerrorSet!=0){
          cat(paste0("         ","FAIL! Number of Unexpected AggHazOcc in Vocc Table = ",nerrorSet,"\n"))
          cat(paste0("         ","Unexpected AggHazOcc:","\n"))
          print(errorSet)
          
        } else { cat(paste0("         ","PASS! No unexpected AggHazOcc exists in Vocc table","\n"))  }
        
        if (nwarningSet!=0){
          cat(paste0("         ","Warning! Number of expected AggHazOcc in Vocc Table = ",nwarningSet,"\n"))
          cat(paste0("         ","Expected AggHazOcc that are missing:","\n"))
          print(warningSet)
          
        } else { cat(paste0("         ","PASS! All expected AggHazOccs are exist in Vocc Table","\n"))  }
        
        
      }
      } else { cat(paste0("         ","PASS! This test only applies to climate models.","\n"))  }
    }
    
  }
}  


####Test-38.  BI_CV curve should monotonically decrease with increase in MDR. Jira https://jira.rms.com/browse/MDF-120
Test_38 <- function (dbHandle,reportCon,Perils,Countries,perilcountry,VulnDb_ExpectedTables){
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    
    for (j in 1:nPerils){
      currentPerilCountry=paste0(Perils[j],Countries[i])
      if (currentPerilCountry %in% perilcountry) {
        cat(paste0("\n",toupper(Perils[j]),"-",toupper(Countries[i]),":","\n"))
        dummyname=paste0("'",Countries[i],"'",collapse="")
        
		ppvbicc=paste0(Perils[j],"vbi",Countries[i],collapse="")
		ppvdscc=paste0(Perils[j],"vds",Countries[i],collapse="")
        
		vbi = data.table(sqlQuery(dbHandle,paste0("select * from ",ppvbicc)))
		vds = data.table(sqlQuery(dbHandle,paste0("select * from ",ppvdscc)))
			
		bicv<-merge(vbi,vds,by="DSTATEID")
		bicv<-bicv[,c("BI_OCC","DS_CDF","CV_BI")][order(BI_OCC,DS_CDF)]
		bicvD <- bicv[,.(difference = diff(CV_BI)),by=c("BI_OCC")]
		nbicvD=unique(bicvD[difference>0]$BI_OCC)
		
		
        if (length(nbicvD)!=0){
			cat(paste0("         ","FAIL! Number of damage curves which are not MONOTONICALLY decreasing=",length(nbicvD)))
			print(paste0(nbicvD,collapse = ","))
          
        } else { cat(paste0("         ","PASS! ALL BI_CV CURVES ARE MONOTONICALLY decreasing!","\n"))  }
      }
    }
  }
}  






