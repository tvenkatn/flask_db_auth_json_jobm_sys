#Mohammad Razavi June-2016

#### LIST OF TESTS

rm(list=ls())
cat("\014")
c=Sys.time()
library(yaml)
library(RODBC) 
library(data.table)
require(sqldf)
library(knitr)
require(knitr)
knit2html("mkdTest.rmd")


setwd("D://Vulnerability//Vuln_DataLevel_CheckTool_NAEQ")
input = yaml.load_file("input.yml")
unlink(paste0(input$workdirectory,"VulnFiles"),force=T,recursive=T)  ###deleting old Vulnfiles


dir<-input$workdirectory
setwd(dir)

input_backup <- list.files(path=".", "input.yml", full.names = TRUE)
file.copy(input_backup,paste0(input$workdirectory,"VulnFiles"))
outdir<-paste0(input$workdirectory,"VulnFiles", sep="")
Vulndir = input$Vulndir
Country = input$Country
subperil =input$subperil




dbHandle <- odbcDriverConnect(paste("driver={SQL Server};
                                    server=",input$servername, ";
                                    database=", input$VulnCacheDatabase, ";
                                    trusted_connection=true", sep=""))

dbHandle2 <- odbcDriverConnect(paste("driver={SQL Server};
                                    server=",input$servername, ";
                                    database=", input$NGgeographyData, ";
                                    trusted_connection=true", sep=""))





# Create the report file
if (file.exists(paste0(dir,"/log"))) {
  # unlink("log",force=T)
  #shell("rd","log")
} else {dir.create(file.path(directory, "log"), showWarnings = FALSE)}

setwd(paste0(dir,"/log"))

unlink("Report.txt")
## 1. HazCache Data Level Check: Checking missing tables
sink("Report.txt")


```{r TEST 1,echo=FALSE}

##### Check if all the tables are included in the database


# Import all tables for the sql database
tables <- sqlTables(dbHandle, schema - dbo) # import all database tables names 
tables =data.table(tables)

# check if all needed tables  exist in the imported database  
listoftables= c('eqvllus','eqcghsus','eqfliinvus','eqimapus','eqLandMDRus','eqLiqMDRus','eqmdscus',
                'eqodscus','eqvbius','eqvbimodus','eqvbrdrus','eqvbrtvus','eqvccus','eqvcvus','eqvdc0us',
                'eqvdsus','eqvgeous','eqvhsrus','eqvinvus','eqvinvaghazus','eqvlifus','eqvlifelinebius',
                'eqvlifelinebidcus','eqvoccus','eqvparamus','eqvrsus','eqvvrggeous','vll','cghs','fliinv',
                'imap','LandMDR','LiqMDR','mdsc','odsc','vbi','vbimod','vbrdr','vbrtv',
                'vcc','vcv','vdc0','vds','vgeo','vhsr','vinv','vinvaghaz','vlif','vlifelinebi','vlifelinebidc',
                'vocc','vparam','vrs','vvrggeo')

for (i in 1:length(listoftables)){
  if (listoftables[i] %in% tables$TABLE_NAME){
    cat(paste0(listoftables[i],' exists in the imported database.','\n'))
  } else {
    cat(paste0(listoftables[i],' does not exist in the imported database.','\n'))
    
  }
  
}
```
```{r TEST2,echo=FALSE}
# Check if any of imported tables are empty:

cat(paste0('TEST2: EMPTY TABLES:','\n'))
for (i in 1:length(listoftables)){
  dummycount=sqlQuery(dbHandle, paste0("Select count(*) from ",listoftables[i]))
  if (dummycount==0){
    cat(paste0('      ',listoftables[i],' table is empty!','\n'))
  } 
  
}

```




# Import and Database tables in R
vcc = sqlQuery(dbHandle, "select * From vcc")
eqvccus = sqlQuery(dbHandle, "select * From eqvccus")
vocc = sqlQuery(dbHandle, "select * From vocc")
eqvoccus = sqlQuery(dbHandle, "select * From eqvoccus")
imap = sqlQuery(dbHandle, "select * From imap")
eqimapus = sqlQuery(dbHandle, "select * From eqimapus")
vinv = sqlQuery(dbHandle, "select * From vinv")
eqvinvus = sqlQuery(dbHandle, "select * From eqvinvus")
vgeo = sqlQuery(dbHandle, "select * From vgeo")
eqvgeous = sqlQuery(dbHandle, "select * From eqvgeous")
cghs = sqlQuery(dbHandle, paste0("select * From cghs"))
eqcghsus = sqlQuery(dbHandle, paste0("select * From eqcghsus"))
vds= sqlQuery(dbHandle, "select * From vds")
eqvdsus= sqlQuery(dbHandle, "select * From eqvdsus")
vhsr = sqlQuery(dbHandle, "select * From vhsr")
eqvhsrus = sqlQuery(dbHandle, "select * From eqvhsrus")
vbi = sqlQuery(dbHandle, "select * From vbi")
eqvbius = sqlQuery(dbHandle, "select * From eqvbius")
vbimod= sqlQuery(dbHandle, "select * From vbimod")
eqvbimodus= sqlQuery(dbHandle, "select * From eqvbimodus")
vparam = sqlQuery(dbHandle, "select * From vparam")
eqvparamus = sqlQuery(dbHandle, "select * From eqvparamus")
vlif= sqlQuery(dbHandle, "select * From vlif")
eqvlifus= sqlQuery(dbHandle, "select * From eqvlifus")
vll= sqlQuery(dbHandle, "select * From vll")
eqvllus= sqlQuery(dbHandle, "select * From eqvllus")
vdc0 = sqlQuery(dbHandle, "select * From vdc0")
eqvdc0us = sqlQuery(dbHandle, "select * From eqvdc0us")
mdsc = sqlQuery(dbHandle, "select * From mdsc")
eqmdscus = sqlQuery(dbHandle, "select * From eqmdscus")
odsc = sqlQuery(dbHandle, "select * From odsc")
eqodscus = sqlQuery(dbHandle, "select * From eqodscus")
vcv = sqlQuery(dbHandle, "select * From vcv")
eqvcvus = sqlQuery(dbHandle, "select * From eqvcvus")
fliinv = sqlQuery(dbHandle, "select * From fliinv")
eqfliinvus = sqlQuery(dbHandle, "select * From eqfliinvus")
LandMDR= sqlQuery(dbHandle, "select * From LandMDR")
eqLandMDRus = sqlQuery(dbHandle, "select * From eqLandMDRus")
LiqMDR = sqlQuery(dbHandle, "select * From LiqMDR")
eqLiqMDRus = sqlQuery(dbHandle, "select * From eqLiqMDRus")
vbrdr = sqlQuery(dbHandle, "select * From vbrdr")
eqvbrdrus = sqlQuery(dbHandle, "select * From eqvbrdrus")
vbrtv = sqlQuery(dbHandle, "select * From vbrtv")
eqvbrtvus = sqlQuery(dbHandle, "select * From eqvbrtvus")
vinvaghaz = sqlQuery(dbHandle, "select * From vinvaghaz")
eqvinvaghazus = sqlQuery(dbHandle, "select * From eqvinvaghazus")
vlifelinebi = sqlQuery(dbHandle, "select * From vlifelinebi")
eqvlifelinebius = sqlQuery(dbHandle, "select * From eqvlifelinebius")
vlifelinebidc = sqlQuery(dbHandle, "select * From vlifelinebidc")
eqvlifelinebidcus = sqlQuery(dbHandle, "select * From eqvlifelinebidcus")
vrs = sqlQuery(dbHandle, "select * From vrs")
eqvrsus = sqlQuery(dbHandle, "select * From eqvrsus")
vvrggeo = sqlQuery(dbHandle, "select * From vvrggeo")
eqvvrggeous = sqlQuery(dbHandle, "select * From eqvvrggeous")
eqvhazus = sqlQuery(dbHandle, "select * From eqvhazus")
Map_DCKey = sqlQuery(dbHandle, "select * From Map_DCKey")

#Import Mapping Tables 

Map_Coverage = sqlQuery(dbHandle, "select * From Map_Coverage")
Map_HazardScale = sqlQuery(dbHandle, "select * From Map_HazardScale")
Map_HazardType = sqlQuery(dbHandle, "select * From Map_HazardType")


#odbcClose(dbHandle)


# data.table:  Fast aggregation of large data (e.g. 100GB in RAM), fast ordered joins, fast add/modify/delete of columns by group using no copies at all, list columns and a fast file reader (fread). Offers a natural and flexible syntax, for faster development.

vcc =data.table(vcc)
eqvccus = data.table(eqvccus)
vocc = data.table(vocc)
eqvoccus = data.table(eqvoccus)
imap = data.table(imap)
eqimapus = data.table(eqimapus)
vinv =data.table(vinv)
eqvinvus = data.table(eqvinvus)
vgeo =data.table(vgeo)
eqvgeous = data.table(eqvgeous)
cghs =data.table(cghs)
eqcghsus =data.table(eqcghsus)
vds= data.table(vds)
eqvdsus= data.table(eqvdsus)
vhsr = data.table(vhsr)
eqvhsrus = data.table(eqvhsrus)
vbi = data.table(vbi)
eqvbius = data.table(eqvbius)
vbimod= data.table(vbimod)
eqvbimodus= data.table(eqvbimodus)
vparam = data.table(vparam)
eqvparamus = data.table(eqvparamus)
vlif= data.table(vlif)
eqvlifus= data.table(eqvlifus)
vll= data.table(vll)
eqvllus= data.table(eqvllus)
vdc0 = data.table(vdc0)
eqvdc0us = data.table(eqvdc0us)
mdsc = data.table(mdsc)
eqmdscus = data.table(eqmdscus)
odsc =data.table(odsc)
eqodscus = data.table(eqodscus)
vcv = data.table(vcv)
eqvcvus = data.table(eqvcvus)
fliinv = data.table(fliinv)
eqfliinvus =data.table(eqfliinvus)
LandMDR= data.table(LandMDR)
eqLandMDRus = data.table(eqLandMDRus)
LiqMDR = data.table(LiqMDR)
eqLiqMDRus = data.table(eqLiqMDRus)
vbrdr = data.table(vbrdr)
eqvbrdrus = data.table(eqvbrdrus)
vbrtv = data.table(vbrtv)
eqvbrtvus =data.table(eqvbrtvus)
vinvaghaz =data.table(vinvaghaz)
eqvinvaghazus = data.table(eqvinvaghazus)
vlifelinebi = data.table(vlifelinebi)
eqvlifelinebius = data.table(eqvlifelinebius)
vlifelinebidc = data.table(vlifelinebidc)
eqvlifelinebidcus = data.table(eqvlifelinebidcus)
vrs = data.table(vrs)
eqvrsus = data.table(eqvrsus)
vvrggeo = data.table(vvrggeo)
eqvvrggeous = data.table(eqvvrggeous)
eqvhazus= data.table(eqvhazus)
Map_DCKey= data.table(Map_DCKey)

print("Finished reading Vulncache" )










# Compare number of rows in various tables :

cat(paste0("Compare number of rows in various tables :","\n","\n"))

nvll= nrow(vll)
neqvllus= nrow(eqvllus)
if (nvll!=neqvllus){
  cat(paste0("***Number of records in vll is not equal to eqvllus***","\n"))
} else {cat(paste0("Number of records in vll is  equal to eqvllus","\n"))}


ncghs= nrow(cghs)
neqcghsus= nrow(eqcghsus)
if (ncghs!=neqcghsus){
  cat(paste0("***Number of records in cghs is not equal to eqcghsus***","\n"))
} else {cat(paste0("Number of records in cghs is  equal to eqcghsus","\n"))}


nfliinv= nrow(fliinv)
neqfliinvus= nrow(eqfliinvus)
if (nfliinv!=neqfliinvus){
  cat(paste0("***Number of records in fliinv is not equal to eqfliinvus***","\n"))
} else {cat(paste0("Number of records in fliinv is  equal to eqfliinvus","\n"))}

nimap= nrow(imap)
neqimapus= nrow(eqimapus)
if (nimap!=neqimapus){
  cat(paste0("***Number of records in imap is not equal to eqimapus***","\n"))
} else {cat(paste0("Number of records in imap is  equal to eqimapus","\n"))}


nLandMDR= nrow(LandMDR)
neqLandMDRus= nrow(eqLandMDRus)
if (nLandMDR!=neqLandMDRus){
  cat(paste0("***Number of records in LandMDR is not equal to eqLandMDRus***","\n"))
} else {cat(paste0("Number of records in LandMDR is  equal to eqLandMDRus","\n"))}


nLiqMDR= nrow(LiqMDR)
neqLiqMDRus= nrow(eqLiqMDRus)
if (nLiqMDR!=neqLiqMDRus){
  cat(paste0("***Number of records in LiqMDR is not equal to eqLiqMDRus***","\n"))
} else {cat(paste0("Number of records in LiqMDR is  equal to eqLiqMDRus","\n"))}

nmdsc= nrow(mdsc)
neqmdscus= nrow(eqmdscus)
if (nmdsc!=neqmdscus){
  cat(paste0("***Number of records in mdsc is not equal to eqmdscus***","\n"))
} else {cat(paste0("Number of records in mdsc is  equal to eqmdscus","\n"))}

nodsc= nrow(odsc)
neqodscus= nrow(eqodscus)
if (nodsc!=neqodscus){
  cat(paste0("***Number of records in odsc is not equal to eqodscus***","\n"))
} else {cat(paste0("Number of records in odsc is  equal to eqodscus","\n"))}


nvbi= nrow(vbi)
neqvbius= nrow(eqvbius)
if (nvbi!=neqvbius){
  cat(paste0("***Number of records in vbi is not equal to eqvbius***","\n"))
} else {cat(paste0("Number of records in vbi is  equal to eqvbius","\n"))}


nvbimod= nrow(vbimod)
neqvbimodus= nrow(eqvbimodus)
if (nvbimod!=neqvbimodus){
  cat(paste0("***Number of records in vbimod is not equal to eqvbimodus***","\n"))
} else {cat(paste0("Number of records in vbimod is  equal to eqvbimodus","\n"))}



nvbrdr= nrow(vbrdr)
neqvbrdrus= nrow(eqvbrdrus)
if (nvbrdr!=neqvbrdrus){
  cat(paste0("***Number of records in vbrdr is not equal to eqvbrdrus***","\n"))
} else {cat(paste0("Number of records in vbrdr is  equal to eqvbrdrus","\n"))}



nvbrtv= nrow(vbrtv)
neqvbrtvus= nrow(eqvbrtvus)
if (nvbrtv!=neqvbrtvus){
  cat(paste0("***Number of records in vbrtv is not equal to eqvbrtvus***","\n"))
} else {cat(paste0("Number of records in vbrtv is  equal to eqvbrtvus","\n"))}



nvcc= nrow(vcc)
neqvccus= nrow(eqvccus)
if (nvcc!=neqvccus){
  cat(paste0("***Number of records in vcc is not equal to eqvccus***","\n"))
} else {cat(paste0("Number of records in vcc is  equal to eqvccus","\n"))}



nvcv= nrow(vcv)
neqvcvus= nrow(eqvcvus)
if (nvcv!=neqvcvus){
  cat(paste0("***Number of records in vcv is not equal to eqvcvus***","\n"))
} else {cat(paste0("Number of records in vcv is  equal to eqvcvus","\n"))}



nvdc0= nrow(vdc0)
neqvdc0us= nrow(eqvdc0us)
if (nvdc0!=neqvdc0us){
  cat(paste0("***Number of records in vdc0 is not equal to eqvdc0us***","\n"))
} else {cat(paste0("Number of records in vdc0 is  equal to eqvdc0us","\n"))}



nvds= nrow(vds)
neqvdsus= nrow(eqvdsus)
if (nvds!=neqvdsus){
  cat(paste0("***Number of records in vds is not equal to eqvdsus***","\n"))
} else {cat(paste0("Number of records in vds is  equal to eqvdsus","\n"))}



nvgeo= nrow(vgeo)
neqvgeous= nrow(eqvgeous)
if (nvgeo!=neqvgeous){
  cat(paste0("***Number of records in vgeo is not equal to eqvgeous***","\n"))
} else {cat(paste0("Number of records in vgeo is  equal to eqvgeous","\n"))}



nvcc= nrow(vcc)
neqvccus= nrow(eqvccus)
if (nvcc!=neqvccus){
  cat(paste0("***Number of records in vcc is not equal to eqvccus***","\n"))
} else {cat(paste0("Number of records in vcc is  equal to eqvccus","\n"))}



nvhsr= nrow(vhsr)
neqvhsrus= nrow(eqvhsrus)
if (nvhsr!=neqvhsrus){
  cat(paste0("***Number of records in vhsr is not equal to eqvhsrus***","\n"))
} else {cat(paste0("Number of records in vhsr is  equal to eqvhsrus","\n"))}



nvinv= nrow(vinv)
neqvinvus= nrow(eqvinvus)
if (nvinv!=neqvinvus){
  cat(paste0("***Number of records in vinv is not equal to eqvinvus***","\n"))
} else {cat(paste0("Number of records in vinv is  equal to eqvinvus","\n"))}



nvinvaghaz= nrow(vinvaghaz)
neqvinvaghazus= nrow(eqvinvaghazus)
if (nvinvaghaz!=neqvinvaghazus){
  cat(paste0("***Number of records in vinvaghaz is not equal to eqvinvaghazus***","\n"))
} else {cat(paste0("Number of records in vinvaghaz is  equal to eqvinvaghazus","\n"))}



nvlif= nrow(vlif)
neqvlifus= nrow(eqvlifus)
if (nvlif!=neqvlifus){
  cat(paste0("***Number of records in vlif is not equal to eqvlifus***","\n"))
} else {cat(paste0("Number of records in vlif is  equal to eqvlifus","\n"))}



nvlifelinebi= nrow(vlifelinebi)
neqvlifelinebius= nrow(eqvlifelinebius)
if (nvlifelinebi!=neqvlifelinebius){
  cat(paste0("***Number of records in vlifelinebi is not equal to eqvlifelinebius***","\n"))
} else {cat(paste0("Number of records in vlifelinebi is  equal to eqvlifelinebius","\n"))}



nvlifelinebidc= nrow(vlifelinebidc)
neqvlifelinebidcus= nrow(eqvlifelinebidcus)
if (nvlifelinebidc!=neqvlifelinebidcus){
  cat(paste0("***Number of records in vlifelinebidc is not equal to eqvlifelinebidcus***","\n"))
} else {cat(paste0("Number of records in vlifelinebidc is  equal to eqvlifelinebidcus","\n"))}



nvocc= nrow(vocc)
neqvoccus= nrow(eqvoccus)
if (nvocc!=neqvoccus){
  cat(paste0("***Number of records in vocc is not equal to eqvoccus***","\n"))
} else {cat(paste0("Number of records in vocc is  equal to eqvoccus","\n"))}



nvparam= nrow(vparam)
neqvparamus= nrow(eqvparamus)
if (nvparam!=neqvparamus){
  cat(paste0("***Number of records in vparam is not equal to eqvparamus***","\n"))
} else {cat(paste0("Number of records in vparam is  equal to eqvparamus","\n"))}


nvrs= nrow(vrs)
neqvrsus= nrow(eqvrsus)
if (nvrs!=neqvrsus){
  cat(paste0("***Number of records in vrs is not equal to eqvrsus***","\n"))
} else {cat(paste0("Number of records in vrs is  equal to eqvrsus","\n"))}

nvvrggeo= nrow(vvrggeo)
neqvvrggeous= nrow(eqvvrggeous)
if (nvvrggeo!=neqvvrggeous){
  cat(paste0("***Number of records in vvrggeo is not equal to eqvvrggeous***","\n"))
} else {cat(paste0("Number of records in vvrggeo is  equal to eqvvrggeous","\n"))}

cat(paste0("\n","\n"))



cat(paste0("Checking vgeo table :","\n","\n"))


#### Check vgeo and eqvgeo tables 
cat(paste0("Check vgeo and eqvgeo tables :","\n"))
# Check for duplicates in postal codes
vgeo_duplicates = data.table(sqlQuery(dbHandle, "SELECT
                                                      POSTALCODE, COUNT(*)
                                                  FROM
                                                      vgeo
                                                  WHERE
                                                    POSTALCODE IS NOT NULL  
                                                  GROUP BY
                                                       POSTALCODE 
                                                  HAVING 
                                                      COUNT(*) > 1
                                                  "))

nvgeo_duplicate=nrow(vgeo_duplicates)
cat(paste0("Numberof Duplicate Postalcodes =",nvgeo_duplicate,"\n"))
cat(paste0("\n","\n",vgeo_duplicates))


# Check for duplicates in districts
cat(paste0("\n","\n"))
vgeo_duplicates_dis = data.table(sqlQuery(dbHandle, "SELECT
                                      Admin2Code, COUNT(*)
                                      FROM
                                      vgeo
                                      WHERE
                                      Admin2Code IS NOT NULL  
                                      GROUP BY
                                      Admin2Code 
                                      HAVING 
                                      COUNT(*) > 1
                                      "))

nvgeo_duplicate_dis=nrow(vgeo_duplicates_dis)
cat(paste0("Numberof Duplicate Admin2Code (District) =",nvgeo_duplicate_dis,"\n"))
cat(paste0("\n","\n",vgeo_duplicates_dis,"\n","\n"))


# check for number of distinct states 
nvgeo_admin1=data.table(sqlQuery(dbHandle, "select COUNT(distinct Admin1Code) from vgeo"))
cat(paste0("Numberof Distinct Admin1Code (States) =",nvgeo_admin1,"\n"))


#Check if records with the same GEO_RECNUM have the same values in vgeo and eqvgeous tables
#Check records with postal code

vgeo_Postal_dif = data.table(sqlQuery(dbHandle,"SELECT vgeo.GEO_RECNUM, eqvgeous.GEO_RECNUM, vgeo.POSTALCODE,eqvgeous.POSTALCODE,vgeo.Admin1Code,eqvgeous.STATE,vgeo.Admin2Code,eqvgeous.COUNTYNUM
                                      FROM vgeo 
                                      INNER JOIN eqvgeous ON vgeo.GEO_RECNUM = eqvgeous.GEO_RECNUM and (vgeo.POSTALCODE!=eqvgeous.POSTALCODE and (vgeo.POSTALCODE IS NOT NULL and eqvgeous.POSTALCODE is NOT NULL))"))

nvgeo_Postal_dif=nrow(vgeo_Postal_dif)
cat(paste0("Number of rows with unmatched postal codes =",nvgeo_Postal_dif,"\n"))

# Check records without postal code with unmatched state or district code
vgeo_NoPostal_dif = data.table(sqlQuery(dbHandle,"SELECT vgeo.GEO_RECNUM, eqvgeous.GEO_RECNUM, vgeo.POSTALCODE,eqvgeous.POSTALCODE,vgeo.Admin1Code,eqvgeous.STATE,vgeo.Admin2Code,eqvgeous.COUNTYNUM
                                      FROM vgeo 
                                      INNER JOIN eqvgeous ON vgeo.GEO_RECNUM = eqvgeous.GEO_RECNUM and (vgeo.POSTALCODE IS NULL and eqvgeous.POSTALCODE is NULL) and (vgeo.Admin1Code!=eqvgeous.STATE or vgeo.Admin2Code!=eqvgeous.COUNTYNUM)"))

nvgeo_NoPostal_dif=nrow(vgeo_NoPostal_dif)
cat(paste0("Number of rows with unmatched state or district fields =",nvgeo_NoPostal_dif,"\n","\n","\n","\n"))


# Check cghs and eqcghsus tables:   KEY cghs_ID
cat(paste0("Check cghs and eqcghsus tables :","\n"))

# Check Hazard_type:

cghs_haztype_dif = data.table(sqlQuery(dbHandle,"SELECT cghs.HAZ_TYPE, eqcghsus.HAZ_TYPE
FROM cghs
     INNER JOIN eqcghsus ON eqcghsus.CGHS_ID=cghs.CGHS_ID and 
     eqcghsus.HAZ_TYPE!=(select Map_HazardType.haz_type from Map_HazardType where haz_type_id=cghs.HAZ_TYPE)
 "))

ncghs_haztype_dif=nrow(cghs_haztype_dif)
cat(paste0("Numberof rows with unmatched hazard type =",ncghs_haztype_dif,"\n","\n","\n","\n"))


# Check Hazard_Scale:

cghs_hazscale_dif = data.table(sqlQuery(dbHandle,"SELECT cghs.HAZ_SCALE, eqcghsus.HAZ_SCALE
                                                  FROM cghs
                                                       INNER JOIN eqcghsus ON eqcghsus.CGHS_ID=cghs.CGHS_ID and 
                                                       eqcghsus.HAZ_SCALE!=(select Map_HazardSCALE.haz_SCALE from Map_HazardSCALE where haz_SCALE_id=cghs.HAZ_SCALE)
                                                      "))

ncghs_hazscale_dif=nrow(cghs_hazscale_dif)
cat(paste0("Numberof rows with unmatched hazard scale =",ncghs_hazscale_dif,"\n","\n","\n","\n"))


# Check Coverage:

cghs_Coverage_dif = data.table(sqlQuery(dbHandle,"SELECT cghs.COVERAGE, eqcghsus.COVERAGE
                                                  FROM cghs
                                                       INNER JOIN eqcghsus ON eqcghsus.CGHS_ID=cghs.CGHS_ID and 
                                                       eqcghsus.COVERAGE!=(select Map_COVERAGE.coverage from Map_COVERAGE where COVERAGE_id=cghs.COVERAGE)
                                                     "))

ncghs_Coverage_dif=nrow(cghs_Coverage_dif)
cat(paste0("Numberof rows with unmatched coverage =",ncghs_Coverage_dif,"\n","\n","\n","\n"))

#### Check Imap and eqimapus tables: KEY is  INV_RECNUM

cat(paste0("Check Imap and eqimapus tables :","\n"))

# Check INV_KEY

imap_invkey_dif = data.table(sqlQuery(dbHandle,"SELECT imap.INV_KEY, eqimapus.INV_KEY
                                                FROM imap
                                                     INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                     (eqimapus.INV_KEY!=(select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY) or 
                                                     (eqimapus.INV_KEY is NULL and 
                                                     (select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY)is not NULL))
                                                                                        "))

nimap_invkey_dif=nrow(imap_invkey_dif)
cat(paste0("Numberof rows with unmatched INV_KEY =",nimap_invkey_dif,"\n"))


# Check MAPCCLSSIF

imap_MAPCCLSSIF_dif = data.table(sqlQuery(dbHandle,"SELECT imap.MAPCCLSSIF, eqimapus.MAPCCLSSIF
                                                    FROM imap
                                                         INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                         (eqimapus.MAPCCLSSIF!=(select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)or
                                                         (eqimapus.MAPCCLSSIF is NULL and 
                                                         (select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)is not NULL))
                                                                                          "))

nimap_MAPCCLSSIF_dif=nrow(imap_MAPCCLSSIF_dif)
cat(paste0("Numberof rows with unmatched MAPCCLSSIF =",nimap_MAPCCLSSIF_dif,"\n"))



# Check MAPCCTIER1

imap_MAPCCTIER1_dif = data.table(sqlQuery(dbHandle,"SELECT imap.MAPCCTIER1, eqimapus.MAPCCTIER1
                                                    FROM imap
                                                         INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                         (eqimapus.MAPCCTIER1!=(select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1) or 
                                                         (eqimapus.MAPCCTIER1 is NULL and 
                                                         (select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1)is not NULL))
                                          "))

nimap_MAPCCTIER1_dif=nrow(imap_MAPCCTIER1_dif)
cat(paste0("Numberof rows with unmatched MAPCCTIER1 =",nimap_MAPCCTIER1_dif,"\n"))


# Check MAPCCTIER2

imap_MAPCCTIER2_dif = data.table(sqlQuery(dbHandle,"SELECT imap.MAPCCTIER2, eqimapus.MAPCCTIER2
                                          FROM imap
                                          INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                          (eqimapus.MAPCCTIER2!=(select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2) or 
                                          (eqimapus.MAPCCTIER2 is NULL and 
                                          (select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2)is not NULL))
                                          "))

nimap_MAPCCTIER2_dif=nrow(imap_MAPCCTIER2_dif)
cat(paste0("Numberof rows with unmatched MAPCCTIER2 =",nimap_MAPCCTIER2_dif,"\n"))


# Check MAPCCTIER3

imap_MAPCCTIER3_dif = data.table(sqlQuery(dbHandle,"SELECT imap.MAPCCTIER3, eqimapus.MAPCCTIER3
                                          FROM imap
                                          INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                          (eqimapus.MAPCCTIER3!=(select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3) or 
                                          (eqimapus.MAPCCTIER3 is NULL and 
                                          (select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3)is not NULL))
                                          "))

nimap_MAPCCTIER3_dif=nrow(imap_MAPCCTIER3_dif)
cat(paste0("Numberof rows with unmatched MAPCCTIER3 =",nimap_MAPCCTIER3_dif,"\n"))


# Check INVOCC

imap_INVOCC_dif = data.table(sqlQuery(dbHandle,"SELECT imap.INV_OCC, eqimapus.INV_OCC
                                                FROM imap
                                                     INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                     (eqimapus.INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC) or 
                                                     (eqimapus.INV_OCC is NULL and 
                                                     (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC)is not NULL))
                                          "))

nimap_INVOCC_dif=nrow(imap_INVOCC_dif)
cat(paste0("Numberof rows with unmatched INVOCC =",nimap_INVOCC_dif,"\n"))



# Check CV_KEY

imap_CV_KEY_dif = data.table(sqlQuery(dbHandle,"SELECT imap.CV_KEY, eqimapus.CV_KEY
                                                FROM imap
                                                     INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                     (eqimapus.CV_KEY!=(select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY) or 
                                                     (eqimapus.CV_KEY is NULL and 
                                                     (select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY)is not NULL))
                                      "))

nimap_CV_KEY_dif=nrow(imap_CV_KEY_dif)
cat(paste0("Numberof rows with unmatched CV_KEY =",nimap_CV_KEY_dif,"\n"))



# Check BR_TVKEY

imap_BR_TVKEY_dif = data.table(sqlQuery(dbHandle,"SELECT imap.BR_TVKEY, eqimapus.BR_TVKEY
                                                  FROM imap
                                                       INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                       (eqimapus.BR_TVKEY!=(select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY) or 
                                                       (eqimapus.BR_TVKEY is NULL and 
                                                       (select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY)is not NULL))
                                      "))

nimap_BR_TVKEY_dif=nrow(imap_BR_TVKEY_dif)
cat(paste0("Numberof rows with unmatched BR_TVKEY =",nimap_BR_TVKEY_dif,"\n"))





# Check BR_DRKEY

imap_BR_DRKEY_dif = data.table(sqlQuery(dbHandle,"SELECT imap.BR_DRKEY, eqimapus.BR_DRKEY
                                                  FROM imap
                                                       INNER JOIN eqimapus ON eqimapus.INV_RECNUM=imap.INV_RECNUM and 
                                                       (eqimapus.BR_DRKEY!=(select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY) or 
                                                       (eqimapus.BR_DRKEY is NULL and 
                                                       (select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY)is not NULL))
                                        "))

nimap_BR_DRKEY_dif=nrow(imap_BR_DRKEY_dif)
cat(paste0("Numberof rows with unmatched BR_DRKEY =",nimap_BR_DRKEY_dif,"\n","\n","\n","\n"))





#### Check vinv and eqvinvus tables KEy: INV_RECNUM and PDC_NUM and PDC_GROUP
cat(paste0("Check  vinv and eqvinvus tables :","\n"))



inv_dif = data.table(sqlQuery(dbHandle," SELECT vinv.INV_RECNUM,vinv.PDC_GROUP,vinv.PDC_NUM, eqvinvus.INV_RECNUM,eqvinvus.PDC_GROUP,eqvinvus.PDC_NUM 
                                         FROM vinv 
                                         INNER JOIN eqvinvus ON (vinv.INV_RECNUM= eqvinvus.INV_RECNUM and vinv.PDC_GROUP=eqvinvus.PDC_GROUP and vinv.PDC_NUM =eqvinvus.PDC_NUM) 
                                          and ((ROUND(vinv.DEF_INVPCT,0)!=ROUND(eqvinvus.DEF_INVPCT,0) 
                                          or (ROUND(vinv.CT,4)!=ROUND(eqvinvus.CT,4))) 
                                          or (vinv.AVGSTHT!=eqvinvus.AVGSTHT) or (vinv.DNUMSTOR!=eqvinvus.DNUMSTOR))
                                                                      "))

ninv_dif=nrow(inv_dif)
cat(paste0("Number of unmatched rows= ",ninv_dif,"\n","\n","\n","\n"))





####### TEST vdc0



SELECT COUNT(distinct(CGHS_ID)) FROM vdc0 

SELECT distinct(CGHS_ID) FROM vdc0 



#### check if all damage curves are monotonic (increasing) Stard with the DC_NUM then DC_KEY then CGHS_ID

# PDC_NUM = data.table(sqlQuery(dbHandle,"SELECT distinct(PDC_NUM) FROM vdc0"))
# nPDC_NUM = nrow(PDC_NUM)
# DC_KEY = data.table(sqlQuery(dbHandle,"SELECT distinct(DC_KEY) FROM vdc0"))
# nDC_KEY = nrow(DC_KEY)
# CGHS_ID = data.table(sqlQuery(dbHandle,"SELECT distinct(CGHS_ID) FROM vdc0"))
# nCGHS_ID = nrow(CGHS_ID)

# Check if all damage curves are monotonically increasing
vdcD <- vdc0[,.(difference = diff(DAMAGE_PCT)),by=c("PDC_NUM","dc_key","CGHS_ID")]
nvdcD=nrow(vdcD[difference<0])

cat(paste0("Number of damage curves which are not motonically increasing= ",nvdcD,"\n","\n","\n","\n"))

# Check if the x-axis on damage curves are motonically increasing
vdcDHaz <- vdc0[,.(difference=diff(HAZ_SEV)),by=c("PDC_NUM","dc_key","CGHS_ID")]

nvdcDHaz=nrow(vdcDHaz[difference<0])


cat(paste0("Number of damage curves in which x-axis is not motonically increasing= ",nvdcD,"\n","\n","\n","\n"))


# Check if curves with the same CGHS_ID have the same number or records.


Frequency=data.table(sqlQuery(dbHandle,"  
SELECT DC_KEY, PDC_NUM, CGHS_ID, COUNT(*) as Freq
FROM vdc0
GROUP BY  DC_KEY, PDC_NUM, CGHS_ID 
"))
                     
Freq_Diff=Frequency[,.(difference=diff(Freq)),by=c("CGHS_ID")]
nFreq_Diff=nrow(Freq_Diff[difference!=0])











cghs_ID_Distinct = data.table(sqlQuery(dbHandle,"SELECT distinct(CGHS_ID) FROM vdc0")) # Makes a table of distinct cghs_ID exist in vdc0 table 
cghs_ID_Distinct=cghs_ID_Distinct[order(CGHS_ID)] # Sort the table 
ncghs_ID_Distinct=nrow(cghs_ID_Distinct)
# for each cghs_ID the number of rows in eqvhazus database should be constant 


nDC_KEY_Distinct = data.table(sqlQuery(dbHandle,paste("SELECT COUNT(distinct(DC_KEY)) FROM eqvhazus where CGHS_ID=",toString(7))))








######## TEST AREA :D

DC_Map<- function (x){
  
  return(Map_DCKey[dc_key_id==x,dc_key])
}







d=Sys.time()

print(d-c)

closeAllConnections() # it closes the connection to the file so it writes on the console.
