c=Sys.time()
library(yaml)
library(RODBC) 
library(data.table)
input = yaml.load_file("input.yml")
# vF0F1<-as.data.table(vF0F1)
unlink(paste0(input$workdirectory,"VulnFiles"),force=T,recursive=T)  ###deleting old Vulnfiles

dir.create(paste0(input$workdirectory,"VulnFiles"))
###creating outputfolder for vulnearbility files

dir<-input$workdirectory
setwd(dir)
## backup input file to out folder
input_backup <- list.files(path=".", "input.yml", full.names = TRUE)
file.copy(input_backup,paste0(input$workdirectory,"VulnFiles"))
outdir<-paste0(input$workdirectory,"VulnFiles", sep="")
Vulndir = input$Vulndir
Country = input$Country
subperil =input$subperil

print("Reading VulnCache ...")

 ##change server and database name  
dbHandle <- odbcDriverConnect(paste("driver={SQL Server};
                                    server=",input$servername, ";
                                    database=", input$VulnCacheDatabase, ";
                                    trusted_connection=true", sep=""))

dbHandle2 <- odbcDriverConnect(paste("driver={SQL Server};
                                    server=",input$servername, ";
                                    database=", input$NGgeographyData, ";
                                    trusted_connection=true", sep=""))

ConstructionMap<-sqlQuery(dbHandle2, "select * From ConstructionMap")
OccupancyMap<-sqlQuery(dbHandle2, "select * From OccupancyMap")



#tables <- sqlTables(dbhandle, schema - dbo)
tables <- sqlTables(dbHandle, schema - dbo)
vcc = sqlQuery(dbHandle, "select * From vcc")
vocc = sqlQuery(dbHandle, "select * From vocc")
imap = sqlQuery(dbHandle, "select * From imap")
vinv = sqlQuery(dbHandle, "select * From vinv")
vgeo = sqlQuery(dbHandle, "select * From vgeo")

cghs = sqlQuery(dbHandle, paste0("select * From cghs"))
vds= sqlQuery(dbHandle, "select * From vds")
vhsr = sqlQuery(dbHandle, "select * From vhsr")

vbi = sqlQuery(dbHandle, "select * From vbi")
bidc = sqlQuery(dbHandle, "select * From bidc")
vbimod= sqlQuery(dbHandle, "select * From vbimod")
vparam = sqlQuery(dbHandle, "select * From vparam")
vlif= sqlQuery(dbHandle, "select * From vlif")
vll= sqlQuery(dbHandle, "select * From vll")


# bldghtfactor= sqlQuery(dbHandle, "select * From bldghtfactor")
    
vdc0 = sqlQuery(dbHandle, "select * From vdc0")
mdsc = sqlQuery(dbHandle, "select * From mdsc")
odsc = sqlQuery(dbHandle, "select * From odsc")


vcv = sqlQuery(dbHandle, "select * From vcv")
# vF0F1 = sqlQuery(dbHandle, "select * From vF0F1")
# vF0F1<-as.data.table(vF0F1)
Map_ConstructionNew = sqlQuery(dbHandle, "select * From Map_ConstructionNew")
Map_OccupancyNew = sqlQuery(dbHandle, "select * From Map_OccupancyNew")


Map_HazardType=sqlQuery(dbHandle, "select * From Map_HazardType")
odbcClose(dbHandle)

cghs$COVERAGE=as.numeric(cghs$COVERAGE)
cghs$CGHS_ID = as.numeric(cghs$CGHS_ID)
cghs$CVG_GRADE = as.numeric(cghs$CVG_GRADE)



imap$INV_RECNUM = as.numeric(imap$INV_RECNUM)
imap$YR_FROM = as.numeric(imap$YR_FROM)
imap$YR_TO = as.numeric(imap$YR_TO)
imap$HT_FROM = as.numeric(imap$HT_FROM)
imap$HT_TO = as.numeric(imap$HT_TO)
# imap$FLOORAREA_FROM = as.numeric(imap$FLOORAREA_FROM)  not applicable for EQ models
# imap$FLOORAREA_TO = as.numeric(imap$FLOORAREA_TO)
imap$CV_KEY = as.numeric(imap$CV_KEY)
imap$F0F1_KEY = as.numeric(imap$F0F1_KEY)


vcc$ConstructionID=as.numeric(vcc$ConstructionID)

vcv$MDR=as.numeric(vcv$MDR)
vcv$CV_TOTAL=as.numeric(vcv$CV_TOTAL)
vcv$CV_KEY = as.numeric(vcv$CV_KEY)
vcv$CGHS_ID = as.numeric(vcv$CGHS_ID)

# 
# vF0F1$CGHS_ID = as.integer(vF0F1$CGHS_ID)
# vF0F1$F0F1_Key = as.integer(vF0F1$F0F1_Key)
# # vF0F1$dc_key = as.integer(vF0F1$DC_KEY)
# setnames(vF0F1, "F0F1_Key", "F0F1_KEY")
# setnames(vF0F1, "dc_key", "DC_KEY")


vgeo$Zone1GeoId=as.numeric(vgeo$Zone1GeoId)
vgeo$DC_KEY=as.numeric(vgeo$DC_KEY)


vinv$INV_RECNUM = as.numeric(vinv$INV_RECNUM)
vinv$PDC_NUM<-as.numeric(vinv$PDC_NUM)
vinv$DEF_INVPCT = as.numeric(vinv$DEF_INVPCT)


vocc$OccupancyID = as.numeric(vocc$OccupancyID)

# bldghtfactor$PDC_NUM<-as.numeric(bldghtfactor$PDC_NUM)
# bldghtfactor$FACTOR<-as.numeric(bldghtfactor$FACTOR)
# bldghtfactor$HT_TO<-as.integer(bldghtfactor$HT_TO)
# bldghtfactor$HT_FROM<-as.integer(bldghtfactor$HT_FROM)


vbi$T30=as.numeric(vbi$T30)
vbi$T60=as.numeric(vbi$T60)
vbi$T100=as.numeric(vbi$T100)
vbi$CV_BI=as.numeric(vbi$CV_BI)
vbi$BI_KEY=as.integer(vbi$BI_KEY)
vbi$BI_OCC=as.integer(vbi$BI_OCC)
vbi$DSTATEID=as.integer(vbi$DSTATEID)



# bidc$BI_OCC = as.integer(bidc$BI_OCC) 

# setnames(vds, "cghs_id", "CGHS_ID")
vds$DSTATEID=as.integer(vds$DSTATEID)
vds$CGHS_ID=as.integer(vds$CGHS_ID)
vds$DS_CDF=as.numeric(vds$DS_CDF)
vds$TO_DR=as.integer(vds$TO_DR)
vds$FROM_DR=as.integer(vds$FROM_DR)



bi<-merge(vbi,vds,by=c("country","DSTATEID"),allow.cartesian=T)
vdc0 =data.table(vdc0)
mdsc =data.table(mdsc)
odsc =data.table(odsc)
cghs =data.table(cghs)
imap =data.table(imap)
vcc =data.table(vcc)
vcv =data.table(vcv)
vgeo =data.table(vgeo)
vinv =data.table(vinv)
vocc =data.table(vocc)
bidc =data.table(bidc)
bi =data.table(bi)
vbi =data.table(vbi)
vbimod =data.table(vbimod)
vds =data.table(vds)
# vF0F1 =data.table(vF0F1)
vlif =data.table(vlif)
vll =data.table(vll)
# bldghtfactor =data.table(bldghtfactor)
vshr =data.table(vhsr)
vparam =data.table(vparam)
Map_ConstructionNew<-as.data.table(Map_ConstructionNew)
Map_OccupancyNew<-as.data.table(Map_OccupancyNew)



print("Finished reading Vulncache" )




#######Reading VDC table------
print("////////////////////////////////////////////")
print(paste("start Vulnerability retrieval for each subperil"))
#########################################################################################
#
###########################################################################################
###For NZEQ

#  DataSH = "SH_0_NZ_SD_DATA.dat"; IndexSH ="SH_0_NZ_SD_INDEX.dat";
# DataMMI = "SH_0_NZ_MMI_DATA.dat"; IndexMMI ="SH_0_NZ_MMI_INDEX.dat";
# #########################################################################################
# # Read Binary Files
# ##########################################################################################
# 
# print(paste("Reading Vulnerability binary files for subperil", " ...", sep=""))
# getFLData<-function(filename)
# {
#   FLData = file(filename,"rb")
#   s<-file.info(filename)$size
#   
#   #res<-18 #Number of rows per damage curve for EUFL
#   
#   
#   res<-23 #Number of rows per damage curve
#   hsize=res*4
#   nrecords=(s-hsize)/4
#   
#   raw<-readBin(FLData,"raw",n=s,endian="little")
#   header=readBin(raw[1:hsize],double(),size=4,n=hsize,endian="little")
#   
#   raw1<-raw[(hsize+1):s]
#   y<-matrix(raw1,nrow=4)
#   
#   DamPct=readBin(as.vector(y[1:4,]),double(),size=4,n=nrecords,endian="little")
#   z<-rep(1:(nrecords/res),each=res)
#   
#   FLDATA<-data.frame(HazSev=header,DamPct,Index=z)
#   close(FLData)
#   FLDATA = data.table(FLDATA)
#   return(FLDATA)
# }
# 
# getFLIndex<-function(filename)
# {
#   i1=file(filename,"rb") 
#   s<-file.info(filename)$size
#   nrecords=(s-2)/8
#   raw<-readBin(i1,"raw",n=s,endian="little")
#   length=readBin(raw[1:2],integer(),size=2,endian="little")
#   raw<-raw[3:s]
#   y<-matrix(raw,nrow=8)
#   x1=readBin(as.vector(y[1:2,]),integer(),size=2,n=nrecords,signed = FALSE,endian="little")
#   x2=readBin(as.vector(y[3,]),integer(),size=1,n=nrecords,endian="little")
#   x3=readBin(as.vector(y[4,]),integer(),size=1,n=nrecords,endian="little")
#   x4=readBin(as.vector(y[5:8,]),integer(),size=4,n=nrecords,endian="little")
#   FLIndex<-data.frame(PDCNum=x1,DCKey=x2,CghsID=x3,Index=x4)
#   close(i1)
#   FLIndex = data.table(FLIndex)
#   return(FLIndex)
# }
# 
# VulBDataWI<-getFLData(paste(Vulndir, DataSH, sep="\\"))
# VulBIndexWI<-getFLIndex(paste(Vulndir, IndexSH, sep="\\"))
# 
# 
# #write.csv(VulBDataWI, file="VulnFiles/VulBDataWI.csv")
# 
# vdcSH = merge(x = VulBDataSH, y = VulBIndexSH, by = "Index", all = TRUE)
# 
# 
# 
# VulBDataMMI<-getFLData(paste(Vulndir, DataMMI, sep="\\"))
# VulBIndexMMI<-getFLIndex(paste(Vulndir, IndexMMI, sep="\\"))
# vdcMMI = merge(x = VulBDataMMI, y = VulBIndexMMI, by = "Index", all = TRUE)
# 

# #write.csv(VulBDataSU, file="VulnFiles/VulBDataSU.csv")
# 
# VulBDataFL<-getFLData(paste(Vulndir, DataFL, sep="\\"))
# VulBIndexFL<-getFLIndex(paste(Vulndir, IndexFL, sep="\\"))
# vdcFL = merge(x = VulBDataFL, y = VulBIndexFL, by = "Index", all = TRUE)
# # 
# # write.csv(VulBIndexWI, file="VulnFiles/VulBIndexWI.csv")
# # write.csv(VulBIndexSU, file="VulnFiles/VulBIndexSU.csv")
# # write.csv(VulBIndexFL, file="VulnFiles/VulBIndexFL.csv")
# #write.csv(VulBDataFL, file="VulnFiles/VulBDataFL.csv")


d=Sys.time()
print("Finished reading Binary Files" )
print(d-c)





####For JPTY---

# DataWI = "WI_0_JP_DATA.dat"; IndexWI ="WI_0_JP_INDEX.dat";
# DataSU = "SU_0_JP_DATA.dat"; IndexSU ="SU_0_JP_INDEX.dat";
# DataFL = "FL_0_JP_DATA.dat"; IndexFL ="FL_0_JP_INDEX.dat"

# subperil=input$subperil
# if(subperil == "WI"){haztype = 3; 
# DataBF = "WI_0_JP_DATA.dat"; IndexBF ="WI_0_JP_INDEX.dat";
# HAZ_TYPE_str = "WI" }
# if(subperil == "SU"){haztype = 1; 
# DataBF = "SU_0_JP_DATA.dat"; IndexBF ="SU_0_JP_INDEX.dat";
# HAZ_TYPE_str = "SU"}
# if(subperil == "FL"){haztype = 0; 
# DataBF = "FL_0_JP_DATA.dat"; IndexBF ="FL_0_JP_INDEX.dat";
# HAZ_TYPE_str = "FL" }

##########################################################################################
# Read Binary Files
##########################################################################################

print(paste("Reading Vulnerability binary files for subperil", " ...", sep=""))
# getFLData<-function(filename)
# {
#   FLData = file(filename,"rb")
#   s<-file.info(filename)$size
#   
#   #res<-18 #Number of rows per damage curve for EUFL
#   
#   
#   res<-23 #Number of rows per damage curve
#   hsize=res*4
#   nrecords=(s-hsize)/4
#   
#   raw<-readBin(FLData,"raw",n=s,endian="little")
#   header=readBin(raw[1:hsize],double(),size=4,n=hsize,endian="little")
#   
#   raw1<-raw[(hsize+1):s]
#   y<-matrix(raw1,nrow=4)
#   
#   DamPct=readBin(as.vector(y[1:4,]),double(),size=4,n=nrecords,endian="little")
#   z<-rep(1:(nrecords/res),each=res)
#   
#   FLDATA<-data.frame(HazSev=header,DamPct,Index=z)
#   close(FLData)
#   FLDATA = data.table(FLDATA)
#   return(FLDATA)
# }
# 
# getFLIndex<-function(filename)
# {
#   i1=file(filename,"rb") 
#   s<-file.info(filename)$size
#   nrecords=(s-2)/8
#   raw<-readBin(i1,"raw",n=s,endian="little")
#   length=readBin(raw[1:2],integer(),size=2,endian="little")
#   raw<-raw[3:s]
#   y<-matrix(raw,nrow=8)
#   x1=readBin(as.vector(y[1:2,]),integer(),size=2,n=nrecords,signed = FALSE,endian="little")
#   x2=readBin(as.vector(y[3,]),integer(),size=1,n=nrecords,endian="little")
#   x3=readBin(as.vector(y[4,]),integer(),size=1,n=nrecords,endian="little")
#   x4=readBin(as.vector(y[5:8,]),integer(),size=4,n=nrecords,endian="little")
#   FLIndex<-data.frame(PDCNum=x1,DCKey=x2,CghsID=x3,Index=x4)
#   close(i1)
#   FLIndex = data.table(FLIndex)
#   return(FLIndex)
# }
##FOR JPTY WIND
# VulBDataWI<-getFLData(paste(Vulndir, DataWI, sep="\\"))
# VulBIndexWI<-getFLIndex(paste(Vulndir, IndexWI, sep="\\"))
# 
# 
# #write.csv(VulBDataWI, file="VulnFiles/VulBDataWI.csv")
# 
# vdcWI = merge(x = VulBDataWI, y = VulBIndexWI, by = "Index", all = TRUE)
# 
# 
# 
# VulBDataSU<-getFLData(paste(Vulndir, DataSU, sep="\\"))
# VulBIndexSU<-getFLIndex(paste(Vulndir, IndexSU, sep="\\"))
# vdcSU = merge(x = VulBDataSU, y = VulBIndexSU, by = "Index", all = TRUE)
# 
# 
# #write.csv(VulBDataSU, file="VulnFiles/VulBDataSU.csv")
# 
# VulBDataFL<-getFLData(paste(Vulndir, DataFL, sep="\\"))
# VulBIndexFL<-getFLIndex(paste(Vulndir, IndexFL, sep="\\"))
# vdcFL = merge(x = VulBDataFL, y = VulBIndexFL, by = "Index", all = TRUE)
# # 
# # write.csv(VulBIndexWI, file="VulnFiles/VulBIndexWI.csv")
# # write.csv(VulBIndexSU, file="VulnFiles/VulBIndexSU.csv")
# # write.csv(VulBIndexFL, file="VulnFiles/VulBIndexFL.csv")
# #write.csv(VulBDataFL, file="VulnFiles/VulBDataFL.csv")
# 
# 
# d=Sys.time()
# print("Finished reading Binary Files" )
# print(d-c)
# 
# 
# 





