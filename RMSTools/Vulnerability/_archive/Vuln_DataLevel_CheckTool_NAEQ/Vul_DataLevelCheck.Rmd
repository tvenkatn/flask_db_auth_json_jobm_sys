---
title: 'NAEQ Data Level Check '
author: "Executed By:- Geeta Nain"
date: "dated :-July 17th, 2016"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

*Checked By-----*                                                      
*on Date----*

```{r, echo=FALSE, include=FALSE, warning=FALSE}
rm(list=ls())
starttime=Sys.time()
library(yaml)
library(data.table)
library("plyr")
library(data.table)
library(stringr)
gc()
source("ReadVuln.R")
```

##  Vulnerability Data Level Check for NZEQ Model


```{r, echo=FALSE, warning=FALSE}

cat(paste0("\n","This is Vulnerability Data Level Check for NAEQ Model, which is performed on ", format(Sys.Date(), format="%B %d, %Y")))

```

## 1. VCC Check 
```{r, echo=FALSE, warning=FALSE}
vcc<-as.data.table(vcc)
imap<-as.data.table(imap)
ConstructionMap<-as.data.table(ConstructionMap)
VCC<-vcc[vcc$country==Country]
IMAP<-imap[imap$country==Country]

CONSTRUCTIONMAP<-ConstructionMap[ConstructionMap$CountryRMSCode==Country]

cat(paste0("\n","VCC Completeness and Correctness check for NAEQ","\n", "1.1:-VCC have ", length(VCC$ConstructionID)," ConstructionIds records, whereas number of ConstructionID per Scheme are as follows:-" ))
cnt<-ddply(CONSTRUCTIONMAP[CONSTRUCTIONMAP$ConstructionID %in% VCC$ConstructionID],~ ConstructionScheme, summarise,Count_CCIds=length(unique(ConstructionID)))
print(cnt)
cat(paste0("verify same with Vulnerability Modelers."),"\n")


##### Check VCC Duplicate Records
cat("\n",paste0("Test 1.2 :- Check duplicity of ConstructionId per combination of ConstructionScheme and ConstructionCode  in VCC table."),"\n")

temp=ddply(CONSTRUCTIONMAP[CONSTRUCTIONMAP$ConstructionID %in% VCC$ConstructionID], .(ConstructionScheme, ConstructionCode),numConstructionClass=length(unique(ConstructionID)))

if(max(temp$numConstructionClass) > 1 ) {cat(paste0("Fail:- The following records are duplicated in VCC: ", temp[temp$numConstructionClass != 1]),"\n")} else{cat(paste0("Pass:- No Construction record is duplicated per Scheme and code."),"\n")}


##### Check VCC mapping --
cat("\n",paste0("Test 1.3:- Verify all Construction id are available globally."),"\n")

if (all(VCC$ConstructionID %in% CONSTRUCTIONMAP$ConstructionID )==F)  {cat(paste0("Fail:-The following records of VCC table do not exist globaly:"),VCC$ConstructionID[!(VCC$ConstructionID%in%CONSTRUCTIONMAP$ConstructionID )],"\n")}else{cat(paste0("Pass:-All VCC records are globally valid."),"\n")}

# if (all(VCC$ConstructionID %in% MAP_CONSTRUCTIONNew$ConstructionID )==F)  {cat(paste0("Fail:-The following records of VCC table do not exist globaly:"),VCC$ConstructionID[!(VCC$ConstructionID%in%MAP_CONSTRUCTIONNew$ConstructionID )],"\n")}else{cat(paste0("Pass:-All VCC records are valid."),"\n")}

######### Consistancy check

VCCComb = paste(VCC$MAPCCLSSIF,VCC$MAPCCTIER1,VCC$MAPCCTIER2,VCC$MAPCCTIER3,sep="_")
IMAPVCC = paste(IMAP$MAPCCLSSIF,IMAP$MAPCCTIER1,IMAP$MAPCCTIER2,IMAP$MAPCCTIER3,sep="_")

#VCC completeness in IMAP
unknownCC<-"-1_-1_-1_-1"
cat("\n",paste0("Test 1.4 :- Check VCC vs IMAP."),"\n")
if ((all(IMAPVCC %in% VCCComb)==F) && (IMAPVCC ==unknownCC)) {cat(paste0("Fail:-The following are the extra records in IMAP table 
in combination of MAPCCLSSIF_MAPCCTIER1_MAPCCTIER2_MAPCCTIER3, which are not implemented in VCC table: "),unique(IMAPVCC[!(IMAPVCC %in% VCCComb)]),"\n")}else{cat(paste0("Pass:-All IMAP records are correctly implemented in VCC table."),"\n")}

VCC$ConstructionID<-as.integer(VCC$ConstructionID)
updated_VCC<-merge(VCC, CONSTRUCTIONMAP, by="ConstructionID", all.x=TRUE)
write.csv(updated_VCC, file="VulnFiles/Updated_VCC.csv")
#cat(paste0("Please contact modeller to verify."),"\n")
```
## 2. VOCC Check 
```{r, echo=FALSE, warning=FALSE}
vocc<-as.data.table(vocc)
VOCC<-vocc[vocc$country==Country]

IMAP<-imap[country==Country]


OccupancyMap<-as.data.table(OccupancyMap)
OCCUPANCYMAP<-OccupancyMap[OccupancyMap$CountryRMSCode==Country]

cat(paste0("2.1:- Counting the number of occupancyID per Scheme:"),"\n")
cat(paste0("\n","VOCC Completeness and Correctness check for NAEQ","\n", "2.1:- VOCC have ", length(VOCC$OccupancyID)," occupancyID records, whereas number of occupancyID per Scheme are as follows:-" ))
cnt<-ddply(OCCUPANCYMAP[OCCUPANCYMAP$OccupancyID %in% VOCC$OccupancyID],~OccupancyScheme,summarise,num_OCCIds=length(unique(OccupancyID)))
print(cnt)
cat(paste0("verify same with Vulnerability Modelers."),"\n")


cat("\n",paste0("Test 2.2:- Check VOCC Duplicate Records."),"\n")
#Duplicates in VOCC
temp=ddply(OCCUPANCYMAP[OCCUPANCYMAP$OccupancyID %in% VCC$OccupancyID], .(OccupancyScheme, OccupancyCode),summarise,numoccupancyClass=length(unique(OccupancyID)))
if(max(temp$numoccupancyClass) > 1 ) {cat(paste0("Fail:-The following records are duplicated in VOCC: ", temp[temp$numoccupancyClass != 1]),"\n")} else{cat(paste0("Pass:-No occupancy records are duplicated per Scheme."),"\n")}


######test 2.3---validate that all construction id are valid and present globally
cat("\n",paste0("Test 2.3:- verify all occupancy id are available globally."),"\n")
######unique occupancy------------matched with mapping database

if (all(VOCC$OccupancyID %in% OccupancyMap$OccupancyID)==F)  {cat(paste0("Fail:-The following records of VOCC table do not exist globaly:"),VOCC$OccupancyID[!(VOCC$OccupancyID%in%OccupancyMap$OccupancyID)],"\n")}else{cat(paste0("Pass:-All VOCC records are valid."),"\n")}


######### checking records of VCC in IMAP
cat("\n",paste0("Test 2.4:- Check VOCC vs IMAP."),"\n")
#IMAP completeness in VOCC
unknownOCC<-"-1"
if ((all(IMAP$INV_OCC %in% VOCC$INV_OCC)==F)  && (IMAP$INV_OCC ==unknownOCC)) {cat(paste0("Fail:-The following are the extra records 
                                                                                          in IMAP table indicated by INV_OCC, which are not implemented in VOCC table: "),unique(IMAP[!(IMAP$INV_OCC %in% VOCC$INV_OCC)]$INV_OCC),"\n")} else{cat(paste0("Pass:-All IMAP records are in VOCC."),"\n")}
#

VOCC$OccupancyID<-as.integer(VOCC$OccupancyID)
updated_VOCC<-merge(VOCC, OCCUPANCYMAP, by="OccupancyID", all.x=TRUE)
write.csv(updated_VOCC, file="VulnFiles/Updated_VOCC.csv")
```

## 3.IMAP Check
```{r, echo=FALSE, warning=FALSE}

vgeo<-as.data.table(vgeo)
vinv<-as.data.table(vinv)
VGEO<-vgeo[vgeo$country==Country]
IMAP<-imap[country==Country]
VINV<-vinv[country==Country]
VCCComb = paste(VCC$MAPCCLSSIF,VCC$MAPCCTIER1,VCC$MAPCCTIER2,VCC$MAPCCTIER3,sep="_")
IMAPVCC = paste(IMAP$MAPCCLSSIF,IMAP$MAPCCTIER1,IMAP$MAPCCTIER2,IMAP$MAPCCTIER3,sep="_")

#IMAP completeness for VCC
cat("\n",paste0("Test 3.1:- Check VCC vs IMAP."),"\n")
if (all(VCCComb %in% IMAPVCC)==F) {cat(paste0("Fail:-Following are the extra records in VCC,
                                              which are not present in IMAP table "),unique(VCCComb[!(VCCComb %in% IMAPVCC)]),"\n")}else{cat(paste0("Pass:-
                                                                                                                                                    All VCC records are present in IMAP table."),"\n")}

cat("\n",paste0("Test 3.2:- Check VOCC vs IMAP."),"\n")
#IMAP completeness for VOCC
if (all(VOCC$INV_OCC %in% IMAP$INV_OCC)==F) {cat(paste0("Fail:- Following are the extra records in VOCC table indicated by INV_OCC, which are not present in IMAP table "),unique(VOCC[!((VOCC$INV_OCC %in% IMAP$INV_OCC))]$INV_OCC),"\n")} else{cat(paste0("Pass:- All VOCC records are present in IMAP table."),"\n")}


#IMAP completeness in VGEO
cat("\n",paste0("Test 3.3:- Check INV_KEY in IMAP table corresponding INV_Key in VGEO."),"\n")

if((all(VGEO$INV_KEY %in% IMAP$INV_KEY)==F)) {cat(paste0("Fail:- Following INV_Key are present in VGEO but not in IMAP: "),unique(VGEO[!(VGEO$INV_KEY %in% IMAP$INV_KEY)]$INV_KEY), "\n")} else {cat(paste0("Pass:-All Inv_key in VGEO are also present in IMAP table"), "\n")}


#####Updated IMAP-----
cat("\n",paste0(" Test 3.4:- Check for multiple records in IMAP with unique combinations of various columns"),"\n")

IMAP$Unique_key<-paste(IMAP$country,IMAP$INV_KEY,IMAP$MAPCCLSSIF, IMAP$MAPCCTIER1, IMAP$MAPCCTIER2, IMAP$MAPCCTIER3, IMAP$HT_TO, IMAP$HT_FROM, IMAP$YR_TO, IMAP$YR_FROM, IMAP$INV_OCC, IMAP$FLOORAREA_FROM, IMAP$FLOORAREA_TO)


write.csv(IMAP, file="VulnFiles/Updated_IMAP.csv")
cat("\n",paste0("Manually verify that Unique key is actually unique in Updated IMAP Table, If Not, IMAP is not correct"))
####################################
cat("\n",paste0(" Test 3.5:- Check VINV vs IMAP."),"\n")


#Check if all unique INV_RECNUM from VINV are present in IMAP

if(all(VINV$INV_RECNUM %in% IMAP$INV_RECNUM)==TRUE){cat(paste0("Pass:- All unique INV_RECNUM of VINV table are present in IMAP table."),"\n")}else{cat(paste0("Fail:- Not all INV_RECNUM in IMAP table are in VINV table. The extra INV_RECNUM are: "),VINV[!VINV$INV_RECNUM %in% IMAP$INV_RECNUM]$INV_RECNUM,"\n")}


cat("\n",paste0(" Test 3.6:- Check for unique ranges of Height 
                and year bands for all INV_OCC records "),"\n")

HT_IMAP<-subset(IMAP, select=c("INV_OCC", "HT_FROM", "HT_TO"))
HT_IMAP$key<-paste(HT_IMAP$INV_OCC, HT_IMAP$HT_FROM, HT_IMAP$HT_TO)

HT_IMAP$HT_key<-paste(HT_IMAP$HT_FROM, HT_IMAP$HT_TO)

c=length(unique(HT_IMAP$key))

a=length(unique(HT_IMAP$INV_OCC)); 
b=length(unique(paste(HT_IMAP$HT_FROM,HT_IMAP$HT_TO)));


if (a*b==c){cat(paste0("Unique and consistent HT band is assigned to each INV_OCC"))} else {cat(paste0("some HT band range is not aplicable for all INV_OCC,Check HT_band.csv for unique ranges of Height, 
                                                                                                       confirm with Modelers if there is any discontinuity","\n"))}

HT_band<-count(HT_IMAP, c("HT_key","INV_OCC"))


write.csv(HT_band, file="VulnFiles/HT_band.csv")

###year band check

IMAP$YR_key<-paste(IMAP$INV_OCC, IMAP$YR_FROM, IMAP$YR_TO)

c2=length(unique(IMAP$YR_key))

a2=length(unique(IMAP$INV_OCC)); 
b2=length(unique(paste(IMAP$YR_FROM,IMAP$YR_TO)));
if (a2*b2==c2){cat(paste0("All Unique and consistent Year band is assigned to each INV_OCC"))} else {cat(paste0("some year band range is not aplicable for all INV_OCC, check YR_band .csv for unique ranges of Year bands, 
                                                                                                                confirm with Modelers if there is any discontinuity","\n"))}

YR_band<-count(IMAP, c("YR_key","INV_OCC"))

write.csv(YR_band, file="VulnFiles/YR_band.csv")


```

## 4. VINV Check
```{r, echo=FALSE, warning=FALSE}
VINV<-vinv[vinv$country==Country]
cat("\n",paste0("Test 4.1:- Check if INV_Recnum of VINV are present in IMAP"),"\n")
if(all(IMAP$INV_RECNUM %in% VINV$INV_RECNUM)==TRUE){cat(paste0("Pass:- All the INV_RECNUM of IMAP table are available in VINV table."),"\n")} else{cat(paste0("Fail:- Not all INV_RECNUM of IMAP table are presentin VINV table. The extra INV_RECNUM are: "),IMAP[!IMAP$INV_RECNUM %in% VINV$INV_RECNUM]$INV_RECNUM,"\n")}

cat("\n",paste0("Test 4.2:- Check if sum of Def_Invpct more than 100% for each INV_RECNUM in VINV table "),"\n")

check=ddply(VINV, .( country, INV_RECNUM), summarise, invpct=sum(as.double(DEF_INVPCT))) 
ordered<-arrange(check, country, as.integer(INV_RECNUM))
ordered<-as.data.table(ordered)

if (TRUE %in% unique(ordered$invpct > 100.11)) {cat(paste0("Fail-some INV_RECNUM have invpct greater than 100 %, check .csv file named INV_over%.csv with Modelers"),"\n")} else
{cat(paste0("Pass:-no INV_RECNUM have invpct more than 100" ),"\n")}

cat("\n",paste0("Test 4.3:- Check if sum of Def_Invpct less than 100% for each INV_RECNUM in VINV table "),"\n")
if (TRUE %in% (unique(ordered$invpct < 99.9)))
{cat(paste0("Fail:- some INV_RECNUM have invpct less than 100%  >>> check .csv file named INV_less%.csv with Modelers & confirm"),"\n")} else {cat(paste0("Pass- all INV_RECNUM have 100 % invpct."), "\n")}
INV_less100<-ordered[(ordered$invpct  < 99.9 )]
INV_over100<-ordered[(ordered$invpct > 100.1)]
write.csv(INV_less100, file="VulnFiles/INV_less100%.csv")
write.csv(INV_over100, file="VulnFiles/INV_over100%.csv")
Count<-length(unique(ordered[(ordered$invpct %in% INV_less100$invpct)]$INV_RECNUM))
cat("\n",paste0(" Records:- There are ", " ", Count, " ", "records, which have INVPCT less than 100%, "," ",  "Find detailed info on invpct in  INV_less100.csv"),"\n")
cat("\n",paste0("Test 4.4:- Unique PDC number in VINV "),"\n")
pdc<-count(VINV, c( "PDC_NUM"))
unique_PDC<-arrange(pdc, as.integer(PDC_NUM))
cont<-length(unique(VINV$PDC_NUM))
write.csv(unique_PDC, file="VulnFiles/unique_PDC.csv")
cat("\n",paste0("Records:- There are", " ", cont ,  " ", "PDC_records,", " ",  "Find unique PDC_NUM in file named unique_pdc.csv"),"\n")


```

## 5. VGEO Check
```{r, echo=FALSE, warning=FALSE}
vgeo<-as.data.table(vgeo)
VGEO<-vgeo[vgeo$country==Country]
# vF0F1<-as.data.table(vF0F1)

#LINK VINV to IMAP to VGEO
cat("\n",paste0("Test 5.1:- Check INV_KEY in IMAP table corresponding INV_Key in VGEO."),"\n")
if((all(IMAP$INV_KEY %in% VGEO$INV_KEY)==F)) {cat(paste0("Fail:- Following INV_Key of IMAP are present not present in VGEO: "),unique(IMAP[!(IMAP$INV_KEY %in% VGEO$INV_KEY)]$INV_KEY), "\n")} else {cat(paste0("Pass:-All Inv_key in IMAP are also present in VGEO table"), "\n")}


#LINK VINV to IMAP to VGEO
cat("\n",paste0("Test 5.2 :- Check BI_key in VGEO vs VBI"),"\n")
if (all(VGEO$BI_key %in% vbi$BI_key)==F) {cat(paste0("Fail:- Following are the extra records in vbi table indicated by BI_key, which are not present in VGEO table "),unique(VGEO[!((VGEO$BI_key %in% vbi$BI_key))]$BI_key),"\n")} else{cat(paste0("Pass:- All BI_key records are present in VGEO vs VBI table."),"\n")}

cat("\n",paste0("Test 5.3:- Check 'DC_Key' in VGEO vs vFoF1 table."),"\n")
# if (all(VGEO$DC_key %in% vF0F1$DC_key)==F) {cat(paste0("Fail:- Following are the extra records in vFoF1 table indicated by DC_key, which are not present in VGEO table "),unique(VGEO[!((VGEO$DC_key %in% vF0F1$DC_key))]$DC_key),"\n")} else{cat(paste0("Pass:- All DC_key records are present in VGEO vs vF0F1 table."),"\n")}

write.csv(VGEO, file="VulnFiles/VGEO.csv")
```

## 6. VCV Check
```{r, echo=FALSE, warning=FALSE}
vcv<-as.data.table(vcv)
VCV<-vcv[country==Country]
cat(paste0("Test 6.1 :- To check if VCV table and IMAP table have the same CV_KEY.","\n"))

#Check if all the CV_KEY in IMAP are in vcv
if(all(IMAP$CV_KEY %in% vcv$CV_KEY)){cat(paste0("\n","a). Pass:-All the CV_KEY in the IMAP table are in VCV table."),"\n")} else{cat(paste0("a).Fail:-Not all CV_KEY in IMAP table are in VCV table. The extra CV_KEY are: "),IMAP[!IMAP$CV_KEY %in% vcv$CV_KEY]$CV_KEY,"\n")}

#Check if all the CV_KEY in vcv are in IMAP
if(all(vcv$CV_KEY %in% IMAP$CV_KEY)){cat(paste0("\n","b). Pass:-All the CV_KEY in the vcv table are in IMAP table."),"\n")}else{cat(paste0("b).Fail:-Not all CV_KEY in IMAP table are in vcv table. The extra CV_KEY are: "),vcv[!vcv$CV_KEY %in% IMAP$CV_KEY]$CV_KEY,"\n")}

#Make sure CV_HAZARD <= CV_TOTAL
cat(paste0("\n","Test 6.2:- To see if all the CV_Hazard values are no bigger than their corresponding CV_TOTAL values.","\n"))
vcvnumeric = transform(vcv,CV_HAZARD=as.numeric(CV_HAZARD),CV_TOTAL=as.numeric(CV_TOTAL))
vcvnumeric =data.table(vcvnumeric)
vcvnumeric$CV_DIFF = 100*(vcvnumeric$CV_TOTAL - vcvnumeric$CV_HAZARD)

if(unique(vcvnumeric$CV_DIFF < 0) ==F){
  cat(paste0("Pass:-All the CV_TOTAL values are no less than their corresponding CV_HAZARD values in the vcv table."),"\n")
}else{cat(paste0("Fail:-The following CV_TOTAL values are less than their corresponding CV_HAZARD values in the vcv table: "),subset(vcvnumeric,CV_DIFF < 0),"\n")}

write.csv(vcv[vcv$country==Country], file="VulnFiles/VCV.csv")
```



## 7. VDC Check for all Shake
```{r, echo=FALSE, warning=FALSE}
cghs<-as.data.table(cghs)
CGHS<-cghs[country==Country]

cat("\n",paste0("Test 7.1:- check for Unique combinations of PDC, CGHSID, DCkey number in VDC "),"\n")

# VulBIndexSU$Unique_key<-paste(VulBIndexSU$PDC_NUM,VulBIndexSU$DCKey,VulBIndexSU$CGHSID,sep="_" )
# VulBIndexWI$Unique_key<-paste(VulBIndexWI$PDC_NUM,VulBIndexWI$DCKey,VulBIndexWI$CGHSID, sep="_")
# VulBIndexFL$Unique_key<-paste(VulBIndexFL$PDC_NUM,VulBIndexFL$DCKey,VulBIndexFL$CGHSID, sep="_")
# 
# 
# 
# write.csv(VulBIndexWI, file="VulnFiles/Updated_VulBIndexWI.csv")
# write.csv(VulBIndexSU, file="VulnFiles/Updated_VulBIndexSU.csv")
# write.csv(VulBIndexFL, file="VulnFiles/Updated_VulBIndexFL.csv")

cat("\n",paste0("Manually verify that Unique_key is actually unique in Updated_VulBIndexWI, Updated_VulBIndexSU, Updated_VulBIndexFL csv files inside Vuln_files folder, If yes then This test case is Pass, otherwise Fail"),"\n")

cat("\n",paste0("Test 7.2:- unique 'CGHSId' info in vdc Wind"),"\n")
CGHSID<-count(vdc0, c("CGHS_ID"))
print(CGHSID)

cat("\n",paste0("Test 7.3:- check if unique 'CGHSId' in VDC Windtable are all available in CGHS table"),"\n")
if((all(vdc0$CGHS_ID %in% CGHS$CGHS_ID))==T){cat(paste0("Pass:-All the CGHSID of vdc table are available in CGHS table."),"\n")} else{cat(paste0("Fail:-Following CGHSID of VDC Wind table are not availble in CGHS table:"), unique(vdc0[!(vdc0$CGHS_ID %in% CGHS$CGHS_ID)]$CGHS_ID),"\n")}

# if((all(vdcSU$CGHSID %in% CGHS$CGHS_ID))==T){cat(paste0("Pass:-All the CGHSID of vdc Surge table are available in CGHS table."),"\n")} else{cat(paste0("Fail:-Following CGHSID of VDC Surge table are not availble in CGHS table:"), unique(vdcSU[!(vdcSU$CGHSID %in% CGHS$CGHS_ID)]$CGHSID),"\n")}
# 
# if((all(vdcFL$CGHSID %in% CGHS$CGHS_ID))==T){cat(paste0("Pass:-All the CGHSID of vdc Flood table are available in CGHS table."),"\n")} else{cat(paste0("Fail:-Following CGHSID of VDC Flood table are not availble in CGHS table:"), unique(vdcFL[!(vdcFL$CGHSID %in% CGHS$CGHS_ID)]$CGHSID),"\n")}

cat("\n",paste0("Test 7.4:- Check if count of 'CGHSId'  for PDC_NUM is same in vdc "),"\n")
checkWI=ddply(vdc0, .(PDC_NUM), summarise, CGHScount=length(CGHSID))
if((length(unique(checkWI$CGHScount))==1) %in% T){cat(paste0("Pass:-Count of CGHSID for each PDC_NUM is same in Vdc Wind  table."),"\n")} else{cat(paste0("Fail:-all PDC_NUM do not have same count of CGHS ID in Vdc table, see summary for detail:"),"\n",summary(checkWI),"\n")}
summary(checkWI)
# checkSU=ddply(vdcSU, .(PDC_NUM), summarise, CGHScount=length(CGHSID))
# if((length(unique(checkSU$CGHScount))==1) %in% T){cat(paste0("Pass:-Count of CGHSID for each PDC_NUM is same in Vdc Surge  table."),"\n")} else{cat(paste0("Fail:-all PDC_NUM do not have same count of CGHS ID in Vdc table, see summary for detail:"),"\n",summary(checkSU),"\n")}
# summary(checkSU)
# 
# checkFL=ddply(vdcFL, .(PDC_NUM), summarise, CGHScount=length(CGHSID))
# if((length(unique(checkFL$CGHScount))==1) %in% T){cat(paste0("Pass:-Count of CGHSID for each PDC_NUM is same in Vdc Flood  table."),"\n")} else{cat(paste0("Fail:-all PDC_NUM do not have same count of CGHS ID in Vdc table, see summary for detail:"),"\n",summary(checkFL),"\n")}
# summary(checkFL)


# cat("\n",paste0("Test 7.5:-check if distinct count of HAZ_sev for each Index is same "),"\n")
# 
# HazWI<-count(vdc0, c("Index","HazSev"))
# 
# countcheckWI=ddply(HazWI, .(Index), summarise, HazSev_count=length(unique(HazSev)))
# 
# if((length(unique(countcheckWI$HazSev_count))==1) %in% T){cat(paste0("Pass:-Count of HazSev values for each Index is same in Vdc Wind table."),"\n")} else{cat(paste0("Fail:-all Index do not have same count of HazSev values in Vdc Wind table, see summary for detail:"),"\n",summary(countcheckWI),"\n")}


# HazSU<-count(vdcSU, c("Index","HazSev"))
# 
# countcheckSU=ddply(HazSU, .(Index), summarise, HazSev_count=length(unique(HazSev)))
# 
# if((length(unique(countcheckSU$HazSev_count))==1) %in% T){cat(paste0("Pass:-Count of HazSev values for each Index is same in Vdc Surge table."),"\n")} else{cat(paste0("Fail:-all Index do not have same count of HazSev values in Vdc Surge table, see summary for detail:"),"\n",summary(countcheckSU),"\n")}
# 
# HazFL<-count(vdcFL, c("Index","HazSev"))
# 
# countcheckFL=ddply(HazFL, .(Index), summarise, HazSev_count=length(unique(HazSev)))

# if((length(unique(countcheckFL$HazSev_count))==1) %in% T){cat(paste0("Pass:-Count of HazSev values for each Index is same in Vdc Flood table."),"\n")} else{cat(paste0("Fail:-all Index do not have same count of HazSev values in Vdc Flood table, see summary for detail:"),"\n",summary(countcheckFL),"\n")}
# cat("\n", paste0("Test 7.6:-PDC number completeness in VDC as compared to VINV Table.:"),"\n")

if(all(VINV$PDC_NUM %in% vdc0$PDC_NUM)==F){cat(paste0("Fail:Following PDC_NUM of VINV are not available in VDC for Wind:"), unique(VINV[!(VINV$PDC_NUM %in% vdc0$PDC_NUM)]$PDC_NUM),"\n")} else{cat(paste0("Pass for Wind:- All the PDC of VINV table are available in VDC WIND table."),"\n")}

# if(all(VINV$PDC_NUM %in% vdcSU$PDC_NUM)==F){cat(paste0("Fail:Following PDC_NUM of VINV are not available in VDC for SURGE:"), unique(VINV[!(VINV$PDC_NUM %in% vdcSU$PDC_NUM)]$PDC_NUM),"\n")} else{cat(paste0("Pass for Surge:- All the PDC of VINV table are available in VDC SURGE table."),"\n")}
# 
# if(all(VINV$PDC_NUM %in% vdcFL$PDC_NUM)==F){cat(paste0("Fail:Following PDC_NUM of VINV are not available in VDC for Flood:"), unique(VINV[!(VINV$PDC_NUM %in% vdcFL$PDC_NUM)]$PDC_NUM),"\n")} else{cat(paste0("Pass for Flood:- All the PDC of VINV table are available in VDC Flood table."),"\n")}


cat("\n", paste0("Test 7.7:-DC key completeness check in VDC as compared to VGEO Table.:"),"\n")

if(all(VGEO$DC_KEY %in% vdc0$DCKey)==F){cat(paste0("Fail:Following DC_KEY of VGEO are not available in VDC for Wind subperil:"), unique(VGEO[!(VGEO$DC_KEY %in% vdc0$DCKey)]$DC_KEY),"\n")} else{cat(paste0("Pass:- All the DC key of VGEO table are available in VDC WI table."),"\n")}

# if(all(VGEO$DC_KEY %in% vdcSU$DCKey)==F){cat(paste0("Fail:Following DC_KEY of VGEO are not available in VDC for SURGE subperil:"), unique(VGEO[!(VGEO$DC_KEY %in% vdcSU$DCKey)]$DC_KEY),"\n")} else{cat(paste0("Pass:- All the DC key of VGEO table are available in VDC SU table."),"\n")}
# 
# if(all(VGEO$DC_KEY %in% vdcFL$DCKey)==F){cat(paste0("Fail:Following DC_KEY of VGEO are not available in VDC for Flood subperil:"), unique(VGEO[!(VGEO$DC_KEY %in% vdcFL$DCKey)]$DC_KEY),"\n")} else{cat(paste0("Pass:- All the DC key of VGEO table are available in VDC FL table."),"\n")}

if(all(vdc0$DC_KEY  %in% VGEO$DC_KEY)==F){cat(paste0("Fail:Following DC_KEY of vdc are not available in VGEO for Wind subperil:"), unique(vdc0[!(vdc0$DC_KEY  %in% VGEO$DC_KEY)]$DC_KEY),"\n")} else{cat(paste0("Pass:- All the DC key of vdc Wind table are available in VGEO  WI table."),"\n")}



#write.csv(vdc0, file="VulnFiles/VDC_WI.csv")
#write.csv(vdcSU, file="VulnFiles/VDC_SU.csv")
#write.csv(vdcFL, file="VulnFiles/VDC_FL.csv")

#write.csv(vdc,paste0(outdir,"VDC_Tables",".csv"), row.names=F)
```


## 8.VHSR and CGHS Check
```{r, echo=FALSE, warning=FALSE}
vds<-as.data.table(vds)
cat("\n", paste0("Test 8.1:- All subperil's CGHS_ID of Structure coverage in CGHS table are available in VHSR table:"),"\n")

CGHSnumeric = transform(CGHS,CGHSID=as.numeric(CGHS_ID))
CGHSnumeric =as.data.table(CGHSnumeric)
CGHS<-CGHSnumeric[country==Country]
write.csv(CGHS, file="VulnFiles/CGHS.csv")

VHSR<-as.data.table(unique(as.integer(vhsr$CGHS_ID)))
write.csv(VHSR, file="VulnFiles/VHSR.csv")
haztype_id<-Map_HazardType$haz_type_id[Map_HazardType$haz_type %in% subperil]
CGHS_subperil<-CGHS[CGHS$HAZ_TYPE %in% haztype_id & (CGHS$COVERAGE==1)]
mismatch_vhsr<-as.data.table(CGHS_subperil[!(CGHS_subperil$CGHS_ID %in% VHSR$CGHS_ID)])

if ((all(CGHS_subperil$CGHS_ID %in% VHSR$CGHS_ID))==FALSE){cat(paste0("Fail:-Some CGHS_ID of CGHS table are not available in vhsr table, their details are given below : "), CGHS_subperil[!(CGHS_subperil$CGHS_ID %in% VHSR$CGHS_ID)]$CGHS_ID, "\n")} else{cat(paste0("Pass:-CGHSid of Coverage type 1 for all subperils  are available in vhsr table."),"\n")}

#print(mismatch_vhsr)

cat("\n", paste0("Test 8.2:- All subperil's CGHS_ID of Structure coverage in CGHS table are available in VDS table:"),"\n")

VDS<-vds[vds$country==Country]
CGHS_COV=CGHS[CGHS$COVERAGE==1]
mismatch_vds<-as.data.table(unique(CGHS_COV[!(CGHS_COV$CGHS_ID %in% VDS$CGHS_ID)]))
if ((all(CGHS_COV$CGHS_ID %in% vds$CGHS_ID))==FALSE){cat(paste0("Fail:-The following CGHS_ID of CGHS table of coverage type 1 are not available in vds table: "), unique(CGHS_COV[!(CGHS_COV$CGHS_ID %in% vds$CGHS_ID)]$CGHS_ID),"\n")} else{cat(paste0("Pass:-CGHSid of Coverage type 1 for all subperils  are available in VDS table."),"\n")}


print(mismatch_vds$CGHS_ID)
```

## 9. BI Data Check 
```{r, echo=FALSE, warning=FALSE}
vbi<-as.data.table(vbi)
bidc<-as.data.table(bidc)
vbimod<-as.data.table(vbimod)
VBI<-vbi[vbi$country==Country]
# BIDC<-bidc[country==Country]
VBIMOD<-vbimod[country==Country]

cat(paste0("9.1:- BI Key consistancy check:"),"\n")

cat(paste0("9.1.1:- BI Key consistancy in VBI from VGEO table:"),"\n")

if ((all(VGEO$BI_KEY %in% VBI$BI_KEY))==FALSE){cat(paste0("Fail:-The following BI_KEY of VGEO table are not available in VBI table: "), unique(VGEO[!(VGEO$BI_KEY %in% VBI$BI_KEY)]$BI_KEY),"\n")} else{cat(paste0("Pass:-All BI_KEY are correctly implemented in VBI table."),"\n")}

# cat(paste0("9.1.2:- BI Key consistancy in BIDC from VGEO table:"),"\n")
# 
# if ((all(VGEO$BI_KEY %in% BIDC$BI_KEY))==FALSE){cat(paste0("Fail:-The following BI_KEY of VGEO table are not available in BIDC table: "), unique(VGEO[!(VGEO$BI_KEY %in% BIDC$BI_KEY)]$BI_KEY),"\n")} else{cat(paste0("Pass:-All BI_KEY are correctly implemented in BIDC table."),"\n")}

cat(paste0("9.1.3:- BI Key consistancy in VBIMOD from VGEO table:"),"\n")

if ((all(VGEO$BI_KEY %in% VBIMOD$BI_KEY))==FALSE){cat(paste0("Fail:-The following BI_KEY of VGEO table are not available in VBIMOD table: "), unique(VGEO[!(VGEO$BI_KEY %in% VBIMOD$BI_KEY)]$BI_KEY),"\n")} else{cat(paste0("Pass:-All BI_KEY are correctly implemented in VBIMOD table."),"\n")}

cat(paste0("9.2:- BI OCC consistancy check:"),"\n")

cat(paste0("9.1.1:- BI OCC consistancy in VBI from VOCC table:"),"\n")

if ((all(VOCC$BI_OCC %in% VBI$BI_OCC))==FALSE){cat(paste0("Fail:-The following BI_OCC of VOCC table are not available in VBI table: "), unique(VOCC[!(VOCC$BI_OCC %in% VBI$BI_OCC)]$BI_OCC),"\n")} else{cat(paste0("Pass:-All BI_OCC are correctly implemented in VBI table."),"\n")}

# cat(paste0("9.1.2:- BI Key consistancy in BIDC from VGEO table:"),"\n")
# 
# if ((all(VOCC$BI_OCC %in% BIDC$BI_OCC))==FALSE){cat(paste0("Fail:-The following BI_OCC of VOCC table are not available in BIDC table: "), unique(VOCC[!(VOCC$BI_OCC %in% BIDC$BI_OCC)]$BI_OCC),"\n")} else{cat(paste0("Pass:- All BI_OCC are correctly implemented in BIDC table."),"\n")}

cat(paste0("9.1.3:- BI Key consistancy in VBIMOD from VGEO table:"),"\n")

if ((all(VOCC$BI_OCC %in% VBIMOD$BI_OCC))==FALSE){cat(paste0("Info:-The following BI_OCC of VGEO table are not available in VBIMOD table: "), unique(VOCC[!(VOCC$BI_OCC %in% VBIMOD$BI_OCC)]$BI_OCC),"\n")} else{cat(paste0("All BI_OCC are correctly implemented in VBIMOD table."),"\n")}
```

## 9. Sec Modif Data Check 
```{r, echo=FALSE, warning=FALSE}
mdsc<-as.data.table(mdsc)
odsc<-as.data.table(odsc)

MDSC<-mdsc[country==Country]
ODSC<-odsc[country==Country]
VBIMOD<-vbimod[country==Country]
cat(paste0("10.1:- Checking Sec modif per Damage stateId in VBI vs VBIMOD table :"),"\n")

if ((all(VBI$DSTATEID %in% VBIMOD$DSTATEID))==FALSE){cat(paste0("Info:-The following DSTATEID of VBI table are not assigned with any Modif_NUM in VBIMOD table: "), unique(VBI[!(VBI$DSTATEID %in% VBIMOD$DSTATEID)]$DSTATEID),"\n")} else{cat(paste0("Pass:-All DSTATEID of VBI table are available in VBIMOD table."),"\n")}


cat(paste0("10.2:- Checking  modif_Num consistancy in Mdsc from vbimod :"),"\n")

if ((all(VBIMOD$MODIF_NUM %in% MDSC$MODIF_NUM))==FALSE){cat(paste0("Fail:-The following MODIF_NUM of VBIMOD table are not available in MDSC table: "), unique(VBIMOD[!(VBIMOD$MODIF_NUM %in% MDSC$MODIF_NUM)]$MODIF_NUM),"\n")} else{cat(paste0("Pass:-All MODIF_NUM are are available in MDSC table."),"\n")}

cat(paste0("10.3:- Checking  modif_Num consistancy in odsc from mdsc :"),"\n")

if ((all(MDSC$MODIF_NUM %in% ODSC$MODIF_NUM))==FALSE){cat(paste0("Fail:-The following MODIF_NUM of MDSC table are not available in ODSC table: "), unique(MDSC[!(MDSC$MODIF_NUM %in% ODSC$MODIF_NUM)]$MODIF_NUM),"\n")} else{cat(paste0("Pass:-All MODIF_NUM of MDSC are available in ODSC table."),"\n")}


cat(paste0("10.4:- Checking consistancy of modif_Num and Option_Num combination in odsc from vbimod :"),"\n")
VBIMOD$Key<-paste(VBIMOD$MODIF_NUM,VBIMOD$OPTION_NUM,sep="_")
ODSC$Key<-paste(ODSC$MODIF_NUM,ODSC$OPTION_NUM,sep="_")

if ((all(VBIMOD$Key %in% ODSC$Key))==FALSE){cat(paste0("Fail:-The following combination of MODIF_NUM with OPTION_NUM of VBIMOD table are not available in ODSC table: "), unique(VBIMOD[!(VBIMOD$Key %in% ODSC$Key)]$Key),"\n")} else{cat(paste0("Pass:-All combination of MODIF_NUM  with OPTION_NUM  in VBIMOD table are available in ODSC table."),"\n")}

endtime=Sys.time()
print("Finished Vulnerability Data level check" )
print(endtime-starttime)
```

