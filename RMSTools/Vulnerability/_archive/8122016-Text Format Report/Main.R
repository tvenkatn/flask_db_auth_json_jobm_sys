#Developed by Mohammad Razavi June-2016


rm(list=ls())
cat("\014")
cat("\n")
c=Sys.time()

# Data Entry from the Batch file
userArgs <- commandArgs(trailingOnly = TRUE)
db <- userArgs[1]
ser <- userArgs[2]
uid <- userArgs[3]
pwd <- userArgs[4]



cat(paste0(userArgs[1],"\n",userArgs[2],"\n",userArgs[3],"\n",userArgs[4],"\n"))
# Data Entry for this test

# #db <- "RMS_VULN_NAEQ_v6a_SL_YrMod_NG_BIiter0" 
# #db <- "RMS_VULNERABILITY" 
db <- "RMS_VULN_NAEQ_v7a_NG" 
# db <- "RMS_VUL_RL17_2e_0721" 
ser <- "CAWD16744\\MSSQLSERVER1"
# ser <- "cadt0997"

uid <- "sa"
pwd <- "Rmsuser!"

# Defining Functions
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE,quietly = TRUE)
}

#This function checks the case sensitivity of the values in a column of table (Upper and Lower case)
CaseCheck<- function (tablename,columnname){
  
  return(data.table(sqlQuery(dbHandle,paste("
select distinct ",columnname," Collate Latin1_General_CS_AI  from ",tablename,"
except
select distinct ",columnname, "from", tablename
                                            
  ))))
}

#This function reads n character from the right side of a string
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}



# Importing required packages
packages <- c("yaml", "data.table","RODBC","sqldf","knitr")
ipak(packages)

cwd <- getwd()

cat("Reading VulnCache ...")
cat("\n")

cat(paste0("driver={SQL Server};
                                          server=",ser,";
                                          database=",db,";
                                          ;uid=",uid,";pwd=",pwd))

##Import the database  
dbHandle <- odbcDriverConnect(paste0("driver={SQL Server};
                                          server=",ser,";
                                          database=",db,";
                                          ;uid=",uid,";pwd=",pwd))

dbHandle2 <- odbcDriverConnect(paste0("driver={SQL Server};
                                          server=",ser,";
                                          database=","RMS_NGGeography",";
                                          ;uid=",uid,";pwd=",pwd))

############ Create the Log-file
cat("Creating log file \n")

tStamp <- as.character(format(Sys.time(), "%Y%m%d_%Hh%Mm%Ss"))

if(file.exists(paste0("log/Report_",tStamp,".txt"))){
  reportCon <- file(paste0("log/Report_",tStamp,".txt"),open="a") 
}else {
  reportCon <- file(paste0("log/Report_",tStamp,".txt"),open="a")}

cat(paste0("\n",'THIS TOOL TESTS THE INTEGRITY OF THE VULNERABILITY DATABASE AND VERIFIES THAT THE DATA',"\n", 
           'IS PROPERLY TRANSFERRED BETWEEN RISKLINK TABLES AND NEXT GENERATION (NG) TABLES.','\n'), file = reportCon, append = TRUE) 



# Import all tables for the sql database
tables <- sqlTables(dbHandle, schema - dbo) # import all database tables names 
tables = data.table(tables)

# Read List of Expected Vulnurability Tables from CSV file

VulnDb_ExpectedTables <- data.table(read.csv(file=paste0("Data/VulnDb_ExpectedTables.csv")))


listofNGtables= c('vll','cghs','fliinv','imap','LandMDR','LiqMDR','mdsc','odsc','vbi','vbimod','vbrdr','vbrtv',
                'vcc','vcv','vdc0','vds','vgeo','vhsr','vinv','vinvaghaz','vlif','vlifelinebi','vlifelinebidc',
                'vocc','vparam','vrs','vvrggeo')



###TEST-0: DATABASE INFORMATION
##### Check if database includes  both RiskLink and NG Tables or only includes RiskLink Tables
Test_0 <- function (dbHandle,reportCon) {

cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-0: DATABASE INFORMATION',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)


# Import all tables from the sql database
tables <- sqlTables(dbHandle, schema - dbo) # import all database tables names 
tables = data.table(tables)




Perils <- unique(substring(tables[like(tolower(TABLE_NAME),"imap") & tolower(TABLE_NAME)!="imap"]$TABLE_NAME,1,2))
Countries <- unique(substrRight(tables[like(tolower(TABLE_NAME),"imap") & tolower(TABLE_NAME)!="imap"]$TABLE_NAME,2))


if (length(Perils)==0){
  cat(paste0("      ",'DATABASE DOES NOT INCLUDE RISKLINK TABLES!','\n'), file = reportCon, append = TRUE)
  RiskLinkTableExist<- FALSE
   } else {
     RiskLinkTableExist<- TRUE
  cat(paste0("      ","LIST OF COUNTRIES:", "\n"), file = reportCon, append = TRUE) 
  cat(paste0("      ",Countries, "\n" ), file = reportCon, append = TRUE) 
  cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n","\n"), file = reportCon, append = TRUE)
  
  cat(paste0("      ","LIST OF PERILS:", "\n"), file = reportCon, append = TRUE) 
  cat(paste0("      ",Perils, "\n"), file = reportCon, append = TRUE) 
  cat(paste0("\n","      ",'DATABASE INCLUDES RISKLINK TABLES!','\n'), file = reportCon, append = TRUE)   
  cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n","\n"), file = reportCon, append = TRUE)
  
}



if ("vcc" %in% tables$TABLE_NAME){
  cat(paste0("      ",'DATABASE INCLUDES NG TABLES!','\n'), file = reportCon, append = TRUE) 
  NGTableExist<-TRUE
} else {
  cat(paste0("      ",'DATABASE DOES NOT INCLUDE NG TABLES!','\n'), file = reportCon, append = TRUE) 
  NGTableExist<-FALSE
}

return(list('Peril' = Perils,'Country' = Countries,'RLTableExtst' = RiskLinkTableExist,'NGTableExist'=NGTableExist))

}

###TEST-1: TABLES AVAILABILITY
##### Check if all required tables are included in the database
Test_1<- function (dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,listofNGtables,NGTableExist) {
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-1: TABLES AVAILABILITY',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)




# check if all needed tables  exist in the imported database  


nPerils=length(Perils)
nCountries=length(Countries)

nmissingtable=0


for (i in 1:nCountries){
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
    for (k in 1:length(Tables_Required)){
        if (tolower(Tables_Required[k]) %in% tolower(tables$TABLE_NAME)){
          # cat(paste0(listoftables[i],' exists in the imported database.','\n'), file = reportCon, append = TRUE)
        } else {
          nmissingtable=nmissingtable+1
          cat(paste0("      ",Tables_Required[k],' does not exist in the imported database.','\n'), file = reportCon, append = TRUE) 
        }
      }
    }

      
    
    
  }
  
  
}


if (nmissingtable==0) {
  cat(paste0("      ","PASSED! ALL REQUIRED RISKLINK TABLES ARE AVAILABLE!",'\n'), file = reportCon, append = TRUE) 
  }



if (NGTableExist){
  nNGmissing=0
  nNGtables=length(listofNGtables)
  for (i in 1:nNGtables){
    if (tolower(listofNGtables[i]) %in% tables$TABLE_NAME){
      # cat(paste0(listoftables[i],' exists in the imported database.','\n'), file = reportCon, append = TRUE)
    } else {
      nNGmissing=nNGmissing+1
      cat(paste0("      ",listofNGtables[i],' does not exist in the imported database.','\n'), file = reportCon, append = TRUE) 
    }
    
  }

  if (nNGmissing==0) {
    cat(paste0("      ","PASSED! ALL REQUIRED NG TABLES ARE AVAILABLE!"), file = reportCon, append = TRUE) 
  }
  
}
}

###TEST-2: EMPTY TABLES
# Check if any of imported tables are empty:
Test_2 <- function (dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,listofNGtables,NGTableExist){

cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-2: EMPTY TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nEmptyTable=0


nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries){
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    for (k in 1:length(Tables_Required)){
      dummycount=sqlQuery(dbHandle, paste0("Select count(*) from ",Tables_Required[k]))
      if (dummycount==0){
        nEmptyTable=nEmptyTable+1
        cat(paste0('      ',Tables_Required[k],'\n'), file = reportCon, append = TRUE)
      }
      
    }
  }
  
}

if (nEmptyTable==0) {cat(paste0("      ","PASSED! THERE IS NO EMPTY RISKLINK TABLE!"), file = reportCon, append = TRUE) }


if (NGTableExist){
  nEmptyTable=0
  nNGtables=length(listofNGtables)
  for (i in 1:nNGtables){
    dummycount=sqlQuery(dbHandle, paste0("Select count(*) from ",listofNGtables[i]))
    if (dummycount==0){
      nEmptyTable=nEmptyTable+1
      cat(paste0('      ',listofNGtables[i],'\n'), file = reportCon, append = TRUE)
    } 
    
  }
  
  if (nEmptyTable==0) {
    cat(paste0("      ","PASSED! THERE IS NO EMPTY NG TABLE!"), file = reportCon, append = TRUE) 
  }
  
}





}

###TEST-3: Risk Link TABLES without Index
Test_3 <- function (dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables){

cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-3: TEST OF RISKLINK TABLES WITH NO INDEX',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)



nmissingindex=0

nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
  {
  for (j in 1:nPerils)
    {
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    for (k in 1:length(Tables_Required))
      {
      dummyname=paste0("'",Tables_Required[k],"'",collapse="")
      dummytable = data.table(sqlQuery(dbHandle,paste0("SELECT name FROM sys.tables WHERE OBJECTPROPERTY(object_id,'IsIndexed') = 0 and name=",dummyname)))
      nonindex=nrow(dummytable)
      if (nonindex==1)
        {
        nmissingindex=nmissingindex+1
        cat(paste0("      ",Tables_Required[k],'\n'), file = reportCon, append = TRUE) 
        }      
     }
      
    }
  }


if (nmissingindex==0) {cat(paste0("      ","PASSED! ALL RISKLINK TABLES ARE INDEXED!"), file = reportCon, append = TRUE) }

  
}

###TEST-4: COMPARISON OF NUMBER OF ROWS IN CORRESPONDING TABLES
# Compare number of rows in various tables :
Test_4 <- function (dbHandle,reportCon,Perils,Countries,listofNGtables) {

cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-4: COMPARISON OF NUMBER OF ROWS IN CORRESPONDING TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nNotEqualRow=0



nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
{
  for (j in 1:nPerils)
  {
    nNGRow=0
    nRiskLinkRow=0
    for (k in 1:length(listofNGtables))
    {
      dummyname=paste0(Perils[j],listofNGtables[k],Countries[i],collapse="")
      dummyCountryName=paste0("'",Countries[i],"'",collapse="")
      nRiskLinkRow =sqlQuery(dbHandle,paste0("SELECT COUNT(*) FROM ", dummyname))
      nNGRow = sqlQuery(dbHandle,paste0("SELECT COUNT(*) FROM ", listofNGtables[k], "WHERE country=",dummyCountryName))
      
    }
                
       if (nRiskLinkRow!=nNGRow  & !is.null(nRiskLinkRow) & is.null(nNGRow!=NULL))
      {
         nNotEqualRow=nNotEqualRow+1
        cat(paste0("      ",listofNGtables[k],"      ",dummyname, '\n'), file = reportCon, append = TRUE) 
      }      
   
    
  }
}


if (nNotEqualRow==0) {cat(paste0("      ","PASSED! NUMBER OR ROWS IN ALL CORRESPONDING TABLES MATCHES!"), file = reportCon, append = TRUE) }
}

#### TEST-5:TEST VGEO AND EQVGEO TABLES
#### Check vgeo and eqvgeo tables 
Test_5 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-5:TEST VGEO AND PPVGEOCC TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

# Check for duplicates in postal codes

nPerils=length(Perils)
nCountries=length(Countries)
i=1
for (i in 1:nCountries)
{
  dummyname=paste0("'",Countries[i],"'",collapse="")
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  
vgeo_duplicates = data.table(sqlQuery(dbHandle, paste0("SELECT
                                                      POSTALCODE, COUNT(*)
                                                  FROM
                                                      vgeo
                                                  WHERE
                                                    POSTALCODE IS NOT NULL
                                                    and 
                                                    country=",dummyname,"
                                                  GROUP BY
                                                       POSTALCODE 
                                                  HAVING 
                                                      COUNT(*) > 1
                                                  ")))

nvgeo_duplicate=nrow(vgeo_duplicates)

if (nvgeo_duplicate!=0){
cat(paste0("      ","Numberof Duplicate Postalcodes =",nvgeo_duplicate,"\n"), file = reportCon, append = TRUE)
cat(paste0("      ","Dupicate Postal Codes Are:","\n"), file = reportCon, append = TRUE)
cat(paste0("      ",vgeo_duplicates[,1,with=FALSE]), file = reportCon, append = TRUE)
} else {cat(paste0("      ","Passed! No Duplicate Postalcodes!","\n"), file = reportCon, append = TRUE)}
cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)


# check for number of distinct states 
nvgeo_admin1=data.table(sqlQuery(dbHandle, paste0("select distinct Admin1Code as state from vgeo where admin1code is not null and country=",dummyname)))
cat(paste0("\n","\n","      ","Numberof Distinct Admin1Code (States) =",nrow(nvgeo_admin1),"\n"), file = reportCon, append = TRUE)
nNGGeog_admin1=data.table(sqlQuery(dbHandle2, paste0("SELECT  distinct CODE as state FROM [RMS_NGGeography].[dbo].[a1geolookup] where FIPS=",dummyname)))
Admin1Diff<- nNGGeog_admin1[!(state %in% nvgeo_admin1$state)]
#if (nrow(nNGGeog_admin1)!=nrow(nvgeo_admin1)){
if (nrow(Admin1Diff)!=0){
cat(paste0("      ","Numberof Distinct Admin1Code based on NG-Geography =",nrow(nNGGeog_admin1),"\n"), file = reportCon, append = TRUE)
cat(paste0("      ","Differece(s) between the database and NGGeography include:",Admin1Diff$state,"\n"), file = reportCon, append = TRUE)

}
cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)



# check for number of distinct counties 
nvgeo_admin2=data.table(sqlQuery(dbHandle, paste0("select distinct Admin2Code as state from vgeo where admin1code is not null and country=",dummyname)))
cat(paste0("\n","\n","      ","Numberof Distinct Admin2Code (Counties) =",nrow(nvgeo_admin2),"\n"), file = reportCon, append = TRUE)
nNGGeog_admin2=data.table(sqlQuery(dbHandle2, paste0("SELECT  distinct CODE as state FROM [RMS_NGGeography].[dbo].[a2geolookup] where FIPS=",dummyname)))
Admin2Diff<- nNGGeog_admin2[!(state %in% nvgeo_admin2$state)]
#if (nrow(nNGGeog_admin1)!=nrow(nvgeo_admin1)){
if (nrow(Admin2Diff)!=0){
  cat(paste0("      ","Numberof Distinct Admin2Code based on NG-Geography =",nrow(nNGGeog_admin2),"\n"), file = reportCon, append = TRUE)
  cat(paste0("      ","Differece(s) between the database and NGGeography include:","\n"), file = reportCon, append = TRUE)
  cat(paste0("      ",Admin2Diff$state,"\n"), file = reportCon, append = TRUE)
 }
cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)

#Check if records with the same GEO_RECNUM have the same values in vgeo and eqvgeous tables
#Check records with postal code

for (j in 1:nPerils){
  Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
  if (length(Tables_Required)!=0) {
    
    ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
    
    vgeo_Postal_dif = data.table(sqlQuery(dbHandle,paste0("SELECT vgeo.GEO_RECNUM, ", ppvgeocc,".GEO_RECNUM, vgeo.POSTALCODE,", ppvgeocc,".POSTALCODE,vgeo.Admin1Code,", ppvgeocc,".STATE,vgeo.Admin2Code,", ppvgeocc,".COUNTYNUM
                                      FROM vgeo 
                                      INNER JOIN ", ppvgeocc," ON vgeo.country=",dummyname," and vgeo.GEO_RECNUM = ", ppvgeocc,".GEO_RECNUM and (vgeo.POSTALCODE!=", ppvgeocc,".POSTALCODE and (vgeo.POSTALCODE IS NOT NULL and ", ppvgeocc,".POSTALCODE is NOT NULL))")))
    
    nvgeo_Postal_dif=nrow(vgeo_Postal_dif)
    if (nvgeo_Postal_dif!=0) {
      cat(paste0("\n","      ","Number of rows with unmatched postal codes =",nvgeo_Postal_dif,"\n"), file = reportCon, append = TRUE)
    }
    cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)
    
    # Check records without postal code with unmatched state or district code
    vgeo_NoPostal_dif = data.table(sqlQuery(dbHandle,paste0("SELECT vgeo.GEO_RECNUM, ", ppvgeocc,".GEO_RECNUM, vgeo.POSTALCODE,", ppvgeocc,".POSTALCODE,vgeo.Admin1Code,", ppvgeocc,".STATE,vgeo.Admin2Code,", ppvgeocc,".COUNTYNUM
                                      FROM vgeo 
                                      INNER JOIN ", ppvgeocc," ON vgeo.country=",dummyname," and vgeo.GEO_RECNUM = ", ppvgeocc,".GEO_RECNUM and (vgeo.POSTALCODE IS NULL and ", ppvgeocc,".POSTALCODE is NULL) and (vgeo.Admin1Code!=", ppvgeocc,".STATE or vgeo.Admin2Code!=", ppvgeocc,".COUNTYNUM)")))
    
    nvgeo_NoPostal_dif=nrow(vgeo_NoPostal_dif)
    if (nvgeo_NoPostal_dif!=0) {
      cat(paste0("\n","      ","Number of rows with unmatched state or district fields =",nvgeo_NoPostal_dif,"\n"), file = reportCon, append = TRUE)
    }
    
    if (nvgeo_Postal_dif==0 & nvgeo_NoPostal_dif==0) {
      cat(paste0("\n","      ","PASSED! ALL RECORDS WITH THE SAME GEORECNUM MATCHED BETWEEN TWO TABLES!"), file = reportCon, append = TRUE)   
    }
    
  }
}
cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)

# Check for the wild card at the end
wild_card=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM vgeo
  where 
  [country]=",dummyname,"  
      and [Admin1Code] is NULL
      and [Zone1] is NULL
      and [SUB_CRESTA]is NULL
      and [Admin2Code]is NULL
      and [CITY]is NULL
      and [POSTALCODE]is NULL
      and [DC_KEY]!=0
      and [INV_KEY]!=0
      and [CITYCODE]is NULL
      and [Admin3Code]is NULL
      and [LOCNCODE]is NULL
      and [MAX_GEORESOLUTIONCODE]=0
      and [STARTRES]=0
      and [ENDRES]=0
      and [BIZONEBLDG]=0
      and [BIZONELL]=0
      and [Admin1GeoId]=0
      and [Admin2GeoId]=0
      and [Admin3GeoId]=0
      and [PostalCodeGeoId]=0
      and [Zone1GeoId]=0
      and [LocationCodeGeoId]=0")))

if (nrow(wild_card) !=1){
    cat(paste0("      ","VGEO TABLE DOES NOT INCLUDE THE WILD CARD"), file = reportCon, append = TRUE)
} else {
  cat(paste0("      ","PASS!VGEO TABLE INCLUDES THE WILD CARD"), file = reportCon, append = TRUE)
}
cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)








}

}

####Test6-Check cghs and eqcghsus tables:   KEY cghs_ID
Test_6 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables,NGTableExist) {
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-6:TEST CGHS AND PPCGHSCC TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nPerils=length(Perils)
nCountries=length(Countries)

if (NGTableExist){
for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")

cghs_dif = data.table(sqlQuery(dbHandle,paste0("SELECT cghs.HAZ_TYPE, ", ppcghscc,".HAZ_TYPE,cghs.HAZ_SCALE, ", ppcghscc,".HAZ_SCALE, cghs.COVERAGE, ", ppcghscc,".COVERAGE
FROM cghs
     INNER JOIN ", ppcghscc," ON cghs.country=",dummyname," and  ", ppcghscc,".CGHS_ID=cghs.CGHS_ID and 
     (", ppcghscc,".HAZ_TYPE!=(select Map_HazardType.haz_type from Map_HazardType where haz_type_id=cghs.HAZ_TYPE) or
      ", ppcghscc,".HAZ_SCALE!=(select Map_HazardSCALE.haz_SCALE from Map_HazardSCALE where haz_SCALE_id=cghs.HAZ_SCALE)or
      ", ppcghscc,".COVERAGE!=(select Map_COVERAGE.coverage from Map_COVERAGE where COVERAGE_id=cghs.COVERAGE))")))

ncghs_dif=nrow(cghs_dif)
if (ncghs_dif!=0){
cat(paste0("\n","      ","Numberof rows with unmatched values =",ncghs_dif,"\n","\n","\n","\n"), file = reportCon, append = TRUE)
} else {cat(paste0("\n","      ","PASSED! ALL RECORDS WITH THE SAME CGHS_ID MATCHED BETWEEN TWO TABLES!"), file = reportCon, append = TRUE)   }
}
}


# Check if all CVG_GRADEs are between 0 and 4
# for NG table
CVg_Grade_Bound=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM cghs
  where 
  [country]=",dummyname,"  
      and   [CVG_GRADE] not between 0 and 4")))

if (nrow(CVg_Grade_Bound) !=0){
  cat(paste0("\n","      ","CVG_GRADES ARE NOT BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
} else {
  cat(paste0("\n","      ","PASSED!CVG_GRADES ARE BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
}

# Check if all CVG_GRADEs are Either 0 or includes all values 0-4
# for NG table
CVg_Grade_count=data.table(sqlQuery(dbHandle, paste0("select COUNT(distinct CVG_GRADE) from 
(SELECT country,COVERAGE,CVG_GRADE FROM cghs
  where 
  [country]=",dummyname,"   
   group by   country, COVERAGE, [CVG_GRADE]) s")))


if (CVg_Grade_count!=0 & CVg_Grade_count!=5){
  cat(paste0("\n","      ","CVG_GRADES DO NOT INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
} else {
  cat(paste0("\n","      ","PASSED!CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
}




cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)

}
}

# Check if all CVG_GRADEs are between 0 and 4 For RiskLink Tables 

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppcghscc=paste0(Perils[j],"cghs",Countries[i],collapse="")

      CVg_Grade_Bound=data.table(sqlQuery(dbHandle, paste0("SELECT *  FROM ", ppcghscc," 
  where 
   [CVG_GRADE] not between 0 and 4")))
      
      if (nrow(CVg_Grade_Bound) !=0){
        cat(paste0("\n","      ","CVG_GRADES ARE NOT BETWEEN 0 AND 4 in ", ppcghscc,"  TABLE"), file = reportCon, append = TRUE)
      } else {
        cat(paste0("\n","      ","PASSED!CVG_GRADES ARE BETWEEN 0 AND 4 in ", ppcghscc,"  TABLE"), file = reportCon, append = TRUE)
      }
      
      
      # Check if all CVG_GRADEs are Either 0 or includes all values 0-4
      # for NG table
      CVg_Grade_count=data.table(sqlQuery(dbHandle, paste0("select COUNT(distinct CVG_GRADE) from 
(SELECT COVERAGE,CVG_GRADE FROM ", ppcghscc," 
     group by COVERAGE, [CVG_GRADE]) s")))
      
      if (CVg_Grade_count!=0 & CVg_Grade_count!=5){
        cat(paste0("\n","      ","CVG_GRADES DO NOT INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
      } else {
        cat(paste0("\n","      ","PASSED!CVG_GRADES INCLUDE ONLY 0 OR ALL VALUES BETWEEN 0 AND 4 in CGHS TABLE"), file = reportCon, append = TRUE)
      }
      
      
      
      cat(paste0("\n","-----------------------------------------------------------------------------------------------------------------","\n"), file = reportCon, append = TRUE)
      
      
      
      
}
}
}
}

#### Test7- Check Imap and eqimapus tables: KEY is  INV_RECNUM
Test_7 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-7:TEST IMAP AND EQIMAP TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nPerils=length(Perils)
nCountries=length(Countries)


for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")

imap_dif = data.table(sqlQuery(dbHandle,paste0("SELECT imap.INV_RECNUM, ", ppimapcc,".INV_RECNUM
                                                FROM imap
                                                     INNER JOIN ", ppimapcc," ON imap.country=",dummyname," and ", ppimapcc,".INV_RECNUM=imap.INV_RECNUM and 
                               (", ppimapcc,".INV_KEY!=(select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY) or 
                               (", ppimapcc,".INV_KEY is NULL and 
                               (select Map_InvKey.inv_key from Map_InvKey where inv_key_id= imap.INV_KEY)is not NULL) or 
                               ", ppimapcc,".MAPCCLSSIF!=(select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)or
                               (", ppimapcc,".MAPCCLSSIF is NULL and 
                               (select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= imap.MAPCCLSSIF)is not NULL) or
                               ", ppimapcc,".MAPCCTIER1!=(select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1) or 
                               (", ppimapcc,".MAPCCTIER1 is NULL and 
                               (select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= imap.MAPCCTIER1)is not NULL) or 
                               ", ppimapcc,".MAPCCTIER2!=(select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2) or 
                               (", ppimapcc,".MAPCCTIER2 is NULL and 
                               (select Map_MAPCCTIER2.MAPCCTIER2 from Map_MAPCCTIER2 where MAPCCTIER2_id= imap.MAPCCTIER2)is not NULL) or
                               ", ppimapcc,".MAPCCTIER3!=(select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3) or 
                               (", ppimapcc,".MAPCCTIER3 is NULL and 
                               (select Map_MAPCCTIER3.MAPCCTIER3 from Map_MAPCCTIER3 where MAPCCTIER3_id= imap.MAPCCTIER3)is not NULL) or 
                               ", ppimapcc,".INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC) or 
                               (", ppimapcc,".INV_OCC is NULL and 
                               (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC)is not NULL) or
                               ", ppimapcc,".INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC) or 
                               (", ppimapcc,".INV_OCC is NULL and 
                               (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= imap.INV_OCC)is not NULL) or
                               ", ppimapcc,".CV_KEY!=(select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY) or 
                               (", ppimapcc,".CV_KEY is NULL and 
                               (select Map_CvKey.cv_key from Map_CvKey where cv_key_id= imap.CV_KEY)is not NULL) or
                               ", ppimapcc,".BR_TVKEY!=(select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY) or 
                               (", ppimapcc,".BR_TVKEY is NULL and 
                               (select Map_BRTVKey.br_tvkey from Map_BRTVKey where br_tvkey_id= imap.BR_TVKEY)is not NULL) or
                               ", ppimapcc,".BR_DRKEY!=(select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY) or 
                               (", ppimapcc,".BR_DRKEY is NULL and 
                               (select Map_BRDRKey.br_drkey from Map_BRDRKey where br_drkey_id= imap.BR_DRKEY)is not NULL)
                               )
                               ")))

nimap_dif=nrow(imap_dif)
if (nimap_dif!=0){
cat(paste0("Number of rows with unmatched records =",nimap_dif,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL RECORDS WITH THE SAME INV_RECNUM MATCHED BETWEEN TWO TABLES!"), file = reportCon, append = TRUE)  }
}
}
}
}

#### Test8- Check vinv and eqvinvus tables KEy: INV_RECNUM and PDC_NUM and PDC_GROUP
Test_8 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-8:TEST VINV AND PPVINVCC TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)


nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppvinvcc=paste0(Perils[j],"vinv",Countries[i],collapse="")

inv_dif = data.table(sqlQuery(dbHandle,paste0(" SELECT vinv.INV_RECNUM,vinv.PDC_GROUP,vinv.PDC_NUM, ", ppvinvcc,".INV_RECNUM,", ppvinvcc,".PDC_GROUP,", ppvinvcc,".PDC_NUM 
                                         FROM vinv 
                                         INNER JOIN ", ppvinvcc," ON vinv.country=",dummyname," and  (vinv.INV_RECNUM= ", ppvinvcc,".INV_RECNUM and vinv.PDC_GROUP=", ppvinvcc,".PDC_GROUP and vinv.PDC_NUM =", ppvinvcc,".PDC_NUM) 
                                          and ((ROUND(vinv.DEF_INVPCT,0)!=ROUND(", ppvinvcc,".DEF_INVPCT,0) 
                                          or (ROUND(vinv.CT,4)!=ROUND(", ppvinvcc,".CT,4))) 
                                          or (vinv.AVGSTHT!=", ppvinvcc,".AVGSTHT) or (vinv.DNUMSTOR!=", ppvinvcc,".DNUMSTOR))"
                                          )))


ninv_dif=nrow(inv_dif)
if (ninv_dif!=0){
  cat(paste0("Number of rows with unmatched records =",ninv_dif,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL RECORDS WITH THE SAME INV_RECNUM, PDC_GROUP,and PDC_NUM MATCHED BETWEEN TWO TABLES!"), file = reportCon, append = TRUE)  }
}
}
}
}

###TEST-9:TEST VDC0 TABLE
####### TEST vdc0
Test_9 <- function (dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,NGTableExist){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-9:TEST VDC0 TABLE',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)


nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppvdc0cc=paste0(Perils[j],"vdc0",Countries[i],collapse="")
      ppvhazcc=paste0(Perils[j],"vhaz",Countries[i],collapse="")



eqvdc0 = sqlQuery(dbHandle, paste0("select ",ppvhazcc,".DC_KEY,",ppvhazcc,".CGHS_ID,",ppvdc0cc,".HAZPARAMID,",ppvhazcc,".HAZ_SEV,",ppvdc0cc,".DAMAGE_PCT,",ppvdc0cc,".PDC_NUM
from ",ppvdc0cc,"
full outer join ",ppvhazcc," on ",ppvhazcc,".HAZPARAMID=",ppvdc0cc,".HAZPARAMID 
order by PDC_NUM,DC_KEY,HAZPARAMID"))
eqvdc0 = data.table(eqvdc0)
eqvdcD <- eqvdc0[,.(difference = diff(DAMAGE_PCT)),by=c("PDC_NUM","DC_KEY","CGHS_ID")]
neqvdcD=nrow(eqvdcD[difference<0])

if (neqvdcD!=0){
  cat(paste0("Number of damage curves which are not motonically increasing=",nvdcD,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!"), file = reportCon, append = TRUE)  }



}
}
}


if (NGTableExist){
  
  cat(paste0("\n","CHECK NG TABLES: ","\n"), file = reportCon, append = TRUE)

  vdc0 = sqlQuery(dbHandle, "select * From vdc0")
vdc0 = data.table(vdc0)

# Check if all damage curves are monotonically increasing
vdcD <- vdc0[,.(difference = diff(DAMAGE_PCT)),by=c("country","PDC_NUM","dc_key","CGHS_ID")]
nvdcD=nrow(vdcD[difference<0])

if (nvdcD!=0){
  cat(paste0("Number of damage curves which are not motonically increasing=",nvdcD,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!"), file = reportCon, append = TRUE)  }


# Check if the x-axis on damage curves are motonically increasing
vdcDHaz <- vdc0[,.(difference=diff(HAZ_SEV)),by=c("country","PDC_NUM","dc_key","CGHS_ID")]

nvdcDHaz=nrow(vdcDHaz[difference<0])


if (nvdcDHaz!=0){
  cat(paste0("Number of damage curves in which x-axis is not motonically increasing= ",nvdcDHaz,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! X-AXES ON ALL VDC0 CURVES ARE MONOTONICALLY INCREASING!","\n"), file = reportCon, append = TRUE)  }


# Check if curves with the same CGHS_ID have the same number or records.

Frequency=data.table(sqlQuery(dbHandle,"  
SELECT country,DC_KEY, PDC_NUM, CGHS_ID, COUNT(*) as Freq
FROM vdc0 
GROUP BY  country, DC_KEY, PDC_NUM, CGHS_ID 
"))
                     
Freq_Diff=Frequency[,.(difference=diff(Freq)),by=c("country","CGHS_ID")]
nFreq_Diff=nrow(Freq_Diff[difference!=0])

if (nFreq_Diff!=0){
  cat(paste0("Number of damage curves with the same CGHS-ID but different number of records= ",nFreq_Diff,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL CURVES WITH THE SAME CGHS-ID HAVE THE SAME NUMBER OF RECORDS!"), file = reportCon, append = TRUE)  }

}
}

####Test-10: Test vcc and eqvccus tables
Test_10 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-10:TEST VCC AND PPVCCCC TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppvcccc=paste0(Perils[j],"vcc",Countries[i],collapse="")
      


vcc_dif = data.table(sqlQuery(dbHandle,paste0(" SELECT vcc.ConstructionID, ", ppvcccc,".C_CLASSIF,", ppvcccc,".C_CLASS
                                          FROM ", ppvcccc,"
                                               INNER JOIN vcc ON vcc.country=",dummyname," and 
                                               (vcc.ConstructionID=(select distinct Map_ConstructionNew.ConstructionID from Map_ConstructionNew where ConstructionCode= ", ppvcccc,".C_CLASS and 
                                               ConstructionScheme=", ppvcccc,".C_CLASSIF and CountryRMSCode=vcc.country) and 
                                               ((", ppvcccc,".MAPCCTIER1!=(select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= vcc.MAPCCTIER1) or 
                                               (", ppvcccc,".MAPCCTIER1 is NULL and (select Map_MAPCCTier1.mapcctier1 from Map_MAPCCTier1 where mapcctier1_id= vcc.MAPCCTIER1)is not NULL))or 
                                               (", ppvcccc,".MAPCCTIER2!=(select Map_MAPCCTier2.mapcctier2 from Map_MAPCCTier2 where mapcctier2_id= vcc.MAPCCTIER2) or 
                                               (", ppvcccc,".MAPCCTIER2 is NULL and (select Map_MAPCCTier2.mapcctier2 from Map_MAPCCTier2 where mapcctier2_id= vcc.MAPCCTIER2)is not NULL))or 
                                               (", ppvcccc,".MAPCCTIER3!=(select Map_MAPCCTier3.mapcctier3 from Map_MAPCCTier3 where mapcctier3_id= vcc.MAPCCTIER3) or 
                                               (", ppvcccc,".MAPCCTIER3 is NULL and (select Map_MAPCCTier3.mapcctier3 from Map_MAPCCTier3 where mapcctier3_id= vcc.MAPCCTIER3)is not NULL))or 
                                               (", ppvcccc,".MAPCCLSSIF!=(select Map_MAPCCLSSIF.mapcclssif from Map_MAPCCLSSIF where mapcclssif_id= vcc.MAPCCLSSIF))))
                              ")))

nvcc_dif=nrow(vcc_dif)

if (nvcc_dif!=0){
  cat(paste0("Number of unmatched records= ",nvcc_dif,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }
}
}
}
}

####Test-11: Test vocc and eqvoccus tables
Test_11 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-11:TEST VOCC AND PPVOCCCC TABLES',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nPerils=length(Perils)
nCountries=length(Countries)

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
  for (j in 1:nPerils){
    Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
    if (length(Tables_Required)!=0) {
      dummyname=paste0("'",Countries[i],"'",collapse="")
      ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")


vocc_dif = data.table(sqlQuery(dbHandle,paste0(" SELECT vocc.OccupancyID, ", ppvocccc,".O_CLASSIF,", ppvocccc,".O_CLASS
FROM ", ppvocccc,"
     INNER JOIN vocc ON vocc.country=",dummyname," and  
     (vocc.OccupancyID=(select Map_OccupancyNew.OccupancyID from Map_OccupancyNew where OccupancyCode= ", ppvocccc,".O_CLASS and 
     OccupancyScheme=", ppvocccc,".O_CLASSIF and CountryRMSCode=vocc.country) and 
     ((vocc.WC_OCC!=", ppvocccc,".WC_OCC) or (vocc.BI_OCC!=", ppvocccc,".BI_OCC) or
     (", ppvocccc,".AGGHAZ_OCC!=(select Map_AggHazOcc.AggHazOcc from Map_AggHazOcc where AggHazOccID= vocc.AggHazOccId) or 
     (", ppvocccc,".AGGHAZ_OCC is NULL and (select Map_AggHazOcc.AggHazOcc from Map_AggHazOcc where AggHazOccID= vocc.AggHazOccId)is not NULL))or 
     (", ppvocccc,".ESDB_OCC!=(select Map_ESDBOcc.esdb_occ from Map_ESDBOcc where esdb_occ_id= vocc.ESDB_OCC) or 
     (", ppvocccc,".ESDB_OCC is NULL and (select Map_ESDBOcc.esdb_occ from Map_ESDBOcc where esdb_occ_id= vocc.ESDB_OCC)is not NULL))or      
     (", ppvocccc,".INV_OCC!=(select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= vocc.INV_OCC) or 
     (", ppvocccc,".INV_OCC is NULL and (select Map_InvOcc.inv_occ from Map_InvOcc where inv_occ_id= vocc.INV_OCC)is not NULL))or 
     (", ppvocccc,".FFEQ_OCC!=(select Map_FFEQOcc.ffeq_occ from Map_FFEQOcc where ffeq_occ_id= vocc.FFEQ_OCC) or 
     (", ppvocccc,".FFEQ_OCC is NULL and (select Map_FFEQOcc.ffeq_occ from Map_FFEQOcc where ffeq_occ_id= vocc.FFEQ_OCC)is not NULL))))

                              ")))

nvocc_dif=nrow(vocc_dif)

if (nvocc_dif!=0){
  cat(paste0("Number of unmatched records= ",nvocc_dif,"\n"), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }
}
}
}
}

####Test-12:TEST IMAP AND VINV
Test_12 <- function (dbHandle,reportCon,Countries){
cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
cat(paste0('TEST-12:TEST EXISTENCE OF PDC_NUM IN VINV IF THE SAME MODIF_PDC EXISTS IN IMAP FOR A GIVEN INV_RECNUM',"\n"), file = reportCon, append = TRUE)
cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

nCountries=length(Countries)

for (i in 1:nCountries)
{
  cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)

      dummyname=paste0("'",Countries[i],"'",collapse="")

      
PDC_NUM_Diff = data.table(sqlQuery(dbHandle,paste0("select imap.INV_RECNUM, imap.ModifPDC  from imap 
                                          inner join (  SELECT  imap.INV_RECNUM as rec, imap.ModifPDC as modif, imap.country as country
                                                        FROM imap
                                                          	inner JOIN vinv ON imap.INV_RECNUM=vinv.INV_RECNUM and imap.ModifPDC!=vinv.PDC_NUM
                                                        		and  imap.ModifPDC!=0 and vinv.INV_RECNUM is not null ) s
                                                        		on imap.country=",dummyname," and s.country=",dummyname," and imap.INV_RECNUM=s.rec and imap.ModifPDC!=s.modif
                                                                                   ")))

nPDC_NUM_Diff=nrow(PDC_NUM_Diff)

if (nPDC_NUM_Diff!=0){
  cat(paste0("\n","      ","Number of unmatched records= ",nPDC_NUM_Diff), file = reportCon, append = TRUE)
} else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }

}
}

####Test-13:CASE SENSITIVITY
Test_13 <- function (dbHandle,reportCon){
  cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  cat(paste0('TEST-13:TEST FOR CASE SENSITIVITY',"\n"), file = reportCon, append = TRUE)
  cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)

  
  Map_InvOcc_Sensitivity_diff=CaseCheck('Map_InvOcc','inv_occ')
  nMap_InvOcc_Sensitivity_diff=nrow(Map_InvOcc_Sensitivity_diff)
    
  if (nMap_InvOcc_Sensitivity_diff!=0){
    cat(paste0("\n","      ","Number of records with unmatched cases in nMap_InvOcc= ",nMap_InvOcc_Sensitivity_diff), file = reportCon, append = TRUE)
  }  
  
  
  Map_InvKey_Sensitivity_diff=CaseCheck('Map_InvKey','inv_key')
  nMap_InvKey_Sensitivity_diff=nrow(Map_InvKey_Sensitivity_diff)
  
  if (nMap_InvKey_Sensitivity_diff!=0){
    cat(paste0("\n","      ","Number of records with unmatched cases in nMap_InvKey= ",nMap_InvKey_Sensitivity_diff), file = reportCon, append = TRUE)
  }  
  
    if (nMap_InvKey_Sensitivity_diff==0 & nMap_InvOcc_Sensitivity_diff==0 ){
      cat(paste0("\n","      ","PASSED! NO CASE SENSITIVITY PROBLEM IS FOUND!"), file = reportCon, append = TRUE)  }
    }

####Test-14: CONSISTENCY OF DATA BETWEEN VCC AND IMAP TABLES (KEY IS COMBINATION OF MAPCLASSIF, TIER 1, TIER 2, AND TIER 3)
Test_14 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
  cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  cat(paste0('TEST-14:CONSISTENCY OF DATA BETWEEN VCC AND IMAP TABLES',"\n"), file = reportCon, append = TRUE)
  cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      if (length(Tables_Required)!=0) {
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvcccc=paste0(Perils[j],"vcc",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
    
        
        
        vcc_imap_dif = data.table(sqlQuery(dbHandle,paste0("   select CC_RECNUM, MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppvcccc,"
  where not exists ( 
  select MAPCCLSSIF, MAPCCTIER1, MAPCCTIER2, MAPCCTIER3 from ",ppimapcc," 
  where 
  (",ppvcccc,".MAPCCLSSIF=",ppimapcc," .MAPCCLSSIF or (",ppvcccc,".MAPCCLSSIF is null and ",ppimapcc," .MAPCCLSSIF is null)) and
  (",ppvcccc,".MAPCCTIER1=",ppimapcc," .MAPCCTIER1 or (",ppvcccc,".MAPCCTIER1 is null and ",ppimapcc," .MAPCCTIER1 is null)) and
  (",ppvcccc,".MAPCCTIER2=",ppimapcc," .MAPCCTIER2 or (",ppvcccc,".MAPCCTIER2 is null and ",ppimapcc," .MAPCCTIER2 is null)) and 
  (",ppvcccc,".MAPCCTIER3=",ppimapcc," .MAPCCTIER3 or (",ppvcccc,".MAPCCTIER3 is null and ",ppimapcc," .MAPCCTIER3 is null)))
  
   ")))
        
        nvcc_imap_dif=nrow(vcc_imap_dif)
        
        if (nvcc_imap_dif!=0){
          cat(paste0("Number of unmatched records= ",nvcc_imap_dif,"\n"), file = reportCon, append = TRUE)
          cat(paste0("      ","Differece(s) between the vcc and imap include following CC_RECNUM(s):","\n"), file = reportCon, append = TRUE)
          cat(paste0("      ",vcc_imap_dif$CC_RECNUM), file = reportCon, append = TRUE)
          
        } else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }
      }
    }
  }
}  
  
####Test-15: CONSISTENCY OF DATA BETWEEN VOCC AND IMAP TABLES (KEY IS INV_VOCC)
Test_15 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
  cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  cat(paste0('TEST-15:CONSISTENCY OF DATA BETWEEN VCC AND IMAP TABLES',"\n"), file = reportCon, append = TRUE)
  cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      if (length(Tables_Required)!=0) {
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvocccc=paste0(Perils[j],"vocc",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        vocc_imap_dif = data.table(sqlQuery(dbHandle,paste0("    select distinct(INV_OCC) from ",ppvocccc,"  a
                                                                where 
                                                                not exists (select INV_OCC from ",ppimapcc,"  b
                                                                where a.INV_OCC=b.INV_OCC) ")))
        
        nvocc_imap_dif=nrow(vocc_imap_dif)
        
        if (nvocc_imap_dif!=0){
          cat(paste0("Number of unmatched records= ",nvocc_imap_dif,"\n"), file = reportCon, append = TRUE)
          cat(paste0("      ","Differece(s) between the vcc and imap include following INV_OCC(s):","\n"), file = reportCon, append = TRUE)
          cat(paste0("      ",vocc_imap_dif$INV_OCC), file = reportCon, append = TRUE)
          
        } else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }
      }
    }
  }
}  

####Test-16: CONSISTENCY OF DATA BETWEEN VGEO AND IMAP TABLES (KEY IS INV_KEY)
Test_16 <- function (dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables){
  cat(paste0("\n","\n","\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  cat(paste0('TEST-16:CONSISTENCY OF DATA BETWEEN VGEO AND IMAP TABLES',"\n"), file = reportCon, append = TRUE)
  cat(paste0("\n","#################################################################################################################","\n","\n"), file = reportCon, append = TRUE)
  
  nPerils=length(Perils)
  nCountries=length(Countries)
  
  for (i in 1:nCountries)
  {
    cat(paste0("\n","\n",toupper(Countries[i]),":","\n"), file = reportCon, append = TRUE)
    for (j in 1:nPerils){
      Tables_Required<- VulnDb_ExpectedTables[Country==Countries[i] & Peril==Perils[j]]$Table
      if (length(Tables_Required)!=0) {
        dummyname=paste0("'",Countries[i],"'",collapse="")
        ppvgeocc=paste0(Perils[j],"vgeo",Countries[i],collapse="")
        ppimapcc=paste0(Perils[j],"imap",Countries[i],collapse="")
        
        
        
        
        vgeo_imap_dif = data.table(sqlQuery(dbHandle,paste0("       SELECT
                                                                       T1.INV_KEY
                                                                    FROM
                                                                       (SELECT DISTINCT INV_KEY FROM ",ppvgeocc," ) T1
                                                                       left JOIN
                                                                       (SELECT DISTINCT INV_KEY FROM ",ppimapcc," ) T2
                                                                                  ON T1.INV_KEY = T2.INV_KEY where T2.INV_KEY is null  ")))
        
        nvgeo_imap_dif=nrow(vgeo_imap_dif)
        
        if (nvgeo_imap_dif!=0){
          cat(paste0("Number of unmatched records= ",nvgeo_imap_dif,"\n"), file = reportCon, append = TRUE)
          cat(paste0("      ","Differece(s) between the vgeo and imap include following INV_KEY(s):","\n"), file = reportCon, append = TRUE)
          cat(paste0("      ",vgeo_imap_dif$INV_KEY), file = reportCon, append = TRUE)
          
        } else { cat(paste0("\n","      ","PASSED! ALL RECORDS MATCHED!"), file = reportCon, append = TRUE)  }
      }
    }
  }
}  


#############Main Code#############

cat("Running TEST-0: DATABASE INFORMATION!","\n")
Test_0Out=Test_0(dbHandle,reportCon)
    Perils=Test_0Out$Peril
    Countries=Test_0Out$Country
    RiskLinkTableExist=Test_0Out$RLTableExtst
    NGTableExist=Test_0Out$NGTableExist

if (RiskLinkTableExist){
cat("Running TEST-1: TABLES AVAILABILITY!","\n")
Test_1(dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,listofNGtables, NGTableExist)

cat("Running TEST-2: EMPTY TABLES!","\n")
Test_2(dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,listofNGtables, NGTableExist)

cat("Running TEST-3: RISK LINK TABLES WITHOUT INDEX!","\n")
Test_3(dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables)


if (NGTableExist){
cat("Running TEST-4: COMPARISON OF NUMBER OF ROWS IN CORRESPONDING TABLES","\n")
Test_4(dbHandle,reportCon,Perils,Countries,listofNGtables)

cat("Running TEST-5:TEST VGEO AND PPVGEOCC TABLES!","\n")
Test_5(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)
}

cat("Running TEST6-CHECK CGHS AND EQCGHSUS TABLES!","\n")
Test_6(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables,NGTableExist)

if (NGTableExist){
cat("Running TEST7- CHECK IMAP AND EQIMAPUS TABLES!","\n")
Test_7(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

cat("Running TEST8- CHECK VINV AND EQVINVUS TABLES KEY: INV_RECNUM AND PDC_NUM AND PDC_GROUP!","\n")
Test_8(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

}
cat("Running TEST-9:TEST VDC0 TABLE!","\n")
Test_9(dbHandle,reportCon,Perils,Countries,tables,VulnDb_ExpectedTables,NGTableExist)
if (NGTableExist){
cat("Running TEST-10:TEST VCC AND EQVCCUS TABLES!","\n")
Test_10(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

cat("Running TEST-11:TEST VOCC AND EQVOCCUS TABLES!","\n")
Test_11(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

cat("Running TEST-12: IMAP AND VINV!","\n")
Test_12(dbHandle,reportCon,Countries)

cat("Running TEST-13:CASE SENSITIVITY")
Test_13(dbHandle,reportCon)
}
cat("Running TEST-14:CONSISTENCY OF DATA BETWEEN VCC AND IMAP TABLES")
Test_14(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

cat("Running Test-15: CONSISTENCY OF DATA BETWEEN VOCC AND IMAP TABLES (KEY IS INV_VOCC)")
Test_15(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)

cat("Running Test-16: CONSISTENCY OF DATA BETWEEN VGEO AND IMAP TABLES (KEY IS INV_KEY)")
Test_16(dbHandle,reportCon,Perils,Countries,VulnDb_ExpectedTables)
}





##############END#################

d=Sys.time()

cat(d-c)

odbcClose(dbHandle)
closeAllConnections() # it closes the connection to the file so it writes on the console.
